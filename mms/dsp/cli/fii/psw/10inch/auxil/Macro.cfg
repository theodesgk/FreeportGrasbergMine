#!/psw/cpp
/*
 * * * * * * * * * * * * * * * * * * *
 *  DISPATCH Real-Time Firmware Module
 * Copyright (c) Modular Mining Systems, 1982-2011
 *               All Rights Reserved
 *  $RCSfile: Macro.cfg,v $
 * $Revision: 1.25 $
 *   $Author: mlins $
 *     $Date: 2020/01/20 21:19:57 $
 *    $State: Exp $
 * * * * * * * * * * * * * * * * * * *
 */

/* RPC Macros */
symbol	numSplits
macro	doKmatl		matl.$2 $1;numSplits $(nil);\
			PublishOperatorMaterial;

/* Actions */
symbol	chngloc		n
symbol	trkload		n
#ifdef GPSTAGACT
#if DEMAJOR >= 6 && ((DEMINOR >= 6 && DEMAINT >= 8) || DEMINOR >= 7)
macro	doActFull	FULL "$(matl)" "$(matl.$(matl))" [\"$(Time epoch)\"] [ "$(GpsTruck x)" "$(GpsTruck y)" "$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
#endif
#else
#if DEMAJOR >= 6 && DEMINOR >= 6 && DEMAINT >= 3
macro	doActFull	FULL "$(matl)" "$(matl.$(matl))" [\"$(Time epoch)\"]
#else
macro	doActFull	FULL "$(matl)" "$(matl.$(matl))"
#endif
#endif
macro	exChngLoc	EQ-REQ "setloc" [ "$1" ]
macro	exTrkLoad	EQ-REQ "strkld" [ "$1" ]
macro	doChngLoc	eq? "$(chngloc)" "n" NotAvailable;ne? "$(chngloc)" "n" PostLocs "exChngLoc"
macro	doTrkLoad	eq? "$(trkload)" "n" NotAvailable;ne? "$(trkload)" "n" PostDynamicMenu "Trucks" "exTrkLoad"
macro	doTrammode	EQ-REQ "trammode"

/* Load Side */
symbol	loadside	0
symbol	loadsidetemp
symbol	loadsidelk	1
macro	showLoadSide	loadsidetemp $(loadside);eq? $(loadsidelk) 0 loadsidelk:1;showLock;\
	eq? $(loadside) 0 showNone;eq? $(loadside) 1 showLeft;eq? $(loadside) 2 showRight;eq? $(loadside) 3 showBoth
macro	showNone	LoadSide.Left colors:default;LoadSide.Right colors:default;LoadSide.Both colors:default
macro	showLeft	LoadSide.Left colors:Pass;LoadSide.Right colors:default;LoadSide.Both colors:default
macro	showRight	LoadSide.Left colors:default;LoadSide.Right colors:Pass;LoadSide.Both colors:default
macro	showBoth	LoadSide.Left colors:default;LoadSide.Right colors:default;LoadSide.Both colors:Pass
macro	showLock	eq? $(loadsidelk) 0 LoadSide.Lock colors:default;eq? $(loadsidelk) 1 LoadSide.Lock colors:Pass
macro	doClearSides	loadside 0;loadsidelk 0;showNone;showLock
macro	doLeftSide	loadside 1;showLeft
macro	doRightSide	loadside 2;showRight
macro	doBothSides	loadside 3;showBoth
macro	doToggleLock	ne? $(loadside) 0 loadsidelk:$(- 1 $(loadsidelk));showLock
macro	doSetSide	EQ-REQ "loadside" [ "$(loadside)" "$(loadsidelk)" ]
macro	doSelLoadSide	PostWindow "LoadSide" MENU_LAYER

/* KSTATE macros */
symbol	ksargs	6

/* Material Menu */
in	SendMaterial	INT_RPC	s	EQ-REQ "matl" [ "$1" "$(matl)" ]
macro	MaterialAction	SendMaterial "$1"
macro	doMatl		PostDynamicMenu "Material" "MaterialAction"

/* Split Menu */
symbol	matl		0
symbol	matl.0		$(NoneLbl)
symbol	matl.1		$(NoneLbl)
symbol	matl.2		$(NoneLbl)
symbol	matl.3		$(NoneLbl)
symbol	matl.4		$(NoneLbl)
symbol	matl.5		$(NoneLbl)
symbol	matl.6		$(NoneLbl)
symbol	matl.7		$(NoneLbl)
symbol	matl.8		$(NoneLbl)
symbol	matl.9		$(NoneLbl)
symbol	matl.10		$(NoneLbl)
symbol	stemp
/* these symbols are set by central */
symbol	maxsplit	2
symbol	sendsplit	n
in	SetSplit	INT_RPC	d	matl $1;ne? "$(sendsplit)" "n" SendMaterial "$(matl.$(matl))"
macro	AddSplit	ne? $(min $1 $(maxsplit)) $(maxsplit) Split item:"'$(stemp)$(matl.$1)$(stemp)' 'SetSplit $1'";stemp "$(stemp)\""
macro	RebuildSplits	numSplits $(maxsplit);Split items;stemp "\"";For $(maxsplit) AddSplit;Split item:"'$(exitstr)' 'Split unpost'";Split itemColor:"$(exitstr)":Exit
macro	NoSplit		SetSplit $(matl)
macro	TwoSplit	SetSplit $(- 1 $(matl));
macro	MultiSplit	ne? "$(maxsplit)" "$(numSplits)" RebuildSplits;Split post
macro	doSplits	eq? $(max 1 $(maxsplit)) 1 NoSplit;eq? $(maxsplit) 2 TwoSplit;ne? $(max 2 $(maxsplit)) 2 MultiSplit

/* Production Cycle Icon control */
symbol	icon.7	 waiting
symbol	icon.3	 standby
symbol	icon.8	 loading
symbol  icon.9   full
symbol	icon.13  waiting
symbol	anim.13	y
symbol	icon.16	 tramloading
symbol  icon.21  down
symbol	anim.21	n
symbol  icon.22  standby
symbol	anim.22	n
symbol  icon.23  delay
symbol	anim.23	n
symbol  icon.24  tiedown
symbol	anim.24	n
symbol  icon.25  ready
symbol	anim.25	n
macro   rpc.7    doActFull
macro   rpc.21   doShvReady
macro   rpc.22   doShvReady
macro   rpc.23   doShvReady
macro   rpc.24   doShvReady
macro   rpc.25   doActFull

/* Production Info View */
macro	doPrdInfoUpdate	EQ-REQ "infoUpdate"
/* The number of seconds until wInfo automatically updates: */
symbol  winfoupdateint  180   
macro	UpdateProdInfo	doPrdInfoUpdate;eq? "$(curWindow)" "wInfo" WinMgr after:$(winfoupdateint):UpdateProdInfo
macro	doPrdInfoWindow	SetWindow "wInfo";SET-VALUES wInfo.lbl 0 0 [ $(ProdInfoHeader) ];UpdateProdInfo

symbol	setAction
symbol	startFrom
symbol	targetObject
/* Set labels, symbols, etc to values contained
 * in the incoming vector. Target objects must be
 * sequentially named (eg w0.button0, w0.button1, etc )
 * $1 = Object base name	(eg w0.button)
 * $2 = Object type (label, symbol)
 * $3 = Numeric start point (eg if want to label button10 through button20)
 * $4 = vector of string values (eg "Test Label", "Change Hole", etc )
 */
in	SET-VALUES	0xc7	sbb[s]	targetObject $1;\
	startFrom $3;\
	eq? $2 0 setAction SetLabels2;\
	eq? $2 1 setAction SetSymbols;\
	foreach $4;do TrapLeftBracket
/*
 * Check the current vector parameter's value and make sure that it isn't
 * the enclosing bracket. This operation is required when the vector has
 * been saved as a string for future use
 */
macro	TrapLeftBracket	ne? "$2" "[" TrapRightBracket

/*
 * See comments RE TrapLeftBracket
 */
macro	TrapRightBracket	ne? "$2" "]" $(setAction)

/*
 * Turn on hidden Label objects and set the text display values to the
 * current vector parameter's value
 */ 
macro	SetLabels	$(targetObject)$(+ $(offset) $1 $(startFrom)) label:"$2" map:y
symbol 	offset
macro	SetLabels2	offset $1;\
			foreach $2;do SetLabels
/*
 * Set the value of a symbol based on the current vector parameter's value
 */
macro	SetSymbols	$(targetObject)$(+ $1 $(startFrom)) "$2"
/* End Production Info View Code */

/* Remaning bucket beep */
symbol	operRemBktBeep	1
symbol	shouldRemBktBeepOn	1
macro	TriggerRemBktBeep	KBEEP 1
macro	turnRemBktBeepOff	operRemBktBeep 0;\
				shouldRemBktBeepOn	0;\
				postTrans $(RemBktBeepOFF)
macro	turnRemBktBeepOn	operRemBktBeep 1;\
				postTrans $(RemBktBeepON)
macro	setRemBktBeep	eq? $(operRemBktBeep) 1 turnRemBktBeepOff;\
			eq? $(shouldRemBktBeepOn) 1 turnRemBktBeepOn;\
			shouldRemBktBeepOn	1
macro	RemBktBeep	eq? $(operRemBktBeep) 1 TriggerRemBktBeep

macro InitFonts	w0.CurAct font:CurActFont; w0.InfAct font:CurActFont; w0.ExpTime font:ExpTimeFont

macro	ClearInfAct	w0.InfAct clear
macro	ClearAllAct	ClearTrans;ClearInfAct

macro 	doKstate3	eq? $(min $1 5) $1 HandleStatInfo;\
			eq? $1 6 HandleBcmInfo;\
			eq? $1 7 HandleSFInfo;\
			eq? $1 8 HandleSFInfo;\
			eq? $1 13 HandleLoadInfo

macro	HandleKstate	eq? $(min $(ksargs) 4) 4 HandleNextAct; \
			state $1; \
			ne? $1 8 ClearAllAct;\
			postTrans $5; \
			HandleKsArg$(ksargs); \
			do_kstate_extra; \
			defaultValue $7; \
			ne? "$(defaultValue)" " " HandleExpTime $7; \
			eq? "$(defaultValue)" " " ClearExpTime;\
			CheckPerspective$(tbt_support)

symbol	doOverloadFlash	0

macro	DoNormalLoadColor	w0.InfAct colors:default; eq? $(doOverloadFlash) 1 WinMgr after:1:DoOverloadIndicator
macro	StopOverloadFlash	doOverloadFlash 0; w0.InfAct colors:default
macro	UpdateWarnLoadDisplay	w0.InfAct colors:yellowLabel
macro	DoOverloadIndicator	eq? $(doOverloadFlash) 1 w0.InfAct colors:Down; WinMgr after:1:DoNormalLoadColor
macro	UpdateOverloadDisplay	ne? $(doOverloadFlash) 1 DoOverloadIndicator; doOverloadFlash 1

macro	HandleLoadInfo	ClearInfAct; \
			postTrans $2; \
			w0.InfAct label:"$3"; \
			eq? $4 0 StopOverloadFlash; \
			eq? $4 1 UpdateWarnLoadDisplay; \
			eq? $4 2 UpdateOverloadDisplay; \
			eq? $5 1 RemBktBeep

macro	UpdateExpTime	eq? $(min $(expTime) 0) 0 UpdatePosTime; \
			ne? $(min $(expTime) 0) 0 UpdateNegTime; \
			w0.ExpTime clear;\
			w0.ExpTime write:"$(expTimeLbl):$(/ $(tempTime) 60).$(/ $(% $(tempTime) 60) 6) $(MinutesLbl)";\
			ne? $(expTimeActive) 1 ne? $(max $(expTime) 0) 0 CountExpTime

macro	HandleNextAct	ne? $1 $(state) IconInit; \
			ne? $1 $(state) StopOverloadFlash; \
			w0.CurAct label:$2; \
			w0.NextAct label:$3
#define	MOBILEAPI_FILE	<10inch/excav/MobileApiMacro.cfg>
#include MOBILEAPI_FILE

#define	LANG_FILE	<10inch/excav/LANGUAGE/Macro.cfg>
#include LANG_FILE
