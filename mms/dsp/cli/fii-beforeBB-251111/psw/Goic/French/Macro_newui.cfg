#!/psw/cpp
/*
 *
 *
 *
 */

#include <Goic/English/Macro_KpGen.cfg>

#if !#option(StoreForward)
#include <StoreForward/Goic/Macro_mineinfo.cfg>
out	GPS-ARRIVE	0x01a6  ddd?dd  last_beacon $1;WinMgr after:1:HandleBcnArr;WinMgr after:2:NuCheckLoc;sendto up 
out	RFID-ARRIVE	0x0601  dd      last_beacon $2;WinMgr after:1:HandleBcnArr;WinMgr after:2:NuCheckLoc;sendto up
symbol	last_beacon
symbol	loc_unit
symbol	commstat yes
macro	HandleSFInfo	kstate3_recv 1
#else
out	GPS-ARRIVE	0x01a6  ddd?dd  last_beacon $1;WinMgr after:1:HandleBcnArr;WinMgr after:2:NuCheckLoc;sendto up spooled
out	RFID-ARRIVE	0x0601  dd      last_beacon $2;WinMgr after:1:HandleBcnArr;WinMgr after:2:NuCheckLoc;sendto up spooled
#endif

/* Only State info supported for KSTATE3 in 7" NEWUI */
in	KSTATE3	0x33	b?ssssss	eq? $(min $1 5) $1 HandleStatInfo;eq? $1 7 HandleSFInfo;eq? $1 8 HandleSFInfo
macro	HandleStatInfo	curr_stat $1;curr_rsn $2;SetStat;curr_oper $3;SetOperBtn;curr_rcode $4;curr_loc $5;Handleks3arg6;Handleks3arg7;SetCurrLoc
#macro	SetStat		w0.Status colors:$(stat$(curr_stat)_color);w0.Icon colors:$(stat$(curr_stat)_color);w0.v7 label:'$(stat$(curr_stat))\\n$(curr_rsn)'
macro	SetStat		eq? $(curr_stat) 1 ShowDown;eq? $(curr_stat) 2 SetRdyColors;eq? $(curr_stat) 3 ShowStandby;eq? $(curr_stat) 4 ShowDelay;eq? $(curr_stat) 5 ShowTiedown
macro	SetOperBtn	eq? "$(curr_oper)" "-1" Set4Logon;ne? "$(curr_oper)" "-1" Set4Logoff
macro	Set4Logon	w0.v7 label:"";w0.DeskBtn1 label:$(msg.logon) action:kpLogOn
macro	Set4Logoff	w0.v7 label:'$(curr_oper)';w0.DeskBtn1 label:$(msg.logoff) action:VerifyLogoff
macro	VerifyLogoff	Ok label:$(msg.vrfylog) action:kpLogOff post
macro	SetCurrLoc	last_beacon $(curr_loc);ne? $(curr_loc) -1 WinMgr after:1:HandleBcnArr;WinMgr after:2:NuSetView

macro Init	Macro KSTATE:0;GetTime1;FixMenuBars
macro NU_rpc_extra	kstate_extra $(kstate_extra) NU
macro NU.kstate_extra	WinMgr after:3:NuSetView

symbol	last_screen	trans
symbol	logon_state	0
symbol	prev_state	0
symbol	fview_on	0
symbol	curr_stat
symbol	curr_rsn
symbol	curr_oper
symbol	curr_rcode
symbol	curr_loc
symbol	stat1_color	Down
symbol	stat2_color	Ready
symbol	stat3_color	Standby
symbol	stat4_color	Delay
symbol	stat5_color	Tiedown
symbol	start_trans	1
symbol	end_trans	1

/* there is a bug in the menu bars  in that setting map initially to no
 * in the cfg file does not work so we do it manually 
 */
macro	FixMenuBars	w0.mb map:n;Options map:n
macro	MenuBarCheck	eq? $(fview_on) 0 FixMenuBars
macro	ShowTime	CfgTime $(Time format:'%e/%h/%Y\\n%l:%M %p' time:now get)

/* icon.7 gets redefined for shovels in standard boot code but for new ui we don't want to */
#if #class(excav) | #class(shovel) | #class(loader) | #class(loaderlp) | #class(ug_loader) | #class(lhd)
symbol  icon.7   waiting
#endif

/* icon transition stuff */
symbol 	StatIconDisplay	n
symbol	video_state	check

macro   video_statuschng        ne? $(state) $(prev_state) w0.Icon icon:$(icon.$(state));\
                                video_state check;\
                                prev_state $(state)

macro   video_status_check      eq? $(state) 0 StatIconDisplay y;\
                                eq? $(state) 1 StatIconDisplay y;\
                                eq? $(state) 3 StatIconDisplay y;\
                                eq? $(state) 4 StatIconDisplay y;\
                                eq? $(StatIconDisplay) y video_statuschng;

macro	video_check	video_status_check;\
			eq? $(StatIconDisplay) n ne? $(state) $(prev_state) video_state trans1;\
			eq? $(StatIconDisplay) n eq? $(state) $(prev_state) w0.Icon icon:$(icon.$(state))_2;\
			MenuBarCheck;\
			StatIconDisplay n;\
			WinMgr after:1:video_$(video_state)
macro	video_trans1	w0.Icon icon:$(icon.$(state))_1;WinMgr after:1:video_trans2
macro	video_trans2	w0.Icon icon:$(icon.$(state))_2;prev_state $(state);video_state check;WinMgr after:1:video_check
macro   novideo WinMgr cancel:video_check;WinMgr cancel:video_trans1;WinMgr cancel:video_trans2

macro	ShowReady	SetRdyColors;w0.Icon icon:ready
#ifdef STATUS_ICON
macro	SetRdyColors	w0.Status icon:RDY_ICON;w0.Icon colors:Ready
macro	ShowDown	w0.Status icon:DWN_ICON;w0.Icon colors:Down icon:down
macro	ShowStandby	w0.Status icon:STB_ICON;w0.Icon colors:Standby icon:standby
macro	ShowDelay	w0.Status icon:DLY_ICON;w0.Icon colors:Delay icon:delay
macro	ShowTiedown	w0.Status icon:TDW_ICON;w0.Icon colors:Tiedown icon:tiedown
#else
macro	SetRdyColors	w0.Status colors:Ready;w0.Icon colors:Ready
macro	ShowDown	w0.Status colors:Down;w0.Icon colors:Down icon:down
macro	ShowStandby	w0.Status colors:Standby;w0.Icon colors:Standby icon:standby
macro	ShowDelay	w0.Status colors:Delay;w0.Icon colors:Delay icon:delay
macro	ShowTiedown	w0.Status colors:Tiedown;w0.Icon colors:Tiedown icon:tiedown
#endif

macro	ToggleLogon	eq? $(logon_state) 0 VerifyLogoff;eq? $(logon_state) 1 kpLogOn

/* used in landscape mode */
macro	ShowTransView	FullViewOff;TransViewOn;last_screen trans;SetScrnBtn
macro	ShowResrcView	FullViewOff;ResrcViewOn;last_screen resrc;SetScrnBtn
/* used in portrait mode */
macro	Switch2TView	FullViewOff;ResrcViewOff;TransViewOn;last_screen trans;SetScrnBtn;HideTBtn;ShowRBtn
macro	Switch2RView	FullViewOff;TransViewOff;ResrcViewOn;last_screen resrc;SetScrnBtn;HideRBtn;ShowTBtn
macro	Switch2TView2	FullViewOff;ResrcViewOff;TransViewOn;last_screen trans;SetScrnBtn;HideTBtn;ShowRBtn
macro	Switch2RView2	FullViewOff;TransViewOff;ResrcViewOn;last_screen resrc;SetScrnBtn;HideRBtn;ShowTBtn

macro	ToggleHalfScreen eq? "$(last_screen)" "trans" ShowTransView;eq? "$(last_screen)" "resrc" ShowResrcView
macro	ToggleFullScreen TransViewOff;ResrcViewOff;FullViewOn;SetHalfBtn
macro	SetScrnBtn	w0.Desktop label:$(msg.FullDsk) action:'ToggleFullScreen'
macro	SetHalfBtn	w0.Desktop label:$(msg.halfscrn) action:'ToggleHalfScreen'
#ifdef TRANS_ICON
macro	TransBtnOn	w0.Tranlbl map:y;w0.Trans map:y;w0.Trantxt map:y
macro	TransBtnOff	w0.Tranlbl map:n;w0.Trans map:n;w0.Trantxt map:n
macro	ShowTBtn	w0.TBtnlbl map:y;w0.TBtn map:y;w0.TBtntxt map:y
macro	HideTBtn	w0.TBtnlbl map:n;w0.TBtn map:n;w0.TBtntxt map:n
#else
macro	TransBtnOn	w0.Trans map:y
macro	TransBtnOff	w0.Trans map:n
macro	ShowTBtn	w0.TBtn map:y
macro	HideTBtn	w0.TBtn map:n
#endif
#ifdef RESRC_ICON
macro	ResrcBtnOn	w0.Rsrclbl map:y;w0.Resrc map:y;w0.Rsrctxt map:y
macro	ResrcBtnOff	w0.Rsrclbl map:n;w0.Resrc map:n;w0.Rsrctxt map:n
macro	ShowRBtn	w0.RBtnlbl map:y;w0.RBtn map:y;w0.RBtntxt map:y
macro	HideRBtn	w0.RBtnlbl map:n;w0.RBtn map:n;w0.RBtntxt map:n
#else
macro	ResrcBtnOn	w0.Resrc map:y
macro	ResrcBtnOff	w0.Resrc map:n
macro	ShowRBtn	w0.RBtn map:y
macro	HideRBtn	w0.RBtn map:n
#endif
#ifdef DESKBTN_ICON
macro	DeskBtnOn	w0.DBtnlbl map:y;w0.DeskBtn1 map:y;w0.DBtntxt map:y
macro	DeskBtnOff	w0.DBtnlbl map:n;w0.DeskBtn1 map:n;w0.DBtntxt map:n
#else
macro	DeskBtnOn	w0.DeskBtn1 map:y
macro	DeskBtnOff	w0.DeskBtn1 map:n
#endif
macro	FullViewOn	fview_on 1;w0.mb map:y;TransBtnOn;ResrcBtnOn;DeskBtnOn;w0.ScrnCntrl map:y;Options map:y
macro	FullViewOff	fview_on 0;w0.mb map:n;TransBtnOff;ResrcBtnOff;DeskBtnOff;w0.ScrnCntrl map:n;Options map:n
macro	TransViewOn	w0.Text map:y;w0.Clear map:y;w0.Recall map:y
macro	TransViewOff	w0.Text map:n;w0.Clear map:n;w0.Recall map:n
macro	ResrcViewOn	SetRView;w0.RView map:y;w0.v4 map:y
macro	ResrcViewOff	w0.RView map:n;w0.v4 map:n
macro	SetRView	w0.RView clear;w0.RView write:"$(msg.rview1)\n$(msg.rview2) $(loc_id)\n$(msg.rview3) $(loc_type)\n$(msg.rview4) $(loc_stat)\n";eq? $(loc_auto) 1 w0.RView write:"$(msg.rview5)\n";eq? $(loc_auto) 0 w0.RView write:"$(msg.rview6)\n"
macro	StatBarRollR	w0.Clock map:n;w0.v3 map:n;w0.v7 map:n;w0.wifi map:y;w0.gps map:y;w0.v1 map:y;w0.v2 map:y
macro	StatBarRollL	w0.wifi map:n;w0.gps map:n;w0.v1 map:n;w0.v2 map:n;w0.Clock map:y;w0.v3 map:y;w0.v7 map:y

/* Display Resource View when arriving at load or dump loc */
macro	NuSetView       eq? $(state) 10 Switch2RView;\
                        eq? $(state) 7 Switch2RView;\
                        eq? $(state) 16 Switch2RView;\
                        ne? $(state) 10 ne? $(state) 7 ne? $(state) 16 Switch2TView;
macro NuCheckLoc	eq? $(commstat) no NuCheckLocType
macro NuCheckLocType	eq? $(loc_unit) 3 Switch2RView;\
                        eq? $(loc_unit) 4 Switch2RView;\
                        eq? $(loc_unit) 5 Switch2RView;\
                        eq? $(loc_unit) 6 Switch2RView;\
                        ne? $(loc_unit) 3 ne? $(loc_unit) 4 ne? $(loc_unit) 5 ne? $(loc_unit) 6 Switch2TView;

/* Misc      */
/* checkYesNoResponse gets changed by common/Macro_utils.cfg for drills
   so we fix it here */
macro checkYesNoResponse eq? $(operResponse) 1 sfdobeep 0;\
                         eq? $(operResponse) 0 sfdobeep 1


/* decided to use standard KSTATEs
in	KSTATE	0x41	b?ssssss	prev_state $(state);state $1;loc $2;next $3;TransitIcon;\
					w0.v1 label:$2;w0.v2 label:$3;w0.v3 label:$4;\
					w0.Text write:$5\n;w0.v4 label:$6;WinMgr audio:$7

in	KSTATE2	0x32	b?ssssss        prev_state $(state);state $1;loc $2;next $3;TransitIcon;\
                                        w0.v1 label:$2;w0.v2 label:$3;w0.v3 label:$4;\
                                        w0.Text write:$5;w0.Text write:\n;w0.v4 label:$6;WinMgr audio:$7

macro	TransitIcon	eq? $(state) 0 ShowLogo;\
			eq? $(state) 1 ShowDown;\
			eq? $(state) 2 ShowReady;\
			eq? $(state) 3 ShowStandby;\
			eq? $(state) 4 ShowDelay;\
			eq? $(state) 5 ShowTiedown;\
			eq? $(state) 6 ShowTravEmpty;\
			eq? $(state) 7 ShowWaiting;\
			eq? $(state) 8 ShowLoading;\
			eq? $(state) 9 ShowTravFull;\
			eq? $(state) 10 ShowDumping;\
			eq? $(state) 11 DoNothing;\
			eq? $(state) 12 DoNothing;\
			eq? $(state) 13 DoNothing;\
			eq? $(state) 14 ShowTravEmpty;\
			eq? $(state) 15 ShowTravEmpty;\
			eq? $(state) 16 ShowLoading;\
			eq? $(state) 17 ShowLoading

macro	ShowLogo	w0.Icon icon:logo
macro	SetIdleIcon	w0.Icon icon:state_1
macro	DoNothing	
macro	StartTrans	w0.Icon icon:state_$(start_trans);WinMgr after:1:NextTrans
macro	NextTrans	w0.Icon icon:state_$(start_trans)_1;WinMgr after:1:FinalTrans
macro	FinalTrans	w0.Icon icon:state_$(end_trans)
macro	ShowTravEmpty	SetRdyColors;start_trans 1;end_trans 2;StartTrans
macro	ShowWaiting	SetRdyColors;start_trans 2;end_trans 3;StartTrans
macro	ShowLoading	SetRdyColors;start_trans 3;end_trans 4;StartTrans
macro	ShowTravFull	SetRdyColors;start_trans 5;end_trans 6;StartTrans
macro	ShowDumping	SetRdyColors;start_trans 6;end_trans 7;StartTrans
*/

#       define OBJECT Macro_newui
#       include <Cfg/Options.cfg>
