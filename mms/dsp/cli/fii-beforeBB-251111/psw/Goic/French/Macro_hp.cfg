%!/psw/cpp

/*
 * Macro and symbol parameters common to all
 * high-precision equipment - NOTE while a lot of macros are somewhat equipment-specific
 * due to changes in screen objects they are all put in this file so that changes to functionality
 * can be applied to all units quickly and without having to go hunting. Please keep it like this
 * for consistency.
 */

/*
 * General-purpose variable
 */
symbol	holder
symbol  GaugTog 0
symbol	allowProjectRequest 1

macro	showHP	ne? $(actwin) hp WinMgr window:hp
macro	showMain	ne? $(actwin) w0 WinMgr window:w0
macro	showScrCfg	ne? $(actwin) wScreen WinMgr window:wScreen

/*
 * Referenced to determine the flashing and
 * colour status of the three available blinking
 * indicators
 *
 * 0 = no data available (colour = statusNone)
 * 1 = status good flashing (colour = statusGood)
 * 2 = status bad flashing (colour = statusBad)
 * 3 = status bad solid (colour = statusBad)
 * 4 = status good solid (colour = statusGood)
 */
symbol	statLast.0 0
symbol	statLast.1 0
symbol 	statLast.2 0
symbol	statVal.0 0
symbol	statVal.1 3

#if #class(shovel) || #class(loader)

symbol	statVal.2 1

#else

symbol	statVal.2 3

#endif

symbol	statVal

macro	StatusLightUpdate	eq? $(statVal.$(statVal)) 0 hp.statusLight$(statVal) blink:0 colors:statusNone;\
				eq? $(statVal.$(statVal)) 1 hp.statusLight$(statVal) blink:10:statusGood:statusNone;\
				eq? $(statVal.$(statVal)) 2 hp.statusLight$(statVal) blink:10:statusBad:statusNone;\
				eq? $(statVal.$(statVal)) 3 hp.statusLight$(statVal) blink:0 colors:statusBad;\
				eq? $(statVal.$(statVal)) 4 hp.statusLight$(statVal) blink:0 colors:statusGood;\
				statLast.$(statVal) $(statVal.$(statVal))


symbol	lastUpdate 0
/*
 * Loop through the 3 status light indicator
 * objects and update thier status if the last
 * value is different to the latest value
 */
macro	CheckStatusIndicators	statVal 0;\
				ne? $(statVal.$(statVal)) $(statLast.$(statVal)) StatusLightUpdate;\
				statVal 1;\
				lastUpdate $(+ $(lastUpdate) 1);\
				eq? $(lastUpdate) 2 statVal.1 3;\
				eq? $(lastUpdate) 2 statVal.1 3;\
				eq? $(lastUpdate) 2 lastUpdate 0;\
				ne? $(statVal.$(statVal)) $(statLast.$(statVal)) StatusLightUpdate;\
				statVal 2;\
				ne? $(statVal.$(statVal)) $(statLast.$(statVal)) StatusLightUpdate;\
				eq? $(actwin) w0 ShowDepth;\
				WinMgr after:4:CheckStatusIndicators
/*
 * Update the height display gauge
 * THIS LOOKS LIKE IT IS DEPRECATED!!!!!!!!
 */
#if #class(shovel) || #class(loader)
macro	UpdateGauges	w0.ht value:$(- $(ComMgr filteredCenterElev) $(ComMgr centerDesiredElev));\
			hp.ht value:$(- $(ComMgr filteredCenterElev) $(ComMgr centerDesiredElev))
#else
macro	UpdateGauges	w0.ht value:$(- $(ComMgr filteredCenterElev) $(ComMgr centerDesiredElev))
#endif

/*
 * Initialisation macros to set up various parameters on the 
 * different windows
 */
#if #class(shovel) || #class(loader)

macro   Init    Macro KSTATE:0;\
                foreach $(cfg.10);do matl.\$1 \$(cfgLbl.3);\
		actwin w0;\
                w0.ht relief:raised;\
                CheckStatusIndicators;\
		SetupMatlToggle;\
 		InitHpWindow;\
		Initw0Window;\
		SetHpButtons;\
		SetZoomLimits;\
		switchHpInformation

#else

macro   Init    Macro KSTATE:0;\
                actwin w0;\
                w0.ht relief:raised;\
                CheckStatusIndicators;\
		Initw0Window;\
		InitHpWindow;\
		SetHpButtons;\
		SetZoomLimits

#endif

/*
 * Adjust the action of the hp.b2 button for FELs - on the shovel
 * it switches to the message utility - it's needed to change
 * direction manually on the FEL. This also applies to dozers and graders
 */
#if #class(loader) || #class(dozer) || #class(grader)

macro 	SetHpButtons	hp.b2 action:'ChangeDir'	icon:chdir

#else

#if #class(shovel)  

macro   SetHpButtons    hp.b2 map:n

#else

macro   SetHpButtons    hp.b2 icon:pattern action:'WinMgr window:wProject'

#endif

#endif

/*
 * Check the GPS status and set the statVal flag appropriately
 * make the indicator light display correctly
 * Update Cut/Fill/High/Low indicators
 */

symbol	indicatorVal
symbol	matlFlag
symbol	gpsStat	0

#if #class(shovel) || #class(loader)

macro	UpdateIndicators	ShowGPS;ShowElev;ShowMatl

#elif #class(drill)

macro	UpdateIndicators	ShowGPS;ShowDeck;ShowHole

#elif #class(dozer) || #class(grader)

macro	UpdateIndicators	ShowGPS;ShowElev

#endif

macro   ShowGPS			indicatorVal "$(ComMgr eqmtGpsStatus)";\
				eq? "$(indicatorVal)" "Pos" statVal.1 2;\
				eq? "$(indicatorVal)" "Elev" statVal.1 1;\
				eq? "$(indicatorVal)" "Ok" statVal.1 4;\
				eq? "$(actwin)" "hp" CheckHpDisplay

#if #class(drill)

macro	CheckHpDisplay	ne? "$(indicatorVal)" "Ok" UnmapCanvas;\
			eq? "$(indicatorVal)" "Ok" MapCanvas

macro	UnmapCanvas	eq? "$(hp.CADCanvas map)" "yes" hp.CADCanvas map:n

macro	MapCanvas	ne? "$(hp.CADCanvas map)" "yes" hp.CADCanvas map:y

#else

macro	CheckHpDisplay

#endif

#if #class(drill)
macro	ShowDeck 		eq? "$(ComMgr frontIncl)" "0.0" statVal.2 4;\
                                eq? "$(ComMgr sideIncl)" "0.0" statVal.2 4;\
                                ne? "$(ComMgr frontIncl)" "0.0" statVal.2 2;\
                                ne? "$(ComMgr sideIncl)" "0.0" statVal.2 2

macro	ShowHole		actAngle $(ComMgr mastIncl);actBrg $(ComMgr trueHeading);\
				ne? $(holeOverride) 1 ne? "$(ComMgr pattern)" "none" ShowTarget

macro	ShowTarget		tgtAngle $(ComMgr tgtAngle);tgtBrg $(ComMgr tgtBrg);\
				patID $(ComMgr pattern);dist $(ComMgr distToTgt);\
				holeID "$(ComMgr holeName)";CheckAutoZoom

macro	ShowDepth		ne? $(target) 0 w0.ht value $(- 100 $(/ $(* 100 $(depth)) $(target)))

#else
macro	ShowElev		w0.elev label:$(ComMgr filteredCenterElev);\
				ne? "$(ComMgr centerDesiredElev)" "?" \
					indicatorVal $(- $(ComMgr filteredCenterElev) $(ComMgr centerDesiredElev));\
				eq? $(ComMgr centerDesiredElev) ? indicatorVal 0.0;\
				eq? "$(actwin)" "w0" ShowElevW0;\
				eq? "$(actwin)" "hp" ShowElevHp

macro	ShowElevW0		w0.desElev label:$(indicatorVal);\
                                w0.ht value:$(indicatorVal);\
                                eq? $(min $(indicatorVal) 0) 0 w0.desElevLbl label:"$(cfgLbl.4)";\
                                ne? $(min $(indicatorVal) 0) 0 w0.desElevLbl label:"$(cfgLbl.5)"

macro	ShowDepth

#	if #class(dozer) || #class(grader)

	macro	ShowElevHp		hp.ht value:$(indicatorVal);\
				SET-VALUES "hp.data" 0 0 [ $(ComMgr project) $(ComMgr frontIncl) \
					$(ComMgr sideIncl) ]

#	else

        macro   updateInclInformation            SET-VALUES "hp.data" 0 0 [ $(ComMgr frontIncl) $(ComMgr sideIncl) ]

        /* infoHp switchs between (Truck, Tons) and (Pitch, Roll)   */

        macro   ShowElevHp                       hp.ht value:$(indicatorVal);\
                                                 eq? $(infoHp) 1 updateInclInformation
#	endif
macro   translateNoneMatl       eq? "$(ComMgr gpsMaterial)" "none" hp.gpsmatl label:$(cfgLbl.3);\
                                ne? "$(ComMgr gpsMaterial)" "none" hp.gpsmatl label:$(ComMgr gpsMaterial);\
                                eq? "$(hp.matl label)" "None" hp.matl label:$(cfgLbl.3)

macro   translateNoneProject    eq? "$(ComMgr project)" "none" hp.gpsmatl label:$(cfgLbl.3);\
                                ne? "$(ComMgr project)" "none" hp.gpsmatl label:$(ComMgr project);\
                                eq? "$(hp.matl label)" "None" hp.matl label:$(cfgLbl.3)

macro   updateGpsMatlLabel      eq? $(ComMgr oKToDisplayDugoutArea) 1 translateNoneMatl;\
                                eq? $(ComMgr oKToDisplayDugoutArea) 0 translateNoneProject

macro   ShowMatl		ne? "$(ComMgr gpsMaterial)" "$(hp.matl label)" matlFlag 2;\
                                eq? "$(ComMgr gpsMaterial)" "none" matlFlag 1;\
                                eq? "$(ComMgr gpsMaterial)" "$(hp.matl label)" matlFlag 4;\
                                statVal.2 $(matlFlag);\
				eq? "$(actwin)" "hp" updateGpsMatlLabel
#endif

/*
 * Called internally from ComMgr
 * to update screen position-related objects
 * ALL INTERVAL-BASED SCREEN UPDATING STARTS HERE
 */
macro   updateMacroComponents   eq? "$(actwin)" "w0" UpdateIndicators;\
				eq? "$(actwin)" "hp" UpdateIndicators;\
				lastUpdate 0

/* Wait 1 second to allow any HP threads to complete screen
 * updating and then do a refresh. This gets rid of the icon
 * from a non-HP screen if it inadvertently appears
 */
macro	RefreshScreen		WinMgr after:1:'WinMgr refresh'

#if #class(shovel) || #class(loader) || #class(dozer) || #class(grader)
/*
 * Elevation map granularity (how big each individual square is)
 * setting. This symbol keeps track of the current setting.
 * Two settings are available - large (3ft or metres) and small (1ft or m)
 * Small is generally for precision finishing work
 */
symbol  mapElementSize  "Large"

/*
 * Change the elevation map granularity to the opposite
 * of the current setting (Small to Large, Large to Small)
 */
macro   ChangeMapElementSize    eq? $(mapElementSize) "Large" holder "Small";\
                                ne? $(mapElementSize) "Large" holder "Large";\
                                ComMgr use$(holder)Granularity;\
                                mapElementSize $(holder)

symbol  objectName

macro   setPlaneParam   hp.Kp map:no;\
                        eq? "$(objectName)" "Perc" hp.Plane.$(objectName)Value label:$(min $(hp.Kp.Disp label) 30);\
                        ne? "$(objectName)" "Perc" hp.Plane.$(objectName)Value label:$(hp.Kp.Disp label);\
                        hp.Plane refresh

macro   kpPlaneParams   hp.Kp.Disp maxchars:10 label:$(hp.Plane.$(objectName)Value label);\
                        hp.Kp label:'Plan $(objectName)' action:setPlaneParam geom:x:390:y:0 map:y

/*
 * Change the gradient (slope) indicator label and color between
 * green positive (uphill) and red negative (downhill) when the
 * operator enters ramp creation data
 */
macro   toggleSlope     eq? "$(hp.Plane.PercSign label)" "+" holder "-";\
                        ne? "$(hp.Plane.PercSign label)" "+" holder "+";\
                        eq? "$(holder)" "-" hp.Plane.PercSign label:"-" colors:redButton;\
                        ne? "$(holder)" "-" hp.Plane.PercSign label:"+" colors:greenButton

macro	setTargetElevation	hp.Kp2 map:n;\
                                ComMgr setDesiredElevTo:$(hp.Kp2.Disp label)

macro   kpSetElevation  hp.Kp2 label:'Elévation' action:'setTargetElevation' geom:x:390:y:0 map:y

macro   LevelCancel hp.Kp2 map:n

macro	deleteProjects	ComMgr resetFillAndCutModel

#endif

#if #class(dozer) || #class(loader) || #class(grader)

macro   ChangeDir	eq? $(ComMgr goingForward) 0 holder 1;\
 			eq? $(ComMgr goingForward) 1 holder 0;\
			ComMgr goingForward:$(holder);\
			DOZER-OP-DIRSWAP $(holder)

#endif

symbol  eqmtDisplay

#if #class(dozer) || #class(grader)

macro   topView holder top;\
        eqmtDisplay "$(eqmtClass)"

macro   sideView holder side;\
        eqmtDisplay "$(eqmtClass)_side"

macro   flipView        hp.Kp map:n;\
                        eq? $(ComMgr backgrndType) side topView;\
                        eq? $(ComMgr backgrndType) top sideView;\
                        $(CMobject) backgrndType:$(eqmtDisplay)

#endif

#if #class(shovel) || #class(loader)

symbol	scaleFactor	100

/*
 * kpPanFull - High Precision full signal for loading units
 *
 * $1 = Loader's center X position, mine units * scale factor (100)
 * $2 = Y
 * $3 = Z
 * $4 = Loader's bucket X position, mine units * scale factor (100)
 * $5 = Y
 * $6 = Z
 */

macro	kpPanFull	ComMgr hpFull; kpFull

/*
 * macro	kpPanFull	PANFULL [ \
 * 				"$(* $(ComMgr centerPosX) $(scaleFactor))" \
 * 				"$(* $(ComMgr centerPosY) $(scaleFactor))" \
 * 				"$(* $(ComMgr filteredCenterElev) $(scaleFactor))" \
 * 				"$(* $(ComMgr bucketPosX) $(scaleFactor))" \
 * 				"$(* $(ComMgr bucketPosY) $(scaleFactor))" \
 * 				"$(* $(ComMgr bucketElev) $(scaleFactor))" \
 * 			];\
 * 			kpFull
 */

macro	GotDipperSwitch	EQ-REQ "dipper" [ "$(ComMgr bucketHeading)" ]

in	CP-SWITCH	0x18a	b	eq? $1 1 kpPanFull;\
					eq? $1 2 GotDipperSwitch

#endif

/*
 * Viewing zoom adjustment macros for canvas object
 * Zoom level doubles each time macro executes until
 * maxZoom is reached, at which point it resets to
 * minZoom on the next execution. NOTE that a client
 * can override these settings by defining the ZoomRange1
 * and ZoomRange2 macros in the client Macro_client.cfg
 */
symbol	minZoom	100
symbol	maxZoom	400
symbol	actZoom 200

macro	SetZoomLimits	eq? $(max $(ComMgr eqmtDimension) 15) 15 ZoomRange1;\
			ne? $(max $(ComMgr eqmtDimension) 15) 15 ZoomRange2;\
			hp.CADCanvas zoom:actZoom

/*
 * the drill needs some extra zoom range, to help the
 * operator position over the hole. Try to come up with reasonable
 * default zoom values, although they can be overriden by the client
 */
#if #class(drill)

macro	ZoomRange1	minZoom 275;maxZoom 2200;actZoom 550
macro	ZoomRange2	minZoom 200;maxZoom 1600;actZoom 400

#else

macro	ZoomRange1	minZoom 400;maxZoom 1600;actZoom 800
macro	ZoomRange2	minZoom 100;maxZoom 400;actZoom 100

#endif

symbol	autoZoomOn 0

/*
 * Check that the unit is not already zoomed in to the maximum
 * level for drilling a hole (drills only - other equipment will
 * always have an autoZoomOn value of 0)
 */
macro   DoZoom  ne? $(autoZoomOn) 1 DoZoom2

/*
 * Cycle the zoom level - it is doubled each time the macro
 * is called until it is larger than maxZoom at which time it
 * resets to the minimum zoom level
 */
macro	DoZoom2	actZoom $(* $(actZoom) 2);ne? $(max $(maxZoom) $(actZoom)) $(maxZoom) actZoom $(minZoom);\
		hp.CADCanvas zoom:$(actZoom) updateWholeHPScreen

/*ne? $(min $(hp.CADCanvas zoom) $(maxZoom)) $(maxZoom) hp.CADCanvas zoom:$(* $(hp.CADCanvas zoom) 2);\
 *		eq? $(min $(hp.CADCanvas zoom) $(maxZoom)) $(maxZoom) hp.CADCanvas zoom:$(minZoom);\
 *                hp.CADCanvas updateWholeHPScreen
 */

/*
 * increase Macro stack to 8192 to avoid macro expansion problems
 */
stack 8192

symbol  rotateIcon.0    north
symbol  rotateIcon.90   east
symbol  rotateIcon.180  south
symbol  rotateIcon.270  west

symbol  currentView 0

/*
 * Rotate the GPS navigation screen through 90 degree increments
 */

macro DoMessageToGps    hp.Text map:y;\
                        hp.Text write:$(cfgLbl.150)\n;\
                        WinMgr after:5:'hp.Text map:n'

macro RotateViewGps eq? "$(ComMgr eqmtGpsStatus)" "Pos" DoMessageToGps;\
                        eq? "$(ComMgr eqmtGpsStatus)" "Elev" RotateView;\
                        eq? "$(ComMgr eqmtGpsStatus)" "Ok" RotateView

#if #class(drill) || #class(dozer) || #class(grader)

/*
 * These units have a small compass icon that updates current top-of-screen
 * direction as rotation occurs
 */

macro   RotateView      eq? $(currentView) 0 currentView 360;\
                        ne? $(currentView) 0 currentView $(- $(currentView) 90);\
			hp.CADCanvas worldrotation:$(currentView);\
			hp.lbl0 icon:$(rotateIcon.$(currentView));\
			hp.CADCanvas updateWholeHPScreen

#else

/*
 * Remaining units do not have the compass icon
 */

macro   RotateView      eq? $(currentView) 0 currentView 360;\
                        ne? $(currentView) 0 currentView $(- $(currentView) 90);\
			hp.CADCanvas worldrotation:$(currentView);\
			hp.CADCanvas updateWholeHPScreen

#endif

#if #option(Backhoe)

macro canvasSelected showSideView

#else

macro canvasSelected ToggleDugoutArea

#endif

macro	ToggleDugoutArea	eq? $(ComMgr oKToDisplayDugoutArea) 0 holder 1;\
				ne? $(ComMgr oKToDisplayDugoutArea) 0 holder 0;\
				ComMgr oKToDisplayDugoutArea:$(holder)

in	GEO-FILES	0x1e3	s	ComMgr setGeoData:$1

#if #class(shovel) || #class(loader)

/*
 * GPS Diagnostics Macros to be sent to the workstation every gpsSendSecs when requested
 */
symbol	gpsSendSecs	2
symbol	gpsSendInfo	0

symbol	cPosX	0
symbol	cPosY	0
symbol	cPosZ	0
symbol	bPosX	0
symbol	bPosY	0
symbol	bPosZ	0
symbol	bHead	999
symbol	gpsStat	None
symbol	sIncl	999
symbol	fIncl	999
symbol	cDes	0
symbol	bDes	0
symbol	proj	None

macro	StartGpsInfo	gpsSendInfo 1;\
			CollectGpsInfo

macro	CollectGpsInfo	GetCenterData;\
			GetBucketData;\
			GetGeneralData;\
			eq? $(gpsSendInfo) 1 SendGpsInfo

macro	GetCenterData	cPosX "$(ComMgr centerPosX)";\
			cPosY "$(ComMgr centerPosY)";\
			cPosZ "$(ComMgr filteredCenterElev)";\
			cDes "$(ComMgr centerDesiredElev)"

macro	GetBucketData	bPosX "$(ComMgr bucketPosX)";\
			bPosY "$(ComMgr bucketPosY)";\
			bPosZ "$(ComMgr bucketElev)";\
			bHead "$(ComMgr bucketHeading)";\
			bDes "$(ComMgr bucketDesiredElev)"

macro	GetGeneralData	gpsStat "$(ComMgr eqmtGpsStatus)";\
			sIncl "$(ComMgr sideIncl)";\
			fIncl "$(ComMgr frontIncl)";\
			proj "$(ComMgr project)"

macro	StopGpsInfo	gpsSendInfo 0


macro	noTalk	ne? "$2" "GPS-INFO-CGC" Ok action:'' label:"Impossible d'envoyer $2 à $1" post

#endif

/* The following macros are for language-independence. If a different
 * language is required then the cfgLbl values should be changed in
 * Goic/common/Macro_cfg.cfg
 */

/* Initialise the alpha-numeric keypad window to the
 * correct labels (Exit, Del, etc)
 */
macro   InitKpWindow    SET-VALUES wKp.b 0 0 [ $(cfgLbl.90) ];\
                        SetKeypadLabel

/* Initialise the numeric keypad window to the correct
 * labels (Exit, Del, etc.)
 */
macro   InitKp2Window   SET-VALUES wKp2.b 0 0 [ $(cfgLbl.89) ];\
                        SetKeypadLabel

#if #class(drill)

macro	SendCurrentStatus	GPS-INFO "eqmtinfo" [ "$(ComMgr pattern)" "$(ComMgr holeName)" "$(ComMgr centerElev)" "$(target)" "$(target)" ]

#elif #class(shovel) || #class(loader)

macro	SendCurrentStatus	GPS-INFO "eqmtinfo" [ "$(ComMgr project)" "$(ComMgr gpsMaterial)" \
 					"$(matl.$(matl))" "$(ComMgr centerDesiredElev)" \
					"$(ComMgr filteredCenterElev)" ]

#elif #class(dozer) || #class(grader)

macro	SendCurrentStatus	GPS-INFO "eqmtinfo" [ "$(ComMgr project)" "N/A" "N/A" \
					"$(ComMgr centerDesiredElev)" "$(ComMgr centerElev)" ]

macro	CheckView	ne? "$(ComMgr backgrndType)" "side" RotateView

macro	ChangeView	eq? "$(ComMgr backgrndType)" "side" holder "top";\
			eq? "$(ComMgr backgrndType)" "top" holder "side";\
                        eq? "$(holder)" "side" currentView 90;\
			eq? "$(holder)" "side" RotateView;\
			ComMgr backgrndType:$(holder);

#endif

macro	DoInfo	WinMgr window:wInfo

macro	giveupRequestingInfo

/* Original macro commented out to show wGauges on w0 window
macro   DoGauges        WinMgr window:wGauges
*/
macro   DoGauges	showGauges.$(GaugTog)
macro	showGauges.0	wGauges map:y;GaugTog 1
macro	showGauges.1	wGauges map:n;GaugTog 0
macro   DoReset         Actions unpost;nextAction reset;yesNo label:$(cfgLbl.113) post

#if #class(loader) || #class(shovel)

macro mapHpTruckInfo hp.data0 map:n;\
		     hp.dataLbl0 map:n;\
		     hp.data1 map:n;\
		     hp.dataLbl1 map:n;\
		     hp.data2 map:y;\
		     hp.dataLbl2 map:y;\
		     hp.data3 map:y;\
		     hp.dataLbl3 map:y

macro mapHpInclInfo hp.data0 map:y;\
		     hp.dataLbl0 map:y;\
		     hp.data1 map:y;\
		     hp.dataLbl1 map:y;\
		     hp.data2 map:n;\
		     hp.dataLbl2 map:n;\
		     hp.data3 map:n;\
		     hp.dataLbl3 map:n

symbol infoHp 1
symbol infoHp.0 1
symbol infoHp.1 0

macro switchHpInformation infoHp $(infoHp.$(infoHp));\
			  eq? $(infoHp) 0 setInfoHpTruck;\
			  eq? $(infoHp) 1 setInfoHpIncl

macro setInfoHpTruck	hp.swInfo relief:raised; mapHpTruckInfo 

macro setInfoHpIncl	hp.swInfo relief:sunken; mapHpInclInfo

macro forceToMapTruckInfo eq? $(infoHp) 1 switchHpInformation

in  SHOV_GPS_REQ 0x07BF  v    sendGps
out SHOV_GPS 0x07C0  fff  sendto up

macro sendGps SHOV_GPS $(ComMgr centerPosX) $(ComMgr centerPosY) $(ComMgr filteredCenterElev)
#endif
