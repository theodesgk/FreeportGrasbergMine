%! /psw/cpp
###################################################################
# Store and Forward Mine Info code
###################################################################
symbol  mindex
symbol  minfo
symbol	argsrcv
symbol  bcn0
symbol  bcn1
symbol  bcn2
symbol  bcn3
symbol  bcn4
symbol  bcn5
symbol  bcn6
symbol  bcn7
symbol  bcn8
symbol  bcn9
symbol  bcn10
symbol  bcn11
symbol  bcn12
symbol  bcn13
symbol  bcn14
symbol  bcn15
symbol  inf0
symbol  inf1
symbol  inf2
symbol  inf3
symbol  inf4
symbol  inf5
symbol  inf6
symbol  inf7
symbol  inf8
symbol  inf9
symbol  inf10
symbol  inf11
symbol  inf12
symbol  inf13
symbol  inf14
symbol  inf15
symbol	MIarglist0	0
symbol	MIarglist1	0 1
symbol  MIarglist2	0 1 2
symbol  MIarglist3	0 1 2 3
symbol  MIarglist4	0 1 2 3 4
symbol  MIarglist5	0 1 2 3 4 5
symbol  MIarglist6	0 1 2 3 4 5 6
symbol  MIarglist7	0 1 2 3 4 5 6 7
symbol  MIarglist8	0 1 2 3 4 5 6 7 8
symbol	MIarglist9	0 1 2 3 4 5 6 7 8 9
symbol	MIarglist10	0 1 2 3 4 5 6 7 8 9 10
symbol	MIarglist11	0 1 2 3 4 5 6 7 8 9 10 11
symbol	MIarglist12	0 1 2 3 4 5 6 7 8 9 10 11 12
symbol	MIarglist13	0 1 2 3 4 5 6 7 8 9 10 11 12 13
symbol	MIarglist14	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14
symbol	MIarglist15	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
macro	createminfo	MineInfo locid:$(bcn$(mindex));\
                        eq? "$(minfo)" "locid" MineInfo locname:$(inf$(mindex));\
                        eq? "$(minfo)" "loctype" MineInfo loctype:$(inf$(mindex));\
                        eq? "$(minfo)" "locunit" MineInfo locunit:$(inf$(mindex));\
                        eq? "$(minfo)" "locstat" MineInfo locstat:$(inf$(mindex));\
                        eq? "$(minfo)" "locauto" MineInfo locauto:$(inf$(mindex));
in MINEINFO     0x078c    s[d][s] minfo $1;showMineInfo;foreach $2;do getbcn;foreach $3;do getinf;processminfo
macro processminfo	foreach $(MIarglist$(argsrcv));do 'mindex \$2;createminfo'
macro getbcn    argsrcv $1;bcn$1 $2
macro getinf    inf$1 $2
macro showMineInfo	eq? "$(midebug)" "1" displayMineInfo
macro displayMineInfo	postTrans "\nMINEINFO rpc received for $(minfo)\n"

symbol last_beacon -1
symbol ptdebug	0
out    GPS-ARRIVE     0x01a6  ddd?dd  last_beacon $1;eq? $(ptdebug) 1 MIView2;sendto up
out   RFID-ARRIVE     0x0601  dd      last_beacon $2;eq? $(ptdebug) 1 MIView2;sendto up

symbol loc_id
symbol loc_sign
symbol loc_type
symbol loc_unit
symbol loc_stat
symbol loc_rsn
symbol loc_btyp
symbol loc_auto
symbol midebug   	 0
macro HandleBcnArr	loc_sign $(last_beacon);clrLocInfo;setLocId;setLocType;setLocUnit;setLocStat;setLocAuto;showArrive
macro clrLocInfo	loc_id "Unknown";loc_type "Unknown";loc_unit 0;loc_stat "Unknown";loc_auto 0
macro setLocId          loc_id $(nil);MineInfo locid:$(loc_sign);loc_id $(MineInfo locname)
macro setLocType	MineInfo locid:$(loc_sign);loc_type $(MineInfo loctype)
macro setLocUnit	MineInfo locid:$(loc_sign);loc_unit $(MineInfo locunit)
macro setLocStat	MineInfo locid:$(loc_sign);loc_stat $(MineInfo locstat)
macro setLocAuto	MineInfo locid:$(loc_sign);loc_auto $(MineInfo locauto)
macro showArrive	eq? "$(midebug)" "1" showDisplay
macro showDisplay	displayInfo;displayInfo2
macro displayInfo	postTrans "\nBeacon Arrive at $(loc_sign)\nLocation:$(loc_id)\n"
macro displayInfo2	postTrans "Type:$(loc_type)\nUnit:$(loc_unit)\nStatus:$(loc_stat)\nAuto:$(loc_auto)\n"
macro CheckAuto		eq? "$(loc_auto)" "1" eq? "$(loc_id)" "$(dest)" eq? $(sfnextact) $(SF_ARRIVE) ARRIVE -1

symbol MIViewid
macro btnMIView		PostNumPad "Beacon ID" MIInput
macro MIInput		loc_sign $(GetPadValue);MIView
macro MIView		MICheck	
macro MIView2		loc_sign $(last_beacon);MICheck
macro MICheck		setLocId;eq? "$(loc_id)" " " MIShow2;ne? "$(loc_id)" " " MIShow
macro MIShow		setLocType;setLocUnit;setLocStat;setLocAuto;postTrans "Beacon ID:$(loc_sign)\nlocid:$(loc_id)\nloctype:$(loc_type)\nlocunit:$(loc_unit)\nlocstat:$(loc_stat)\nlocauto:$(loc_auto)\n"
macro MIShow2		postTrans "Beacon ID:$(loc_sign)\nNo Information available\n"
macro MIViewon	KMENU2 Options [ 'MineInfo\nView btnMIView' ]
in	MIDisplay	INT_RPC	d	loc_sign $1;MICheck
