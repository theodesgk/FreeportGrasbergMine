%!/psw/cpp
/*
 * * * * * * * * * * * * * * * * * * *
 *  DISPATCH Real-Time Firmware Module
 * Copyright (c) Modular Mining Systems, 1982-1996
 *               All Rights Reserved
 *  $RCSfile: Macro.cfg,v $
 * $Revision: 1.5 $
 *   $Author: latum $
 *     $Date: 2004/06/14 20:22:00 $
 *    $State: Exp $
 *   Purpose: Macro.cfg extensions for drill monitoring
 *	      system support.
 * * * * * * * * * * * * * * * * * * *
 */

/*
 * We are dealing with either a revD hub that needs the drill Vsms
 * configuration loaded, OR a masterlink hub that is sitting between
 * such a revD hub and the CGC
 */

#if #arch(hub) || #arch(hubcan)

/*
 * its a revD hub connected to the masterlink hub via Slip
 */

/*
 * first of all, redefined the CP-SWITCH rpc so it gets sent to the
 * Slip port rather than the Goic which isn't directly connected to
 * this hub
 */
out	CP-SWITCH	0x18a	b	sendto Slip

/*
 * next, we include the main configuration file for the drill hardware.
 */
#include <VsmsDrill/Drill.h>

/*
 * void vrates(int opt);
 *
 * Transmit one of the following rate vectors in A$RATES packet.
 *
 * opt:0	penetration rate
 * opt:1	RPM
 * opt:2	Motor Amps
 * opt:3	Pull Down Force
 * opt:4 	Bit Air Pressure
 * opt:-1	All of the above
 */
in	VRATES		0x92	d	send$1

/*
 * void kdrill(char *bitDepth, char *penRate, char *depthFromBottom);
 *
 * Transmit these parameters to operator interface.
 */
out	KDRILL		0x5d	sss	sendto Slip

/*
 * Transmit rate vector upstream.  First element of vector
 * contains one of the `vrates' option bytes; remainder contains
 * the 8-bit data vectors.
 */
out	A$RATES		0x93	[b]d	sendto Slip

symbol	rate		0.0
symbol	depth		0.0
symbol	bottom		0.0
symbol	index		0
symbol	act		1
symbol	sav		0
macro	GCZeroDepth	bottom 0;Pc0 offset:0 counts:0;rate 0.0
macro	GCStartAddRod	sav $(Pc0 counts);act 0;
macro	GCEndAddRod	Pc0 counts:$(sav);act 1;
macro	GCAddRod	Pc0 offset:$(+ $(Pc0 offset) STEELLENGTH)
macro	GCAddRodLength	Pc0 offset:$(+ $(Pc0 offset) $1)
macro	setDepth	depth $(/ $(Pc0 counts) SHAFTPERDIST)
macro	setBottom	bottom $(max $(bottom) $(depth))
macro	setIndex	index $(/ $(Pc0 counts) SHAFTPERSAMPLE)
macro	sendUpdate	KDRILL $(depth) $(rate) $(- $(bottom) $(depth))
macro	drillSample	eq? $(act) 1 setIndex;samp0;samp1;samp2;samp3;samp4
macro	drillRate	rate $(/ MSECSTORATE $(Pc0 width))
macro	drillUpdate	eq? $(act) 1 setDepth;setBottom;sendUpdate
macro	samp0		prof0 $(index):PROF0
macro	samp1		prof1 $(index):PROF1
macro	samp2		prof2 $(index):PROF2
macro	samp3		prof3 $(index):PROF3
macro	samp4		prof4 $(index):PROF4
macro	send0		prof0 0:0;A\$RATES $(subvec prof0:$(+ $(index) 1)) DISTPERSAMPLE
macro	send1		prof1 0:1;A\$RATES $(subvec prof1:$(+ $(index) 1)) DISTPERSAMPLE
macro	send2		prof2 0:2;A\$RATES $(subvec prof2:$(+ $(index) 1)) DISTPERSAMPLE
macro	send3		prof3 0:3;A\$RATES $(subvec prof3:$(+ $(index) 1)) DISTPERSAMPLE
macro	send4		prof4 0:4;A\$RATES $(subvec prof4:$(+ $(index) 1)) DISTPERSAMPLE
macro	send-1		send0;send1;send2;send3;send4

/*
 * redefine the KDATA rpc to be sent to Slip. The default definition is to
 * send it to the CGC but since this revD hub is connected to the masterlink
 * hub via a Slip connection, it knows nothing about the CGC
 */
out	KDATA	0x97	[d]	sendto Slip

#else

/*
 * this is a masterlink hub that is sitting between the Goic and the revD hub
 * with all the drill sensors connected. As far as this option is concerned,
 * all this hub does is pass rpcs through. That's why here, we need to redefine the
 * rpcs that have already been defined in the generic Hub/drill/Macro.cfg, as 'in'
 * instead of 'out'
 */

in	CP-SWITCH	0x18a	b	sendto Goic
in	KDRILL		0x5d	sss	sendto Goic
in	VRATES		0x92	d	sendto Slip
in	VSHAFT		0x94	d	sendto Slip
in	KDATA		0x97	[d]	sendto Goic

#endif
