%! /psw/cpp
/*
 * * * * * * * * * * * * * * * * * * *
 *  DISPATCH Real-Time Firmware Module
 * Copyright (c) Modular Mining Systems, 1982-2009
 *               All Rights Reserved
 *  $RCSfile: Macro.cfg,v $
 * $Revision: 1.2 $
 *   $Author: dcitron $
 *     $Date: 2012/03/19 22:31:16 $
 *    $State: Exp $
 *   Purpose: Macro configuration file for Haul-Cycle Automation
 * * * * * * * * * * * * * * * * * * *
 */

#if #arch(pe)

#if !#option(StoreForward)
#   include <StoreForward/Goic/Macro.cfg>
#endif

# HCA Cases
symbol INVALID_CASE       0
symbol CONN_BKT_INTERFACE 1
symbol CONN_BKT           2
symbol CONN_FULL_VIMS     3
symbol CONN_FULL_PLM      4
symbol CONN_FULL          5
symbol CONN_ARR_DUMP_VIMS 6
symbol CONN_ARR_DUMP_PLM  7
symbol CONN_ARR_DUMP_DIN  8
symbol CONN_ARR_DUMP      9
symbol CONN_ASSIGN_VIMS   10
symbol CONN_ASSIGN_PLM    11
symbol CONN_ASSIGN_DIN    12
symbol CONN_ASSIGN        13
symbol CONN_ARR_SHOV      14
symbol BKT_INTERFACE      15
symbol HCA_BKT            16
symbol FULL_VIMS          17
symbol FULL_PLM           18
symbol HCA_FULL           19
symbol ARR_DUMP_VIMS      20
symbol ARR_DUMP_PLM       21
symbol ARR_DUMP_DIN       22
symbol ARR_DUMP           23
symbol ASSIGN_VIMS        24
symbol ASSIGN_PLM         25
symbol ASSIGN_DIN         26
symbol HCA_ASSIGN         27
symbol ARR_SHOV           28

#######################################
# Constants
#######################################
symbol MIN_PAYLOAD         20
symbol MIN_VELOCITY        1
symbol MIN_DISTANCE        10
symbol DIGITAL_INPUT_OFF   0
symbol DIGITAL_INPUT_ON    1
symbol DRIVERS_DELAY_CHECK 60
symbol CASE_RETRY_TIME     10
symbol UNIT_NONE           0
symbol UNIT_SHOVEL         2
symbol UNIT_DUMP           3
symbol UNIT_CRUSHER        4
symbol UNIT_STOCKPILE      5
symbol UNIT_BLAST          6
symbol STATUS_NONE         0
symbol STATUS_READY        2

# Driver IDs
symbol VIMS_GEN_DRIVER_ID      5.1
symbol VIMS_797B_DRIVER_ID     5.2
symbol VIMS_785B_DRIVER_ID     5.3
symbol VIMS_785C_DRIVER_ID     5.4
symbol VIMS_789B_DRIVER_ID     5.5
symbol VIMS_789B0700_DRIVER_ID 5.6
symbol VIMS_793B_DRIVER_ID     5.7
symbol VIMS_793C_DRIVER_ID     5.8
symbol VIMS_793C0700_DRIVER_ID 5.9
symbol VIMS_994D_DRIVER_ID     5.10
symbol VIMS_793D_DRIVER_ID     5.11
symbol VIMS_797A_DRIVER_ID     5.12
symbol VIMS_994F_DRIVER_ID     5.14
symbol VIMS_797F_DRIVER_ID     5.15
symbol PLM_GEN_DRIVER_ID       2.1

# Parameter IDs
symbol VIMS_GEN_PAYLD_PAR_MCID       5.1.523
symbol VIMS_797B_PAYLD_PAR_MCID      5.2.523
symbol VIMS_785B_PAYLD_PAR_MCID      5.3.523
symbol VIMS_785C_PAYLD_PAR_MCID      5.4.523
symbol VIMS_789B_PAYLD_PAR_MCID      5.5.523
symbol VIMS_789B0700_PAYLD_PAR_MCID  5.6.523
symbol VIMS_793B_PAYLD_PAR_MCID      5.7.523
symbol VIMS_793C_PAYLD_PAR_MCID      5.8.523
symbol VIMS_793C0700_PAYLD_PAR_MCID  5.9.523
symbol VIMS_994D_PAYLD_PAR_MCID      5.10.573
symbol VIMS_793D_PAYLD_PAR_MCID      5.11.523
symbol VIMS_797A_PAYLD_PAR_MCID      5.12.523
symbol VIMS_994F_PAYLD_PAR_MCID      5.14.573
symbol VIMS_797F_PAYLD_PAR_MCID      5.15.524
symbol PLM_PAYLD_PAR_MCID            2.1.10

symbol VIMS_GEN_GNDSPD_PAR_MCID      5.1.514
symbol VIMS_797B_GNDSPD_PAR_MCID     5.2.514
symbol VIMS_785B_GNDSPD_PAR_MCID     5.3.520
symbol VIMS_785C_GNDSPD_PAR_MCID     5.4.520
symbol VIMS_789B_GNDSPD_PAR_MCID     5.5.520
symbol VIMS_789B0700_GNDSPD_PAR_MCID 5.6.520
symbol VIMS_793B_GNDSPD_PAR_MCID     5.7.520
symbol VIMS_793C_GNDSPD_PAR_MCID     5.8.520
symbol VIMS_793C0700_GNDSPD_PAR_MCID 5.9.520
symbol VIMS_994D_GNDSPD_PAR_MCID     5.10.532
symbol VIMS_793D_GNDSPD_PAR_MCID     5.11.520
symbol VIMS_797A_GNDSPD_PAR_MCID     5.12.514
symbol VIMS_994F_GNDSPD_PAR_MCID     5.14.532
symbol VIMS_797F_GNDSPD_PAR_MCID     5.15.520
symbol PLM_GNDSPD_PAR_MCID           2.1.6

# Event MineCare IDs (default to general model)
symbol PLM_RUNWLOAD_EVENT      33619976
symbol PLM_RUNNOLOAD_EVT       33619974
symbol VIMS_BDYUP_INA_EVT      83959406
symbol VIMS_BDYUP_ACT_EVT      83959407
symbol VIMS_DIPPER_EVT         83971616
symbol VIMS_LOAD_EVT           83971617
symbol VIMS_CYCLE_EVT          83971618
symbol PLM_DUMP_EVENT          33619969
symbol PLM_DUMPING_EVENT       33619978
#######################################

# Default to VIMS-GEN
symbol DIPPER_EVENT       0
symbol PAYLOAD_PARAM      0
symbol GNDSPD_PARAM       0
symbol HCA_case           0
symbol availDriver        none
symbol payload
symbol velocity
symbol isVelLessThanOne   no
symbol isVelGreatThanOne  no
symbol distance
symbol truck_loc
symbol gnd_speed
symbol okToSendDepart     no
symbol dipperEvtRcv       no
symbol plmRunWLdEvtRcv    no
symbol vimsBdyUpActEvtRcv no
symbol vimsBdyUpInaEvtRcv no
symbol plmDumpEvtRcv      no
symbol plmDumpingEvtRcv   no
symbol plmRunNoLoad       no
symbol intfAutoArrv       yes
symbol lastDigInp0	0
symbol lastDigInp1	0	
symbol lastDigInp2	0	
symbol lastDigInp3	0
symbol lastDigInp4	0
symbol digInp0		0	
symbol digInp1		0
symbol digInp2		0
symbol digInp3		0	
symbol digInp4		0
symbol isDigInpAvail      no
symbol okToCheckDin       no
symbol dinSwitchActive	  no
symbol autoBktOn          no
symbol autoFullOn         no
symbol autoFullAssignOn   no
symbol autoArrvOn         no
symbol autoAssignOn       no
symbol driverIds
symbol shovelStat         0
symbol shovelBcn          ''
symbol shovelPos          none
symbol shovNxtQTrk
symbol updateFromCentral  0
symbol depart_bcn
symbol LDloc_type
symbol LDloc_valid
symbol hca_safemode		0
symbol hcaInit
symbol hcadebug		  0
symbol hcadbgmode	  1
symbol hcadbgmsg1
symbol hcadbgmsg2
symbol gpsArriveRcv  no
symbol hcaSimOn		0
symbol sim_gnd_speed	0
symbol sim_distance	100
symbol sim_velocity	0
symbol sim_dirTravel	forward
symbol sim_payload	0

in HCADBG 0x9990	ss	eq? $(hcadbgmode) 1 w0.Text write:'$1: $2\n';hcadbgmsg1 $1;hcadbgmsg2 $2;eq? $(hcadbgmode) 2 echo '$(hcadbgmsg1): $(hcadbgmsg2)'

############################
# Initialization
############################
#if !#option(StoreForward)
macro HCA_rpc_extra kstate_extra $(kstate_extra) SF HCA
#else
macro HCA_rpc_extra kstate_extra $(kstate_extra) HCA
#endif
macro  initHCA         WinMgr after:$(DRIVERS_DELAY_CHECK):checkDrivers;\
                       checkDinInp;\
                       startAutoCycle;\
                       hcaInit 1;HCA_rpc_extra

macro  checkDrivers    driverIds $(adap driverIds); foreach $(driverIds); do getDriverId;\
                       ne? $(availDriver) none startAutoCycle;

macro  getDriverId     eq? $(availDriver) none eq? $2 $(VIMS_GEN_DRIVER_ID) vimsGenSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_797B_DRIVER_ID) vims797BSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_785B_DRIVER_ID) vims785BSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_785C_DRIVER_ID) vims785CSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_789B_DRIVER_ID) vims789BSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_789B0700_DRIVER_ID) vims789B0Setts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_793B_DRIVER_ID) vims793BSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_793C_DRIVER_ID) vims793CSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_793C0700_DRIVER_ID) vims793C0Setts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_994D_DRIVER_ID) vims994DSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_793D_DRIVER_ID) vims793DSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_797A_DRIVER_ID) vims797ASetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_994F_DRIVER_ID) vims994FSetts;\
                       eq? $(availDriver) none eq? $2 $(VIMS_797F_DRIVER_ID) vims797FSetts;\
                       eq? $(availDriver) none eq? $2 $(PLM_GEN_DRIVER_ID) plmGenSetts;					   
					   
macro  vimsGenSetts    availDriver $(VIMS_GEN_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 83952139; GNDSPD_PARAM 83952130;\
                       adap request:$(VIMS_GEN_PAYLD_PAR_MCID); adap request:$(VIMS_GEN_GNDSPD_PAR_MCID);

macro  vims797BSetts   availDriver $(VIMS_797B_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84017675; GNDSPD_PARAM 84017666;\
                       adap request:$(VIMS_797B_PAYLD_PAR_MCID); adap request:$(VIMS_797B_GNDSPD_PAR_MCID);

macro  vims785BSetts   availDriver $(VIMS_785B_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84083211; GNDSPD_PARAM 84083208;\
                       adap request:$(VIMS_785B_PAYLD_PAR_MCID); adap request:$(VIMS_785B_GNDSPD_PAR_MCID);

macro  vims785CSetts   availDriver $(VIMS_785C_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84148747; GNDSPD_PARAM 84148744;\
                       adap request:$(VIMS_785C_PAYLD_PAR_MCID); adap request:$(VIMS_785C_GNDSPD_PAR_MCID);

macro  vims789BSetts   availDriver $(VIMS_789B_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84214283; GNDSPD_PARAM 84214280;\
                       adap request:$(VIMS_789B_PAYLD_PAR_MCID); adap request:$(VIMS_789B_GNDSPD_PAR_MCID);

macro  vims789B0Setts  availDriver $(VIMS_789B0700_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84279819; GNDSPD_PARAM 84279816;\
                       adap request:$(VIMS_789B070_PAYLD_PAR_MCID); adap request:$(VIMS_789B0700_GNDSPD_PAR_MCID);

macro  vims793BSetts   availDriver $(VIMS_793B_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84345355; GNDSPD_PARAM 84345352;\
                       adap request:$(VIMS_793B_PAYLD_PAR_MCID); adap request:$(VIMS_793B_GNDSPD_PAR_MCID);

macro  vims793CSetts   availDriver $(VIMS_793C_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84410891; GNDSPD_PARAM 84410888;\
                       adap request:$(VIMS_793C_PAYLD_PAR_MCID); adap request:$(VIMS_793C_GNDSPD_PAR_MCID);

macro  vims793C0Setts  availDriver $(VIMS_793C0700_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84476427; GNDSPD_PARAM 84476424;\
                       adap request:$(VIMS_793C0700_PAYLD_PAR_MCID); adap request:$(VIMS_793C_GNDSPD_PAR_MCID);

macro  vims994DSetts   availDriver $(VIMS_994D_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84542013; GNDSPD_PARAM 84541972;\
                       adap request:$(VIMS_994D_PAYLD_PAR_MCID); adap request:$(VIMS_994D_GNDSPD_PAR_MCID);

macro  vims793DSetts   availDriver $(VIMS_793D_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84607499; GNDSPD_PARAM 84607496;\
                       adap request:$(VIMS_793D_PAYLD_PAR_MCID); adap request:$(VIMS_793D_GNDSPD_PAR_MCID);

macro  vims797ASetts   availDriver $(VIMS_797A_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84673035; GNDSPD_PARAM 84673026;\
                       adap request:$(VIMS_797A_PAYLD_PAR_MCID); adap request:$(VIMS_797A_GNDSPD_PAR_MCID);

macro  vims994FSetts   availDriver $(VIMS_994F_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84804157; GNDSPD_PARAM 84804116;\
                       adap request:$(VIMS_994F_PAYLD_PAR_MCID); adap request:$(VIMS_994F_GNDSPD_PAR_MCID);

macro  vims797FSetts   availDriver $(VIMS_797F_DRIVER_ID); DIPPER_EVENT $(VIMS_DIPPER_EVT);\
                       PAYLOAD_PARAM 84869644; GNDSPD_PARAM 84869640;\
                       adap request:$(VIMS_797F_PAYLD_PAR_MCID); adap request:$(VIMS_797F_GNDSPD_PAR_MCID);

macro  plmGenSetts     availDriver $(PLM_GEN_DRIVER_ID); DIPPER_EVENT 33619968; PAYLOAD_PARAM 33619978;\
                       GNDSPD_PARAM 33619974; adap request:$(PLM_PAYLD_PAR_MCID); adap request:$(PLM_GNDSPD_PAR_MCID);

macro  checkDinInp     ne? $(Vsms digitals) none 'isDigInpAvail yes;getDigInputs'

macro  startAutoCycle  eq? $(hcadebug) 1 HCADBG "startAutoCycle" "";\
                       ne? $(availDriver) none ne? $(availDriver) $(PLM_GEN_DRIVER_ID) eq? $(sfnextact) Shovel autoFullOn yes;\
                       ne? $(availDriver) none ne? $(availDriver) $(PLM_GEN_DRIVER_ID) eq? $(sfnextact) Full autoFullOn yes;\
                       eq? $(sfnextact) Bkt autoBktOn yes;\
                       eq? $(sfnextact) Bucket autoBktOn yes;\
                       eq? $(sfnextact) Arrive autoArrvOn yes;\
                       eq? $(sfnextact) Assign autoAssignOn yes;\
                       eq? $(sfnextact) '' WinMgr after:$(CASE_RETRY_TIME):startAutoCycle;\
                       eq? $(autoBktOn) yes autoBucket;\
                       eq? $(autoFullOn) yes autoFull;\
                       eq? $(autoArrvOn) yes eq? $(isDigInpAvail) yes updateDigInputs;\
                       eq? $(autoAssignOn) yes eq? $(isDigInpAvail) yes updateDigInputs;

macro stopAutoCycle    availDriver none;\
                       isDigInpAvail no;\
                       autoBktOn no;\
                       autoArrvOn no;\
                       autoAssignOn no;\
                       autoFullOn no;\
                       autoFullAssignOn no;\
                       hcaInit 0;

######################################
# Haul-Cycle Automation Cases
######################################

out    VS-GCEVENT        0x0774 l?f	ne? $(availDriver) none checkEventId

macro  checkEventId    eq? $(hcadebug) 1 HCADBG "checkEventId-" "event:$1";\
                       eq? $1 $(DIPPER_EVENT) dipperRcv;\
                       eq? $1 $(PLM_RUNWLOAD_EVENT) plmRunWLoadRcv;\
                       eq? $1 $(VIMS_BDYUP_ACT_EVT) vimsBdyActRcv;\
                       eq? $1 $(VIMS_BDYUP_INA_EVT) vimsBdyInacRcv;\
                       eq? $1 $(PLM_DUMP_EVENT) plmDumpAct;\
                       eq? $1 $(PLM_DUMPING_EVENT) HandleDumpingEvt;\
                       eq? $1 $(PLM_RUNNOLOAD_EVT) HandleRunNoLoadEvt;
					   
macro HandleDumpingEvt	plmRunNoLoad no;plmRunWLdEvtRcv no;plmDumpingEvtRcv yes;plmDumpAct
macro HandleRunNoLoadEvt	plmDumpingEvtRcv no;plmRunWLdEvtRcv no;plmRunNoLoad yes;plmDumpAct

macro  dipperRcv       eq? $(hcadebug) 1 HCADBG "dipperRcv-" "nextact:$(sfnextact)";\
                       eq? $(intfAutoArrv) yes eq? $(commstat) yes eq? $(sfnextloc) shovel eq? $(sfnextact) Arrive HCA_case $(CONN_ARR_SHOV);\
                       eq? $(intfAutoArrv) yes eq? $(commstat) no eq? $(sfnextloc) shovel eq? $(sfnextact) Arrive HCA_case $(ARR_SHOV);\
                       eq? $(commstat) yes eq? $(sfnextact) Bkt HCA_case $(CONN_BKT_INTERFACE);\
                       eq? $(commstat) yes eq? $(sfnextact) Bucket HCA_case $(CONN_BKT_INTERFACE);\
                       eq? $(commstat) no eq? $(sfnextact) Bkt HCA_case $(BKT_INTERFACE);\
                       eq? $(commstat) no eq? $(sfnextact) Bucket HCA_case $(BKT_INTERFACE);\
                       dipperEvtRcv yes;\
                       eq? $(HCA_case) $(CONN_ARR_SHOV) checkLocType;\
                       eq? $(HCA_case) $(ARR_SHOV) checkLocType;\
                       eq? $(HCA_case) $(CONN_BKT_INTERFACE) checkPayload;\
                       eq? $(HCA_case) $(BKT_INTERFACE) checkPayload;\
                       eq? $(sfnextloc) dump dipperEvtRcv no;\
                       eq? $(dipperEvtRcv) yes WinMgr after:$(CASE_RETRY_TIME):dipperRcv;

macro  plmRunWLoadRcv  plmDumpingEvtRcv no;plmRunNoLoad no;plmRunWLdEvtRcv yes;\
                       eq? $(commstat) yes HCA_case $(CONN_FULL_PLM);eq? $(commstat) no HCA_case $(FULL_PLM);\
                       eq? $(sfnextact) Full checkLocType;\
                       eq? $(sfnextact) Shovel checkLocType;\
                       ne? $(sfnextact) Full ne? $(sfnextact) Shovel plmRunWLdEvtRcv no;\
                       eq? $(plmRunWLdEvtRcv) yes WinMgr after:$(CASE_RETRY_TIME):plmRunWLoadRcv;

macro  vimsBdyActRcv   vimsBdyUpActEvtRcv yes; eq? $(commstat) yes HCA_case $(CONN_ARR_DUMP_VIMS);\
                       eq? $(commstat) no HCA_case $(ARR_DUMP_VIMS); checkLocType;\
                       eq? $(vimsBdyUpActEvtRcv) yes WinMgr after:$(CASE_RETRY_TIME):vimsBdyActRcv;

macro  vimsBdyInacRcv  vimsBdyUpInaEvtRcv yes; eq? $(commstat) yes HCA_case $(CONN_ASSIGN_VIMS);\
                       eq? $(commstat) no HCA_case $(ASSIGN_VIMS); checkDirTravel$(hcaSimOn);\
                       eq? $(vimsBdyUpInaEvtRcv) yes WinMgr after:$(CASE_RETRY_TIME):vimsBdyInacRcv;

macro  plmDumpAct      plmDumpEvtRcv yes;\
                       eq? $(plmRunNoLoad) yes eq? $(commstat) yes HCA_case $(CONN_ASSIGN_PLM);\
                       eq? $(plmRunNoLoad) yes eq? $(commstat) no HCA_case $(ASSIGN_PLM);\
                       eq? $(plmDumpingEvtRcv) yes eq? $(commstat) yes HCA_case $(CONN_ARR_DUMP_PLM);\
                       eq? $(plmDumpingEvtRcv) yes eq? $(commstat) no HCA_case $(ARR_DUMP_PLM);\
                       eq? $(plmDumpingEvtRcv) yes eq? $(hcadebug) 1 HCADBG "plmDumpAct-Dumping" "HCA_case:$(HCA_case)";\
                       eq? $(plmRunNoLoad) yes eq? $(hcadebug) 1 HCADBG "plmDumpAct-RunNoLoad" "HCA_case:$(HCA_case)";\
                       eq? $(HCA_case) $(CONN_ASSIGN_PLM) eq? $(sfnextact) Assign checkLocType;\
                       eq? $(HCA_case) $(ASSIGN_PLM) eq? $(sfnextact) Assign checkLocType;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_PLM) eq? $(sfnextact) Arrive eq? $(sfnextloc) dump checkLocType;\
                       eq? $(HCA_case) $(ARR_DUMP_PLM) eq? $(sfnextact) Arrive eq? $(sfnextloc) dump checkLocType;

macro  checkPayload    eq? $(hcaSimOn) 0 payload $(adap paramVal:$(PAYLOAD_PARAM)); eq? $(hcaSimOn) 1 payload $(sim_payload);\
                       ne? $(payload) N/A eq? $(max $(payload) $(MIN_PAYLOAD)) $(payload) checkNxtAct;

macro  checkNxtAct     eq? $(hcadebug) 1 HCADBG "checkNxtAct-" "nxtact:$(sfnextact)";\
                       eq? $(sfnextact) Bkt checkVelocity;\
                       eq? $(sfnextact) Bucket checkVelocity;\
                       eq? $(sfnextact) Shovel checkLocType;\
                       eq? $(sfnextact) Full checkLocType;\
                       eq? $(sfnextact) Arrive checkLocType;\
                       eq? $(sfnextact) Assign eq? $(HCA_case) $(CONN_ASSIGN_DIN) hcaAssign;\
                       eq? $(sfnextact) Assign eq? $(HCA_case) $(ASSIGN_DIN) hcaAssign;

macro  hcaAssign       eq? $(hcadebug) 1 HCADBG "hcaAssign-" "HCA_case:$(HCA_case) state:$(state)";\
                       eq? $(HCA_case) $(CONN_ASSIGN) eq? $(state) 10 okToSendDepart yes;\
                       eq? $(HCA_case) $(CONN_ASSIGN) eq? $(state) 2 ASSIGN -1;\
                       ne? $(HCA_case) $(CONN_ASSIGN) ASSIGN -1;\
                       hcaAfterAssign;

macro  hcaAfterAssign  autoAssignOn no; vimsBdyUpInaEvtRcv no; autoFullAssignOn no; dinSwitchActive no;\
                       plmDumpEvtRcv no; plmRunNoLoad no; gpsArriveRcv no; HCA_case $(INVALID_CASE);

macro  checkVelocity   eq? $(hcadebug) 1 HCADBG "checkVelocity-" "HCA_case:$(HCA_case)";\
                       isVelLessThanOne no; isVelGreatThanOne no;\
                       eq? $(hcaSimOn) 0 velocity $(GpsTruck velocity); eq? $(hcaSimOn) 1 velocity $(sim_velocity);\
                       eq? $(hcadebug) 1 HCADBG "velocity" "$(velocity)";\
                       eq? $(min $(velocity) $(MIN_VELOCITY)) $(velocity) isVelLessThanOne yes;\
                       eq? $(max $(velocity) $(MIN_VELOCITY)) $(velocity) isVelGreatThanOne yes;\
                       eq? $(HCA_case) $(CONN_BKT_INTERFACE) eq? $(isVelLessThanOne) yes hcaLoad;\
                       eq? $(HCA_case) $(BKT_INTERFACE) eq? $(isVelLessThanOne) yes hcaLoad;\
                       eq? $(HCA_case) $(CONN_FULL) eq? $(isVelGreatThanOne) yes hcaFull;\
                       eq? $(HCA_case) $(HCA_FULL) eq? $(isVelGreatThanOne) yes checkLocType;\
                       eq? $(HCA_case) $(CONN_ASSIGN) eq? $(isVelGreatThanOne) yes hcaAssign;\
                       eq? $(HCA_case) $(HCA_ASSIGN) eq? $(isVelGreatThanOne) yes hcaAssign;\
                       eq? $(isVelLessThanOne) yes ne? $(HCA_case) $(CONN_BKT_INTERFACE) ne? $(HCA_case) $(BKT_INTERFACE) ne? $(HCA_case) $(CONN_FULL) ne? $(HCA_case) $(HCA_FULL) ne? $(HCA_case) $(CONN_ASSIGN) ne? $(HCA_case) $(HCA_ASSIGN) checkLocType;

macro  checkDistance   eq? $(hcaSimOn) 0 distance $(GpsTruck distance:$(shovelPos)); eq? $(hcaSimOn) 1 distance $(sim_distance);\
                       eq? $(hcadebug) 1 HCADBG "checkDistance-" "dist:$(distance)";\
                       eq? $(min $(distance) $(MIN_DISTANCE)) $(distance) checkNxtAct;

macro  checkLocType    eq? $(hcadebug) 1 HCADBG "checkLocType-" "LDloc_type:$(LDloc_type) HCA_case:$(HCA_case)";\
                       eq? $(HCA_case) $(CONN_BKT) eq? $(LDloc_type) $(UNIT_BLAST) getLocation;\
                       eq? $(HCA_case) $(CONN_BKT) eq? $(LDloc_type) $(UNIT_SHOVEL) getLocation;\
                       eq? $(HCA_case) $(HCA_BKT) eq? $(LDloc_type) $(UNIT_BLAST) getLocation;\
                       eq? $(HCA_case) $(HCA_BKT) eq? $(LDloc_type) $(UNIT_SHOVEL) getLocation;\
                       eq? $(HCA_case) $(CONN_FULL_VIMS) eq? $(LDloc_type) $(UNIT_BLAST) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_FULL_VIMS) eq? $(LDloc_type) $(UNIT_SHOVEL) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_FULL_VIMS) eq? $(LDloc_type) $(UNIT_STOCKPILE) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_FULL_VIMS) eq? $(sfnextloc) dump checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(FULL_VIMS) eq? $(LDloc_type) $(UNIT_BLAST) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(FULL_VIMS) eq? $(LDloc_type) $(UNIT_SHOVEL) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(FULL_VIMS) eq? $(LDloc_type) $(UNIT_STOCKPILE) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(FULL_VIMS) eq? $(sfnextloc) dump checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_FULL_PLM) eq? $(LDloc_type) $(UNIT_BLAST) checkGrdSpeed;\
                       eq? $(HCA_case) $(CONN_FULL_PLM) eq? $(LDloc_type) $(UNIT_SHOVEL) checkGrdSpeed;\
                       eq? $(HCA_case) $(CONN_FULL_PLM) eq? $(LDloc_type) $(UNIT_STOCKPILE) checkGrdSpeed;\
                       eq? $(HCA_case) $(CONN_FULL_PLM) eq? $(sfnextloc) shovel checkGrdSpeed;\
                       eq? $(HCA_case) $(FULL_PLM) eq? $(LDloc_type) $(UNIT_BLAST) checkGrdSpeed;\
                       eq? $(HCA_case) $(FULL_PLM) eq? $(LDloc_type) $(UNIT_SHOVEL) checkGrdSpeed;\
                       eq? $(HCA_case) $(FULL_PLM) eq? $(LDloc_type) $(UNIT_STOCKPILE) checkGrdSpeed;\
                       eq? $(HCA_case) $(FULL_PLM) eq? $(sfnextloc) shovel checkGrdSpeed;\
                       eq? $(HCA_case) $(CONN_FULL) eq? $(LDloc_type) $(UNIT_BLAST) checkVelocity;\
                       eq? $(HCA_case) $(CONN_FULL) eq? $(LDloc_type) $(UNIT_SHOVEL) checkVelocity;\
                       eq? $(HCA_case) $(CONN_FULL) eq? $(LDloc_type) $(UNIT_STOCKPILE) checkVelocity;\
                       eq? $(HCA_case) $(HCA_FULL) eq? $(LDloc_type) $(UNIT_BLAST) hcaFull;\
                       eq? $(HCA_case) $(HCA_FULL) eq? $(LDloc_type) $(UNIT_SHOVEL) hcaFull;\
                       eq? $(HCA_case) $(HCA_FULL) eq? $(LDloc_type) $(UNIT_STOCKPILE) hcaFull;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? $(LDloc_type) $(UNIT_DUMP) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? $(LDloc_type) $(UNIT_CRUSHER) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? $(sfnextloc) dump checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? $(LDloc_type) $(UNIT_DUMP) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? $(LDloc_type) $(UNIT_CRUSHER) checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? $(sfnextloc) dump checkDirTravel$(hcaSimOn);\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_PLM) eq? $(LDloc_type) $(UNIT_DUMP) hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_PLM) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_PLM) eq? $(sfnextloc) dump hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_PLM) eq? $(LDloc_type) $(UNIT_DUMP) hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_PLM) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_PLM) eq? $(sfnextloc) dump hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_DIN) eq? $(LDloc_type) $(UNIT_DUMP) hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_DIN) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_DIN) eq? $(sfnextloc) dump hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_DIN) eq? $(LDloc_type) $(UNIT_DUMP) hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_DIN) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_DIN) eq? $(sfnextloc) dump hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP) eq? $(LDloc_type) $(UNIT_DUMP) hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP) eq? $(LDloc_type) $(UNIT_DUMP) hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaArrive;\
                       eq? $(HCA_case) $(CONN_ASSIGN_PLM) eq? $(LDloc_type) $(UNIT_DUMP) hcaAssign;\
                       eq? $(HCA_case) $(CONN_ASSIGN_PLM) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaAssign;\
                       eq? $(HCA_case) $(ASSIGN_PLM) eq? $(LDloc_type) $(UNIT_DUMP) hcaAssign;\
                       eq? $(HCA_case) $(ASSIGN_PLM) eq? $(LDloc_type) $(UNIT_CRUSHER) hcaAssign;\
                       eq? $(HCA_case) $(CONN_ARR_SHOV) eq? $(LDloc_type) $(UNIT_BLAST) hcaArrvShov;\
                       eq? $(HCA_case) $(CONN_ARR_SHOV) eq? $(LDloc_type) $(UNIT_SHOVEL) hcaArrvShov;\
                       eq? $(HCA_case) $(CONN_ARR_SHOV) eq? $(LDloc_type) $(UNIT_STOCKPILE) hcaArrvShov;\
                       eq? $(HCA_case) $(CONN_ARR_SHOV) eq? $(sfnextloc) shovel hcaArrvShov;\
                       eq? $(HCA_case) $(ARR_SHOV) eq? $(LDloc_type) $(UNIT_BLAST) hcaArrvShov;\
                       eq? $(HCA_case) $(ARR_SHOV) eq? $(LDloc_type) $(UNIT_SHOVEL) hcaArrvShov;\
                       eq? $(HCA_case) $(ARR_SHOV) eq? $(LDloc_type) $(UNIT_STOCKPILE) hcaArrvShov;\
                       eq? $(HCA_case) $(ARR_SHOV) eq? $(sfnextloc) shovel hcaArrvShov;


macro  hcaArrvShov     eq? $(sfnextloc) shovel LDloc_type $(UNIT_SHOVEL);\
                       eq? $(commstat) yes eq? $(loc_auto) 0 ARRIVE -1;\
                       eq? $(commstat) no ARRIVE -1;\
                       hcaAfterArrvSh;

macro  hcaAfterArrvSh  autoArrvOn no; HCA_case $(INVALID_CASE);\
                       autoBktOn yes; autoBucket;

macro  hcaFull         eq? $(hcadebug) 1 HCADBG "hcaFull" "";\
                       eq? $(commstat) yes eq? $(availDriver) none okToSendDepart yes;\
                       ne? $(availDriver) none FULL -1;\
                       eq? $(commstat) no eq? $(availDriver) none FULL -1;\
                       hcaAfterFull;

macro  hcaAfterFull    autoBktOn no; autoFullOn no; autoFullAssignOn no; plmRunWLdEvtRcv no; shovNxtQTrk '';\
                       gpsArriveRcv no; shovelStat $(STATUS_NONE);\
                       eq? $(isDigInpAvail) yes autoArrvOn yes; eq? $(autoArrvOn) yes updateDigInputs;\
                       HCA_case $(INVALID_CASE);

macro  hcaArrive       eq? $(hcadebug) 1 HCADBG "hcaArrive-" "NextLoc:$(sfnextloc)";\
                       eq? $(sfnextloc) dump LDloc_type $(UNIT_DUMP);\
                       eq? $(sfnextloc) shovel LDloc_type $(UNIT_SHOVEL);\
                       eq? $(commstat) yes eq? $(gpsArriveRcv) yes eq? $(loc_auto) 0 ARRIVE -1;\
                       eq? $(gpsArriveRcv) no ARRIVE -1;\
                       hcaAfterArrive;

macro  hcaAfterArrive  eq? $(hcadebug) 1 HCADBG "hcaAfterArrive" "";\
                       autoArrvOn no; autoAssignOn yes;\
                       eq? $(isDigInpAvail) yes updateDigInputs;\
                       vimsBdyUpActEvtRcv no; plmDumpEvtRcv no; plmDumpingEvtRcv no; HCA_case $(INVALID_CASE);


macro  checkTruckInQ   eq? $(shovNxtQTrk) $(OMS host) ne? $(shovelPos) none checkDistance;

macro  getLocation     foreach $(loc); do truck_loc \$2; foreach $(truck_loc); do truck_loc \$2; checkLocNDest

macro  checkLocNDest   eq? $(truck_loc) $(dest) checkEqmtStat;

macro  checkEqmtStat   eq? $(HCA_case) $(CONN_BKT) eq? $(shovelStat) $(STATUS_READY) hcaLoad;\
                       eq? $(HCA_case) $(HCA_BKT) hcaLoad;

macro  hcaLoad         eq? $(hcadebug) 1 HCADBG "hcaLoad" "";\
                       ne? $(state) 17 ne? $(state) 8 LOAD -1; hcaAfterLoad;

macro  hcaAfterLoad    dipperEvtRcv no; autoBktOn no; HCA_case $(INVALID_CASE); shovNxtQTrk ''; shovelStat $(STATUS_NONE);\
                       distance ''; ne? $(availDriver) none ne? $(availDriver) $(PLM_GEN_DRIVER_ID) autoFullOn yes;\
                       shovelPos none; eq? $(autoFullOn) yes WinMgr after:$(CASE_RETRY_TIME):autoFull;

macro  autoFull        eq? $(hcadebug) 1 HCADBG "autoFull" "HCA_case:$(HCA_case)";\
                       eq? $(HCA_case) $(INVALID_CASE) eq? $(commstat) yes HCA_case $(CONN_FULL_VIMS);\
                       eq? $(HCA_case) $(INVALID_CASE) eq? $(commstat) no HCA_case $(FULL_VIMS);\
                       checkNxtAct;\
                       eq? $(HCA_case) $(CONN_FULL_VIMS) eq? $(autoFullOn) yes WinMgr after:$(CASE_RETRY_TIME):autoFull;\
                       eq? $(HCA_case) $(FULL_VIMS) eq? $(autoFullOn) yes WinMgr after:$(CASE_RETRY_TIME):autoFull;

macro  checkDirTravel0 eq? $(GpsTruck dirTravel) forward checkGrdSpeed;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? "$(GpsTruck dirTravel)" "unknown" hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? "$(GpsTruck dirTravel)" "neutral" hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? "$(GpsTruck dirTravel)" "unknown" hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? "$(GpsTruck dirTravel)" "neutral" hcaArrive;

macro  checkDirTravel1 eq? $(sim_dirTravel) forward checkGrdSpeed;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? "$(sim_dirTravel)" "unknown" hcaArrive;\
                       eq? $(HCA_case) $(CONN_ARR_DUMP_VIMS) eq? "$(sim_dirTravel)" "neutral" hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? "$(sim_dirTravel)" "unknown" hcaArrive;\
                       eq? $(HCA_case) $(ARR_DUMP_VIMS) eq? "$(sim_dirTravel)" "neutral" hcaArrive;

macro  checkGrdSpeed   eq? $(hcaSimOn) 0 gnd_speed $(adap paramVal:$(GNDSPD_PARAM)); eq? $(hcaSimOn) 1 gnd_speed $(sim_gnd_speed);\
                       ne? $(payload) N/A eq? $(max $(gnd_speed) $(MIN_VELOCITY)) $(gnd_speed) executeAction;

macro  executeAction   eq? $(HCA_case) $(CONN_FULL_VIMS) hcaFull;\
                       eq? $(HCA_case) $(FULL_VIMS) hcaFull;\
                       eq? $(HCA_case) $(CONN_FULL_PLM) hcaFull;\
                       eq? $(HCA_case) $(FULL_PLM) hcaFull;\
                       eq? $(HCA_case) $(CONN_ASSIGN_VIMS) hcaAssign;\
                       eq? $(HCA_case) $(ASSIGN_VIMS) hcaAssign;

out    GPS-DEPART      0x01a7  ddd    depart_bcn $1; WinMgr after:1:setLDLoc; eq? $(commstat) no eq? $(hcaInit) 1 autoFullAssign;\
                       sendto up spooled;

macro  autoFullAssign  eq? $(hcadebug) 1 HCADBG "autoFullAssign-" "DEPART BCN:$(depart_bcn) nxtact:$(sfnextact) LDloc_type:$(LDloc_type)";\
                       autoFullAssignOn yes; eq? $(sfnextact) Shovel checkBeacon;\
                       eq? $(sfnextact) Full checkBeacon;\
                       eq? $(sfnextact) Assign eq? $(commstat) yes HCA_case $(CONN_ASSIGN);\
                       eq? $(sfnextact) Assign eq? $(commstat) no HCA_case $(HCA_ASSIGN);\
                       eq? $(HCA_case) $(CONN_ASSIGN) checkVelocity;\
                       eq? $(HCA_case) $(HCA_ASSIGN) checkVelocity;\
                       eq? $(hca_safemode) 1 ne? $(sfnextact) Shovel ne? $(sfnextact) Full ne? $(sfnextact) Assign autoFullAssignOff
                       eq? $(hcadebug) 1 HCADBG "autoFullAssignOn" "$(autoFullAssignOn)";\
                       eq? $(hcadebug) 1 HCADBG "okToSendDepart" "$(okToSendDepart)\n";\
                       eq? $(autoFullAssignOn) yes WinMgr after:$(CASE_RETRY_TIME):autoFullAssign;

macro  autoFullAssignOff eq? $(hcadebug) 1 HCADBG "autoFullAssign" "turned off"; autoFullAssignOn no

macro  checkBeacon     eq? $(commstat) yes eq? $(shovelBcn) '' EQ-REQ "hcaEqmtInfo";\
                       eq? $(commstat) yes HCA_case $(CONN_FULL);\
                       eq? $(commstat) no HCA_case $(HCA_FULL);\
                       eq? $(HCA_case) $(CONN_FULL) eq? $(depart_bcn) $(shovelBcn) autoFull;\
                       eq? $(HCA_case) $(HCA_FULL) eq? $(locid.$(depart_bcn)) $(last_loadloc) checkVelocity;

macro  OLDupdateDigInputs okToCheckDin no; getDigInputs; lastDigInp0 $(digInp0); okToCheckDin yes;\
                       WinMgr after:$(CASE_RETRY_TIME):getDigInputs;

macro  updateDigInputs lastDigInp0 $(digInp0); okToCheckDin yes; getDigInputs

macro  checkDigInputs  HCA_case $(INVALID_CASE);\
                       eq? $(digInp0) $(DIGITAL_INPUT_ON) eq? $(lastDigInp0) $(DIGITAL_INPUT_OFF) dinSwitchActive yes;\
                       eq? $(hcadebug) 1 HCADBG "checkDigInputs:" "$(digInp0),$(lastDigInp0),$(dinSwitchActive)";\
                       eq? $(commstat) yes eq? $(digInp0) $(DIGITAL_INPUT_ON) eq? $(digInp0) $(lastDigInp0) HCA_case $(CONN_ARR_DUMP_DIN);\
                       eq? $(commstat) no eq? $(digInp0) $(DIGITAL_INPUT_ON) eq? $(digInp0) $(lastDigInp0) HCA_case $(ARR_DUMP_DIN);\
                       eq? $(commstat) yes eq? $(digInp0) $(DIGITAL_INPUT_OFF) eq? $(dinSwitchActive) yes HCA_case $(CONN_ASSIGN_DIN);\
                       eq? $(commstat) no eq? $(digInp0) $(DIGITAL_INPUT_OFF) eq? $(dinSwitchActive) yes HCA_case $(ASSIGN_DIN);\
                       ne? $(HCA_case) $(INVALID_CASE) checkNxtAct;\
                       eq? $(autoArrvOn) yes WinMgr after:$(CASE_RETRY_TIME):updateDigInputs;\
                       eq? $(autoAssignOn) yes WinMgr after:$(CASE_RETRY_TIME):updateDigInputs;

macro  getDigInputs    foreach "$(Vsms digitals)"; do 'digInp\$1 \$2';\
                       eq? $(okToCheckDin) yes checkDigInputs;

macro  setLastDigInp   foreach "$(Vsms digitals)"; do 'lastDigInp\$1 $(digInp\$1)'

out    GPS-ARRIVE      0x01a6  ddd?dd  last_beacon $1; LDloc_valid 0; WinMgr after:1:HandleBcnArr;gpsArriveRcv yes;\
                       eq? $(hcadebug) 1 HCADBG "GPS-ARRIVE" "at $(last_beacon)";\
                       WinMgr after:1:setLDLoc; eq? $(hcaInit) 1 autoArrive; sendto up spooled

macro  setLDLoc	       LDloc_type $(UNIT_NONE); eq? $(locunit.$(last_beacon)) $(UNIT_SHOVEL) LDloc_type $(UNIT_SHOVEL);\
                       eq? $(locunit.$(last_beacon)) $(UNIT_DUMP) LDloc_type $(UNIT_DUMP);\
                       eq? $(locunit.$(last_beacon)) $(UNIT_CRUSHER) LDloc_type $(UNIT_CRUSHER);\
                       eq? $(locunit.$(last_beacon)) $(UNIT_STOCKPILE) LDloc_type $(UNIT_STOCKPILE);\
                       eq? $(locunit.$(last_beacon)) $(UNIT_BLAST) LDloc_type $(UNIT_BLAST);\
                       LDloc_valid 1

macro  autoArrive      eq? $(hcadebug) 1 HCADBG "autoArrive" "";\                       
                       ne? $(sfnextact) Arrive HCA_case $(INVALID_CASE);\
                       eq? $(sfnextact) Arrive autoArrvOn yes;\
                       eq? $(LDloc_type) $(UNIT_DUMP) eq? $(commstat) yes HCA_case $(CONN_ARR_DUMP);\
                       eq? $(LDloc_type) $(UNIT_DUMP) eq? $(commstat) no HCA_case $(ARR_DUMP);\
                       eq? $(LDloc_type) $(UNIT_CRUSHER) eq? $(commstat) yes HCA_case $(CONN_ARR_DUMP);\
                       eq? $(LDloc_type) $(UNIT_CRUSHER) eq? $(commstat) no HCA_case $(ARR_DUMP);\
                       eq? $(LDloc_type) $(UNIT_BLAST) eq? $(commstat) yes HCA_case $(CONN_ARR_SHOV);\
                       eq? $(LDloc_type) $(UNIT_BLAST) eq? $(commstat) no HCA_case $(ARR_SHOV);\
                       eq? $(LDloc_type) $(UNIT_SHOVEL) eq? $(commstat) yes HCA_case $(CONN_ARR_SHOV);\
                       eq? $(LDloc_type) $(UNIT_SHOVEL) eq? $(commstat) no HCA_case $(ARR_SHOV);\
                       eq? $(LDloc_type) $(UNIT_STOCKPILE) eq? $(commstat) yes HCA_case $(CONN_ARR_SHOV);\
                       eq? $(LDloc_type) $(UNIT_STOCKPILE) eq? $(commstat) no HCA_case $(ARR_SHOV);\
                       eq? $(LDloc_valid) 0 HCA_case $(INVALID_CASE);\
                       eq? $(hcadebug) 1 HCADBG "LDloc_type-$(LDloc_type)" "HCA_case-$(HCA_case)";\
                       eq? $(HCA_case) $(CONN_ARR_DUMP) checkVelocity;\
                       eq? $(HCA_case) $(ARR_DUMP) checkVelocity;\
                       eq? $(HCA_case) $(CONN_ARR_SHOV) checkVelocity;\
                       eq? $(HCA_case) $(ARR_SHOV) checkVelocity;\
                       eq? $(autoArrvOn) yes WinMgr after:$(CASE_RETRY_TIME):autoArrive;

macro  autoBucket      eq? $(commstat) yes EQ-REQ "hcaEqmtInfo";\
                       eq? $(commstat) yes HCA_case $(CONN_BKT);\
                       eq? $(commstat) no HCA_case $(HCA_BKT);\
                       eq? $(HCA_case) $(CONN_BKT) checkTruckInQ;\
                       eq? $(HCA_case) $(HCA_BKT) ne? $(shovelPos) none checkDistance;\
                       eq? $(autoBktOn) yes WinMgr after:$(CASE_RETRY_TIME):autoBucket;

/* we don't redefined KSTATE2 anymore. Now use new feature that allows us to add extra
 * actions to generic rpc defs.
in     KSTATE2 0x32    b?ssssss state $1; loc $2; next $3; w0.Icon icon:$(icon.$1); w0.v1 label:$2;\
                                      w0.v2 label:$3;w0.v3 label:$4; w0.Text write:$5;w0.Text write:\n;\
                                      WinMgr audio:$7; eq? $1 6 setloadloc; eq? $1 9 setdumploc; setnextact;\
                                      setbeans; eq? $(hcaInit) 1 updateHCAAct;
 */
macro HCA.kstate_extra eq? $(hcaInit) 1 updateHCAAct;

macro  updateHCAAct    eq? $(state) 17 hcaAfterLoad;\
                       eq? $(state) 9 hcaAfterFull;\
                       eq? $(state) 10 hcaAfterArrive;\
                       eq? $(state) 8 hcaAfterLoad;\
                       eq? $(state) 2 hcaAfterArrive;\
                       eq? $(state) 6 hcaAfterAssign;\
                       eq? $(state) 7 hcaAfterArrvSh;\
                       eq? $(state) 4 stopHcaAction;\
                       eq? $(state) 3 stopHcaAction;\
                       eq? $(state) 0 stopHcaAction;

macro  stopHcaAction   eq? $(sfnextact) Bkt autoBktOn no;\
                       eq? $(sfnextact) Bucket autoBktOn no;\
                       eq? $(sfnextact) Shovel autoFullOn no;\
                       eq? $(sfnextact) Full autoFullOn no;\
                       eq? $(sfnextact) Arrive autoArrvOn no;\
                       eq? $(sfnextact) Assign autoAssignOn no;

macro  kpArrive        eq? $(state) 6 hcaAfterArrvSh;\
                       eq? $(state) 9 hcaAfterArrive;\
					   eq? $(sfnextloc) dump LDloc_type $(UNIT_DUMP);\
					   eq? $(sfnextloc) shovel LDloc_type $(UNIT_SHOVEL);\
                       dest ''; eq? $(sfnextloc) dump arrivedatdump; eq? $(sfnextloc) shovel arrivedatshovel; ARRIVE; KBEEP 1;

macro  kpAssign        dest ''; eq? $(sfnextloc) dump assignedatshovel; eq? $(sfnextloc) shovel assignedatdump; ASSIGN; KBEEP 1;\
                       hcaAfterAssign;

macro  kpLoad          LOAD; eq? $(hcaInit) 1 hcaAfterLoad;

macro  kpTrkFull       eq? "$(trkfull)" "n" notavail;ne? "$(trkfull)" "n" doTrkFull; hcaAfterFull;

in     EQMTINFO 0x078d sddlls?sss procEqmtInfo

macro  procEqmtInfo    eq? $(hcadebug) 1 HCADBG "EQMTINFO" "$1,$(dest),$2,$3,$4,$5,$6"; eq? $1 $(dest) updateShovInfo;

macro  updateShovInfo  shovelStat $2; shovelBcn $3; shovelPos $4,$5; shovNxtQTrk $6;

macro  clrLocInfo      loc_id "Unknown"; eq? $(updateFromCentral) 0 loc_type "Unknown";loc_unit 0;loc_stat "Unknown";loc_auto 0

in     KSTATE   0x41   b?sss  state $1;loc $2;w0.Icon icon:$(icon.$1);w0.v1 label:$(msg.$1);w0.v2 label:$3;\
                              Rpc_arg1 $1;rpc_arg2 $2;rpc_arg3 $3;rpc_arg4 $4;\
                              eq? $1 6 setloadloc; eq? $1 9 setdumploc; setnextact; eq? $(hcaInit) 1 updateHCAAct;

#endif
