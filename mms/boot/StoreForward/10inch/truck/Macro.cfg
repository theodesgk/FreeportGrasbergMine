symbol sfsync	    1
symbol mnasnok     y
symbol trkfull     y
symbol oper_logoff  0
macro	HandleSFInfo	ne? $2 "unknown" last_loadloc $2;\
                        ne? $3 "unknown" last_dumploc $3;\
						eq? $1 7 setloadloc;\
						eq? $1 8 setdumploc;\
						nextactdesc $4;sfnextact $5;setbeans
macro	setloadloc	sfnextloc shovel;dest $(last_loadloc)
macro	setdumploc	sfnextloc dump;dest $(last_dumploc)
macro	Handleks3arg6	last_stat $(curr_stat);last_rsn $(curr_rcode);nextactdesc $6
macro	SF.kstate_extra	sfprevact $(sfnextact);sfnextact $(SF_NONPROD);\
                        eq? $(state) 0 'sfnextact $(sfprevact)';\
                        eq? $(state) 1 'sfnextact $(sfprevact)';\
                        eq? $(state) 2 'sfnextact $(SF_ASSIGN);setActMsg';\
                        eq? $(state) 3 'sfnextact $(sfprevact)';\
                        eq? $(state) 4 'sfnextact $(sfprevact)';\
                        eq? $(state) 5 'sfnextact $(sfprevact)';\
			eq? $(state) 6 'sfnextact $(SF_ARRIVE);setActMsg;isLoaded no';\
			eq? $(state) 7 'sfnextact $(SF_LOAD);setActMsg;isLoaded no';\
			eq? $(state) 8 'sfnextact $(SF_FULL);setActMsg;isLoaded no';\
			eq? $(state) 9 'sfnextact $(SF_ARRIVE);setActMsg;isLoaded yes';\
			eq? $(state) 10 'sfnextact $(SF_ASSIGN);setActMsg;isLoaded yes';\
			eq? $(state) 11 'sfnextact $(SF_ARRIVE);setActMsg;isLoaded yes';\
			eq? $(state) 12 'sfnextact $(SF_ASSIGN);setActMsg;isLoaded yes';\
			eq? $(state) 13 'sfnextact $(SF_ASSIGN);setActMsg;isLoaded yes';\
			eq? $(state) 14 'sfnextact $(SF_FULL);setActMsg;isLoaded no';\
			eq? $(state) 15 'sfnextact $(SF_LOAD);setActMsg;isLoaded no';\
			eq? $(state) 16 'sfnextact $(SF_FULL);setActMsg;isLoaded no';\
                        eq? $(state) 17 'sfnextact $(SF_FULL);setActMsg;isLoaded no';
macro	setActMsg	NEXT_ACT$(sfnextact)_MSG $(rpc_arg3)	
					
macro  doActArrive doActHandle 0;dest '';\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) dump   arrivedatdump;\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) shovel arrivedatshovel;\
                   doActArriveStd
macro  doActAssign doActHandle 0;dest '';\
                   eq? $(doActHandle) 0 ne? $(state) 2 eq? $(sfnextloc) shovel   assignedatshovel;\
                   eq? $(doActHandle) 0 ne? $(state) 2 eq? $(sfnextloc) dump assignedatdump;\
                   doActAssignStd
macro	doActLoad  SFDATA "$(last_loadloc)" "$(last_dumploc)";doActLoadStd 
macro	asn2shv	   last_loadloc "$1";EQ-REQ "asn2shv" [ "" "$1" ]
macro	asn2loc    last_dumploc "$1";EQ-REQ "asn2loc" [ "" "$1" ]
macro	adjstbeans nocomm_lds:$(+ $(nocomm_lds) 1);UpdateBeans
macro	setBeanMsg	BeanMsg $(sfDumps)
macro	setNeedSfSync	needSfSync y
macro   checkRpc  eq? $(rpcReq) ASSIGN  doSFLogic;\
                  eq? $(rpcReq) LOAD    doSFLogic;\
                  eq? $(rpcReq) FULL    doSFLogic;\
                  eq? $(rpcReq) ARRIVE  doSFLogic;\
                  eq? $(rpcReq) DELAY   doSFLogic;\
                  eq? $(rpcReq) DOWN    doSFLogic;\
                  eq? $(rpcReq) READY   doSFLogic;\
                  eq? $(rpcReq) STANDBY doSFLogic;\
                  eq? $(rpcReq) LOGON   doSFLogic;\
                  eq? $(rpcReq) PRESTART doSFLogic;\
                  eq? $(rpcReq) GPS-ARRIVE doSFLogic;\
                  eq? $(rpcReq) RFID-ARRIVE doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) asn2shv doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) asn2loc doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) LocStat doSFLogic;\
		  eq? $(rpcReq) EQ-REQ eq? $(req) gpstagact doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) sf-sync setNeedSfSync;\
                  ne? $(rpcReq) KSTATE ne? $(rpcReq) RFID-ARRIVE ne? $(rpcReq) RFID-DEPART ne? $(rpcReq) GPS-ARRIVE ne? $(rpcReq) GPS-DEPART ne? $(rpcReq) SFDATA ne? $(rpcReq) ASSIGN ne? $(rpcReq) LOAD ne? $(rpcReq) FULL ne? $(rpcReq) ARRIVE ne? $(rpcReq) DELAY ne? $(rpcReq) DOWN ne? $(rpcReq) READY ne? $(rpcReq) STANDBY ne? $(rpcReq) LOGON ne? $(rpcReq) PRESTART ne? $(rpcReq) EQ-REQ ne? $(rpcReq) KBEEP MessageBox "$(NoCommActLbl)" "$(CommsErrorLbl)";\
                  eq? $(rpcReq) EQ-REQ  ne? $(req) sf-sync ne? $(req) asn2loc ne? $(req) asn2shv ne? $(req) psitemcomment ne? $(req) LocStat ne? $(req) gpstagact MessageBox "$(NoCommActLbl)" "$(CommsErrorLbl)";
macro   doSFLogic needSfSync y;\
                  eq? $(rpcReq) DELAY   dodelay;\
                  eq? $(rpcReq) DOWN    dodown;\
                  eq? $(rpcReq) READY   doready;\
                  eq? $(rpcReq) STANDBY dospare;\
                  eq? $(rpcReq) FULL    dofull;\
                  eq? $(rpcReq) LOAD    doload;\
                  eq? $(rpcReq) LOGON   dologon;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 6  arrive6;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 9  arrive9;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 2  eq? $(sfnextloc) shovel arrive6;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 2  eq? $(sfnextloc) dump arrive9;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 7  assign7;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 10 assign10;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) no assign10;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) yes assign7;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) unknown eq? $(sfnextloc) shovel assign10;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) unknown eq? $(sfnextloc) dump assign7;\
                  eq? $(rpcReq) PRESTART doprestart;\
                  eq? $(rpcReq) GPS-ARRIVE CheckAuto;\
                  eq? $(rpcReq) RFID-ARRIVE CheckAuto;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) asn2shv sfasn2shv;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) asn2loc sfasn2loc;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) LocStat sflocstat;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) gpstagact sfgpsact;
macro  sfgpsact		eq? $(reqact) 1 dodown;\
			eq? $(reqact) 2 doready;\
			eq? $(reqact) 3 dospare;\
			eq? $(reqact) 4 dodelay;\
			eq? $(reqact) 5 eq? $(state) 7 assign7;\
			eq? $(reqact) 5 eq? $(state) 10 assign10;\
			eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) no assign10;\
			eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) yes assign7;\
			eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) unknown eq? $(sfnextloc) shovel  assign10;\
			eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) unknown eq? $(sfnextloc) dump  assign7;\
			eq? $(reqact) 6 eq? $(state) 6 arrive6;\
			eq? $(reqact) 6 eq? $(state) 9 arrive9;\
			eq? $(reqact) 6 eq? $(state) 2 eq? $(sfnextloc) shovel arrive6;\
			eq? $(reqact) 6 eq? $(state) 2 eq? $(sfnextloc) dump arrive9;\
			eq? $(reqact) 7 doload;\
			eq? $(reqact) 12 dofull; 		
macro  arrive6          KSTATE 7  "$(sfarvMsg) $(last_loadloc)" "$(NEXT_ACT7_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";NoCommKS3;UpdateLoadDisp
macro  arrive9          KSTATE 10 "$(sfdmpMsg) $(last_dumploc)" "$(NEXT_ACT5_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";NoCommKS3;UpdateMatDisp
macro  assign7          setdumploc;KSTATE 9  "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";NoCommKS3
macro  assign10         setloadloc;clearfulltime;KSTATE 6  "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        adjstbeans;NoCommKS3;UpdateLoadDisp
macro  doload           KSTATE 8  "$(sfldMsg) $(last_loadloc)" "$(NEXT_ACT12_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";NoCommKS3;UpdateLoadDisp
macro  dofull           setdumploc;setfulltime;KSTATE 9  "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";NoCommKS3;UpdateMatDisp
macro  sfasn2shv        setloadloc;KSTATE 6  "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        sfnextloc shovel;\
                        sfnextact $(SF_ARRIVE);NoCommKS3
macro  sfasn2loc        setdumploc;KSTATE 9 "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        sfnextloc dump;\
                        sfnextact $(SF_ARRIVE);NoCommKS3
macro  arrivedatdump    dest $(last_dumploc);\
                        sfnextact $(SF_ASSIGN);\
                        doActHandle 1;\
                        SFDATA "$(last_loadloc)" "$(last_dumploc)"
macro  arrivedatshovel  dest $(last_loadloc);\
                        sfnextact $(SF_FULL);\
                        doActHandle 1
macro  assignedatdump   dest $(last_loadloc);\
                        sfnextact $(SF_ARRIVE);\
                        sfnextloc shovel;\
                        clearfulltime;\
                        doActHandle 1;
macro  assignedatshovel dest $(last_dumploc);\
                        sfnextact $(SF_ARRIVE);\
                        doActHandle 1;\
                        sfnextloc dump;
macro  dodelay          last_stat 4;last_rsn $(sfarg1);KSTATE 4 "$(stat4)" "$(NEXT_ACT2_MSG)"  "$(sfDumps)\n$(sfloads)" "" "" "";NoCommKS3
macro  doready          last_stat 2;last_rsn $(sfarg1);eq? $(sfnextloc) "" KSTATE 10 "$(stat2)" "$(NextLbl) $(sfUnknown)" "$(sfDumps)\n$(sfloads)" "" "";\
                        eq? $(sfnextact) $(SF_READY) sfnextact $(SF_ASSIGN);\
                        eq? $(sfnextact) $(SF_ASSIGN) eq? $(sfnextloc) dump KSTATE 10 "$(sfrdyMsg) $(last_dumploc)" "$(NEXT_ACT5_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        eq? $(sfnextact) $(SF_ASSIGN) eq? $(sfnextloc) shovel   KSTATE 8  "$(sfrdyMsg) $(last_loadloc)" "$(NEXT_ACT5_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        eq? $(sfnextact) $(SF_ARRIVE) eq? $(sfnextloc) shovel KSTATE 6  "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        eq? $(sfnextact) $(SF_ARRIVE) eq? $(sfnextloc) dump   KSTATE 9  "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        eq? $(sfnextact) $(SF_LOAD) KSTATE 7 "$(sfrdyMsg) $(last_loadloc)" "$(NEXT_ACT7_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        eq? $(sfnextact) $(SF_FULL) KSTATE 8 "$(sfldMsg) $(last_loadloc)" "$(NEXT_ACT12_MSG)" "$(sfDumps)\n$(sfloads)" "" "" "";\
                        eq? $(sfnextact) '' KSTATE 10 "$(stat2)" "$(NextLbl) $(sfUnknown)" "$(sfDumps)\n$(sfloads)" "" "";NoCommKS3
macro  dodown	last_stat 1;last_rsn $(sfarg1);eq? $(SF_DWN_LOGOFF) y curr_oper "";\
		eq? $(SF_DWN_LOGOFF) y oper_logoff 1;\
		eq? $(SF_DWN_LOGOFF) y KSTATE 0 "$(stat1)" "$(NEXT_ACT8_MSG)" "" "" "$(sfDumps)\n$(sfloads)" "";\
		ne? $(SF_DWN_LOGOFF) y KSTATE 1 "$(stat1)" "$(NEXT_ACT2_MSG)"  "" "" "$(sfDumps)\n$(sfloads)" "";\
		NoCommKS3
macro  dospare	last_stat 3;last_rsn $(sfarg1);eq? $(SF_SPR_LOGOFF) y curr_oper "";\
		eq? $(SF_SPR_LOGOFF) y oper_logoff 1;\
		eq? $(SF_SPR_LOGOFF) y KSTATE 0 "$(stat3)" "$(NEXT_ACT8_MSG)" "" "" "$(sfDumps)\n$(sfloads)" "";\
		ne? $(SF_SPR_LOGOFF) y KSTATE 3 "$(stat3)" "$(NEXT_ACT2_MSG)"  "" "" "$(sfDumps)\n$(sfloads)" "";\
		NoCommKS3
macro  dologon    curr_oper $(sfarg1);sf_operid $(sfarg1);eq? $(sfarg1) -1 curr_oper "";\
                  ne? $(sfarg1) -1 ne? $(last_stat) 2 KSTATE $(last_stat) "$(stat$(last_stat))" "$(NEXT_ACT2_MSG)" "$(sfDumps)\n$(sfloads)" "" "";\
                  ne? $(sfarg1) -1 eq? $(last_stat) 2 doready;\
                  eq? $(sfarg1) -1 KSTATE 0 "$(stat$(last_stat))" "$(NEXT_ACT8_MSG)" "" "" "$(sfDumps)\n$(sfloads)" "";\
				  eq? $(sfarg1) -1 oper_logoff 1;ne? $(sfarg1) -1 oper_logoff 0;\
                  NoCommKS3
macro	UpdateMatDisp	w0.InfAct label:$(last_matl)
macro	UpdateLoadDisp	w0.InfAct label:$(last_shvloc)