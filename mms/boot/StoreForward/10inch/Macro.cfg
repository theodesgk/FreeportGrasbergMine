#!/psw/cpp

#define MI_FILE <StoreForward/10inch/Macro_mineinfo.cfg>
#include MI_FILE
#if defined UGUI
#define HELPER  <StoreForward/10inch/Newui_helper.cfg>
#include HELPER
#endif
#################################################
# Pre define SF_config settings to prevent errors
symbol SF_DWN_LOGOFF y
symbol SF_SPR_LOGOFF n
symbol SF_LD_CNT n
symbol SF_NOTALK_COMMSTAT_CHECK y
symbol TWO_BUTTON_TRAM	n
symbol TWO_BUTTON_AUTO  n
symbol SF_NOCOMM_RPC_TO_UP y
#################################################
#define SFCFG <StoreForward/SF_config.cfg>
#include SFCFG
symbol	SF_10inch	yes
symbol	SF_DELite
symbol	SF_DE
###################################################################
# Store and Forward symbols
###################################################################
symbol last_loadloc 'unknown'
symbol last_dumploc 'unknown'
symbol last_ldunit  6
symbol last_dmpunit 3
symbol last_beacon -1
symbol last_stat    0
symbol last_rsn
symbol sf_fulltime  ''
symbol sf_operid
symbol loc_unit
symbol last_matl    ''
symbol last_grade   ''
symbol sfaction     ''
symbol sfarg1       ''
symbol sfarg2       ''
symbol sfarg3       ''
symbol newstate     0
symbol sfmenu       ''
symbol sfnextact    ''
symbol sfprevact    ''
symbol nextactdesc	''
symbol sfnextloc    ''
symbol doActHandle
symbol dest        ''
symbol req
symbol reqact
symbol rpcReq
symbol sfloads      0
symbol disp_lds		0
symbol nocomm_lds	0
symbol isLoaded	unknown
symbol needSfSync	n
symbol doSyncCheck	1
symbol BeanMsg
symbol SF_READY		2
symbol SF_ASSIGN	5
symbol SF_ARRIVE	6
symbol SF_LOAD		7
symbol SF_LOGON		8
symbol SF_FULL		12
symbol SF_WAIT		9
symbol SF_NONPROD	0
symbol NEXT_ACT5_MSG
symbol NEXT_ACT6_MSG
symbol NEXT_ACT7_MSG
symbol NEXT_ACT12_MSG
symbol NEXT_ACT2_MSG
symbol NEXT_ACT8_MSG
symbol NEXT_ACT9_MSG

#
#
#
###################################################################
# Store and Forward Rpc re-definitions
###################################################################
macro  noTalk         rpcReq $2;\
                      eq? $(SF_NOTALK_COMMSTAT_CHECK) n checkRpc;\
                      eq? $(SF_NOTALK_COMMSTAT_CHECK) y eq? $(commstat) no  checkRpc;\
                      eq? $(SF_NOTALK_COMMSTAT_CHECK) y eq? $(commstat) yes showNoTalk;\
                      eq? $(midebug) 1 w0.Text write:"no Talk called for $2 ($1)\n"
macro  showNoTalk	MessageBox "$(CommErrLbl)" "$(PressOkLbl)";\
                        ne? $(noCommsTime) 0 WinMgr after:$(noCommsTime):commsClose
#
# GPS-ARRIVE is sent to GC from hub and then forwarded on to Central
#
out    GPS-ARRIVE     0x01a6  ddd?ddl  last_beacon $1;WinMgr after:1:HandleBcnArr;sendto up spooled
macro  gpssim	GPS-ARRIVE $(GetPadValue) 0 0 0 0
macro  gpsdprt  GPS-DEPART $(GetPadValue) 0 0
macro  btngpssim      PostNumPad "Beacon ID" gpssim
macro  btngpsdprt	PostNumPad "Beacon Depart ID" gpsdprt
macro  gpssimon	      KMENU2 Options [ 'GPS\nSim btngpssim' 'GPS\nDepart btngpsdprt' ]
out    GPS-DEPART     0x01a7  ddd?ddl     sendto up spooled
#
out	RFID-ARRIVE 	0x0601	dd	last_beacon $2;WinMgr after:1:HandleBcnArr;sendto up spooled
macro	rfidsim	RFID-ARRIVE 0 $(GetPadValue)
macro   btnrfidsim     PostNumPad "Beacon ID" rfidsim
macro   rfidsimon      KMENU2 Options [ 'RfTag\nSim btnrfidsim' ]
out     RFID-DEPART     0x0602  dd      sendto up spooled
#
# Overriding HELP here to avoid the delay waiting for noTalk. Also, it's not possible to
# check the value of the arg to HELP via checkRpc and doSFLogic...
out    HELP    0x06    d       ne? $(commstat) yes eq? $1 911 postTrans "$(NoEmergLbl)";\
                               ne? $(commstat) yes eq? $1 911 KBEEP 3;\
                               sendto up
###################################################################
# Store and Forward common functions
###################################################################
macro	doGoodComms	showGoodComms;eq? $(doCommsBeep) 1 goodCommsInf;\
                    eq? $(sfsync) 1 doSfSync;\
                    SFDATA "GoodComms" "none"
macro	doBadComms	showBadComms;eq? $(doCommsBeep) 1 badCommsInf;\
                    SFDATA "BadComms" "none"
macro  checkcomms     eq? $(doCommCheck) 1 ne? $(OMS connected) $(commstat) switchcomms;checkSfSync
macro  checkSfSync    eq? $(doSyncCheck) 1 eq? $(OMS connected) yes eq? $(needSfSync) y eq? $(sfsync) 1 doSfSync
macro SF_rpc_extra    kstate_extra $(kstate_extra) SF
macro initSF	      setSFMsg;SF_rpc_extra
macro	HandleKsArg3	UpdateStatBar "Data" "$(sfloads)\n$(BeanMsg)"
macro	HandleKsArg4	UpdateStatBar "Data" "$(sfloads)\n$(BeanMsg)"
macro	HandleKsArg6	UpdateStatBar "Data" "$(sfloads)\n$(BeanMsg)"
macro	Handleks3arg7	eq? $(needSfSync) y Checkks3arg7;ne? $(needSfSync) y Setks3arg7
macro	Checkks3arg7	eq? $(curr_oper) $(sf_operid) ne? $7 "" ne? $7 " " Setks3arg7
#if defined DELITE || defined UGUI
macro	Setks3arg7	sf_operid:$7
#else
macro	Setks3arg7	sf_operid:$7;Report operatorId:$7
#endif
symbol	stat0_icon
message	stat0
symbol syncVer	1
macro doSfSync	doSfSync.$(syncVer)
macro doSfSync.0      eq? $(oper_logoff) 1 EQ-REQ "sf-sync" [ "$(state)" "$(sf_operid)" "$(last_stat)" "$(last_rsn)" "" "" "" "" "" "" ];\
                      oper_logoff 0;needSfSync n;\
                      ne? $(sf_operid) "" ne? "$(sf_operid)" " " ne? $(sf_operid) -1 EQ-REQ "sf-sync" [ "$(state)" "$(sf_operid)" "$(last_stat)" "$(last_rsn)" "$(sfnextact)" "$(sfnextloc)" "$(last_loadloc)" "$(last_dumploc)" $(last_matl) $(sf_fulltime) ]
macro doSfSync.1      eq? $(oper_logoff) 1 EQ-REQ "sf-sync" [ "$(state)" "$(sf_operid)" "$(last_stat)" "$(last_rsn)" "" "" "" "" "" "" ];\
                      oper_logoff 0;needSfSync n;\
                      ne? $(sf_operid) "" ne? "$(sf_operid)" " " ne? $(sf_operid) -1 EQ-REQ "sf-sync" [ "$(state)" "$(sf_operid)" "$(last_stat)" "$(last_rsn)" "$(sfnextact)" "$(sfnextloc)" $(last_loadloc) $(last_dumploc) $(last_matl) $(sf_fulltime) ]
macro doprestart	  postTrans "$(PreStrtSpool)"
macro sflocstat	      postTrans "$(LocStatSpool)"
macro setSFMsg        NEXT_ACT2_MSG "$(NextLbl) $(stat2)";NEXT_ACT8_MSG "$(NextLbl) $(sfLogOn)";NEXT_ACT5_MSG "$(NextLbl) $(sfact5)";NEXT_ACT6_MSG "$(NextLbl) $(sfact6)";NEXT_ACT7_MSG "$(NextLbl) $(sfact7)";NEXT_ACT12_MSG "$(NextLbl) $(sfact12)";NEXT_ACT9_MSG "$(TruckWait)";setBeanMsg
macro	setbeans	ne? $(disp_lds) 0 eq? $6 0 nocomm_lds:0;\
			disp_lds:$6;UpdateBeans
macro	CheckAuto eq? "$(locauto.$(last_beacon))" "1" eq? "$(locid.$(last_beacon))" "$(dest)" eq? $(sfnextact) $(SF_ARRIVE) doActArrive
macro	NoCommKS3	KSTATE3 $(last_stat) "$(curr_rsn)" "$(curr_oper)" "$(last_rsn)" "$(last_beacon)" "-1" "$(sf_operid)"
macro	CheckSfCnt	UpdateBeans
macro	UpdateBeans	sfloads:$(disp_lds);eq? $(SF_LD_CNT) y sfloads:$(+ $(disp_lds) $(nocomm_lds));UpdateStatBar "Data" "$(sfloads)\n$(BeanMsg)"
macro	setBeanMsg	BeanMsg $(sfDumps)
macro	clearfulltime	sf_fulltime ''

#if DEMAJOR >= 6 && DEMINOR >= 6 && DEMAINT >= 3
macro   doActArriveStd     ARRIVE -1 [\"$(Time epoch)\"]
macro   doActLoadStd       LOAD -1 [\"$(Time epoch)\"]
macro   doStartDumpStd     EQ-REQ "startdump" [\"$(Time epoch)\"]
macro   doActAssignStd     ASSIGN -1 [\"$(Time epoch)\"]
macro	setfulltime	isLoaded yes;sf_fulltime "$(Time epoch)"
#else
macro   doActArriveStd     ARRIVE -1
macro   doActLoadStd       LOAD -1
macro   doStartDumpStd     EQ-REQ "startdump"
macro   doActAssignStd     ASSIGN -1
macro	setfulltime	isLoaded yes;sf_fulltime "$(Time day)-$(Time month)-$(Time year) $(Time hour):$(Time minute):$(Time second)"
#endif

/* Support for StoreForward with GpsTagAct */
symbol tagactArg
macro sendUpSpool	sendto up spooled
macro sendSpooled	sendto up spooledonly
macro checkSendUp	eq? $(isTagact) y sfarg1 $(tagactArg);eq? $(isTagact) n sfarg1 $1;\
                        eq? $(SF_NOCOMM_RPC_TO_UP) y sendUpSpool;ne? $(SF_NOCOMM_RPC_TO_UP) y checkNoCommUp
macro checkNoCommUp	eq? $(commstat) yes sendUpSpool;eq? $(commstat) no sendNoCommUp
macro sendNoCommUp	sendSpooled;checkRpc;eq? $(midebug) 1 w0.Text write:"noCommUp called for $(rpcReq)\n"
macro doDown	rpcReq DOWN;checkSendUp
macro doReady	rpcReq READY;checkSendUp
macro doStandby rpcReq STANDBY;checkSendUp
macro doDelay   rpcReq DELAY;checkSendUp
macro doAssign	rpcReq ASSIGN;checkSendUp
macro doArrive	rpcReq ARRIVE;checkSendUp
macro doLoad	rpcReq LOAD;checkSendUp
macro doFull	rpcReq FULL;checkSendUp
macro doEqReq	req $1;rpcReq EQ-REQ;checkSendUp
macro doLogon	rpcReq LOGON;checkSendUp
macro doPrestart	rpcReq PRESTART;checkSendUp
symbol isTagact	n
#ifdef GPSTAGACT
symbol isTagact y
macro doDown	tagactArg $1;sendSpooled;reqact 1;EQ-REQ "gpstagact" [ "1" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
macro doReady	tagactArg $1;sendSpooled;reqact 2;EQ-REQ "gpstagact" [ "2" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
macro doStandby	tagactArg $1;sendSpooled;reqact 3;EQ-REQ "gpstagact" [ "3" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
macro doDelay	tagactArg $1;sendSpooled;reqact 4;EQ-REQ "gpstagact" [ "4" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]

#if DEMAJOR >= 6 && DEMINOR >= 6 && DEMAINT >= 3
macro doAssign	tagactArg $1;sendSpooled;reqact 5;EQ-REQ "gpstagact" [ "5" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" \"$(Time epoch)\" ]
macro doArrive	tagactArg $1;sendSpooled;reqact 6;EQ-REQ "gpstagact" [ "6" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" \"$(Time epoch)\" ]
macro doLoad	tagactArg $1;sendSpooled;reqact 7;EQ-REQ "gpstagact" [ "7" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" \"$(Time epoch)\" ]
macro doFull	tagactArg $1;sendSpooled;reqact 12;EQ-REQ "gpstagact" [ "12" "$1" $2 "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" \"$(Time epoch)\" ]
#else
macro doAssign	tagactArg $1;sendSpooled;reqact 5;EQ-REQ "gpstagact" [ "5" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
macro doArrive	tagactArg $1;sendSpooled;reqact 6;EQ-REQ "gpstagact" [ "6" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
macro doLoad	tagactArg $1;sendSpooled;reqact 7;EQ-REQ "gpstagact" [ "7" "$1" "" "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
macro doFull	tagactArg $1;sendSpooled;reqact 12;EQ-REQ "gpstagact" [ "12" "$1" $2 "$(GpsTruck x)" "$(GpsTruck y)"\
"$(GpsTruck z)" "$(GpsTruck velocity)" "$(GpsTruck status)" ]
#endif

#macro doLogon   tagactArg $1;sendUpSpool
#macro doPrestart        tagactArg $1;sendUpSpool
macro doLogon   tagactArg $1;rpcReq LOGON;checkSendUp
macro doPrestart        tagactArg $1;rpcReq PRESTART;checkSendUp
#endif
				  
symbol	SFAPP	APP
#define SFAPP_FILE <StoreForward/10inch/APP/Macro.cfg>
#include SFAPP_FILE				  
				  
symbol	SFLANG	LANGUAGE
#define SFLANG_FILE	<StoreForward/10inch/LANGUAGE/Macro.cfg>
#include SFLANG_FILE				  
