symbol sfsync	    1
symbol oper_logoff  0
symbol isTramming no
symbol toggleTram off
symbol chngloc y
symbol sfMatlSelect
macro	HandleSFInfo	ne? $2 "unknown" last_loadloc $2;\
                        ne? $3 "unknown" last_dumploc $3;\
			eq? $1 7 setloadloc;\
			eq? $1 8 setdumploc;\
			nextactdesc $4;sfnextact $5;setbeans
macro	setloadloc	sfnextloc shovel;dest $(last_loadloc)
macro	setdumploc	sfnextloc dump;dest $(last_dumploc)
macro	Handleks3arg6	last_stat $(curr_stat);last_rsn $(curr_rcode);nextactdesc $6
macro	SF.kstate_extra	sfprevact $(sfnextact);sfnextact $(SF_NONPROD);\
                        eq? $(isTramming) no UpdateStatBar "Data" $(rpc_arg6);\
                        eq? $(state) 0 'sfnextact $(sfprevact)';\
                        eq? $(state) 1 'sfnextact $(sfprevact)';\
                        eq? $(state) 2 'sfnextact $(SF_ASSIGN);setActMsg';\
                        eq? $(state) 3 'sfnextact $(sfprevact)';\
                        eq? $(state) 4 'sfnextact $(sfprevact)';\
                        eq? $(state) 5 'sfnextact $(sfprevact)';\
			eq? $(state) 6 'sfnextact $(SF_ARRIVE);setActMsg;isLoaded no';\
			eq? $(state) 7 'sfnextact $(SF_WAIT);setActMsg;isLoaded no';\
			eq? $(state) 8 'sfnextact $(SF_FULL);setActMsg;isLoaded no';\
			eq? $(state) 9 'sfnextact $(SF_ARRIVE);isTramming yes;setActMsg;isLoaded yes';\
			eq? $(state) 10 'sfnextact $(SF_ASSIGN);setActMsg;isLoaded yes';\
			eq? $(state) 11 'sfnextact $(SF_ARRIVE);setActMsg;isLoaded no';\
			eq? $(state) 12 'sfnextact $(SF_ASSIGN);setActMsg;isLoaded no';\
			eq? $(state) 13 'sfnextact $(SF_ASSIGN);setActMsg;isLoaded no';\
			eq? $(state) 14 'sfnextact $(SF_FULL);setActMsg;isLoaded no';\
			eq? $(state) 15 'sfnextact $(SF_LOAD);setActMsg;isLoaded no';\
			eq? $(state) 16 'sfnextact $(SF_FULL);setActMsg;isLoaded no';\
                        eq? $(state) 21 'sfnextact $(sfprevact)';\
                        eq? $(state) 22 'sfnextact $(sfprevact)';\
                        eq? $(state) 23 'sfnextact $(sfprevact)';\
                        eq? $(state) 24 'sfnextact $(sfprevact)';\
			eq? $(state) 25 'sfnextact $(SF_FULL);setActMsg;isLoaded no'
macro	setActMsg	NEXT_ACT$(sfnextact)_MSG $(rpc_arg3)

macro	doTrammode eq? $(isTramming) yes toggleTram no;ne? $(isTramming) yes toggleTram yes;isTramming $(toggleTram);EQ-REQ "trammode"
macro	doKmatl		matl.$2 $1;numSplits $(nil);last_matl $(matl.$(matl))
in	SendMaterial	INT_RPC	s	sfMatlSelect "$1";EQ-REQ "matl" [ "$1" "$(matl)" ]
macro  doActArrive doActHandle 0;dest '';\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) dump   arrivedatdump;\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) shovel arrivedatload;\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) load   arrivedatload;\
                   doActArriveStd
macro  doActAssign doActHandle 0;dest '';\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) dump   assignedatdump;\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) shovel assignedatload;\
                   eq? $(doActHandle) 0 eq? $(sfnextloc) load   assignedatload;\
                   doActAssignStd
macro	exChngLoc	last_loadloc "$1";EQ-REQ "setloc" [ "$1" ]
macro	setBeanMsg	BeanMsg $(sfExLds)
macro	adjstbeans nocomm_lds:$(+ $(nocomm_lds) 1);UpdateBeans
macro   checkRpc  eq? $(rpcReq) ASSIGN  doSFLogic;\
                  eq? $(rpcReq) LOAD    doSFLogic;\
                  eq? $(rpcReq) FULL    doSFLogic;\
                  eq? $(rpcReq) ARRIVE  doSFLogic;\
                  eq? $(rpcReq) DELAY   doSFLogic;\
                  eq? $(rpcReq) DOWN    doSFLogic;\
                  eq? $(rpcReq) READY   doSFLogic;\
                  eq? $(rpcReq) STANDBY doSFLogic;\
                  eq? $(rpcReq) LOGON   doSFLogic;\
                  eq? $(rpcReq) PRESTART doSFLogic;\
                  eq? $(rpcReq) GPS-ARRIVE doSFLogic;\
                  eq? $(rpcReq) RFID-ARRIVE doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) setloc  doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) LocStat doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) gpstagact doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) matl doSFLogic;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) sf-sync needSfSync y;\
                  ne? $(rpcReq) KSTATE ne? $(rpcReq) RFID-ARRIVE ne? $(rpcReq) RFID-DEPART ne? $(rpcReq) GPS-ARRIVE ne? $(rpcReq) GPS-DEPART ne? $(rpcReq) EQ-REQ ne? $(rpcReq) SFDATA ne? $(rpcReq) ASSIGN ne? $(rpcReq) LOAD ne? $(rpcReq) FULL ne? $(rpcReq) ARRIVE ne? $(rpcReq) DELAY ne? $(rpcReq) DOWN ne? $(rpcReq) READY ne? $(rpcReq) STANDBY ne? $(rpcReq) LOGON ne? $(rpcReq) PRESTART ne? $(rpcReq) EQ-REQ ne? $(rpcReq) KBEEP MessageBox "$(NoCommActLbl)" "$(CommsErrorLbl)";\
                  eq? $(rpcReq) EQ-REQ ne? $(req) sf-sync ne? $(req) setloc ne? $(req) psitemcomment ne? $(req) LocStat ne? $(req) gpstagact ne? $(req) matl MessageBox "$(NoCommActLbl)" "$(CommsErrorLbl)";
macro   doSFLogic needSfSync y;\
                  eq? $(rpcReq) DELAY   dodelay;\
                  eq? $(rpcReq) DOWN    dodown;\
                  eq? $(rpcReq) READY   doready;\
                  eq? $(rpcReq) STANDBY dospare;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 6    arrive6;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 9    arrive9;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 2  eq? $(sfnextloc) shovel arrive6;\
                  eq? $(rpcReq) ARRIVE  eq? $(state) 2  eq? $(sfnextloc) dump arrive9;\
                  eq? $(rpcReq) FULL    eq? $(isTramming) yes fullistram;\
                  eq? $(rpcReq) FULL    ne? $(isTramming) yes fullnotram;\
                  eq? $(rpcReq) LOAD    eq? $(isTramming) yes doload;\
                  eq? $(rpcReq) LOGON   dologon;\
                  eq? $(rpcReq) PRESTART doprestart;\
                  eq? $(rpcReq) GPS-ARRIVE CheckAuto;\
                  eq? $(rpcReq) RFID-ARRIVE CheckAuto;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) setloc  mansetloadloc;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) LocStat sflocstat;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) gpstagact sfgpsact;\
                  eq? $(rpcReq) EQ-REQ eq? $(req) matl sfMatlSet;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 7  assign7;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 10 assign10;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) no assign10;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) yes assign7;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) unknown eq? $(sfnextloc) shovel assign10;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 2  eq? $(isLoaded) unknown eq? $(sfnextloc) dump assign7;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 13 assign13;\
                  eq? $(rpcReq) ASSIGN  eq? $(state) 9  assign9;
macro  sfgpsact  eq? $(reqact) 1 dodown;\
		 eq? $(reqact) 2 doready;\
		 eq? $(reqact) 3 dospare;\
		 eq? $(reqact) 4 dodelay;\
                 eq? $(reqact) 5 eq? $(state) 7 assign7;\
		 eq? $(reqact) 5 eq? $(state) 10 assign10;\
                 eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) no assign10;\
                 eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) yes assign7;\
                 eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) unknown eq? $(sfnextloc) shovel  assign10;\
                 eq? $(reqact) 5 eq? $(state) 2 eq? $(isLoaded) unknown eq? $(sfnextloc) dump  assign7;\
		 eq? $(reqact) 5 eq? $(state) 13 assign13;\
		 eq? $(reqact) 5 eq? $(state) 9 assign9;\
		 eq? $(reqact) 6 eq? $(state) 6 arrive6;\
		 eq? $(reqact) 6 eq? $(state) 9 arrive9;\
		 eq? $(reqact) 7 eq? $(isTramming) yes doload;\
		 eq? $(reqact) 12 eq? $(isTramming) yes fullistram;\
		 eq? $(reqact) 12 ne? $(isTramming) yes fullnotram;
macro  mansetloadloc setloadloc;KSTATE 6  "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                     sfnextloc shovel;\
                     sfnextact $(SF_ARRIVE);NoCommKS3
macro sfMatlSet	SFDATA "MatlSelect" "$(sfMatlSelect)";KMATL "$(sfMatlSelect)" $(matl)
macro  assign7        setdumploc;KSTATE 9 "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  assign9        setloadloc;KSTATE 6 "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      adjstbeans;NoCommKS3
macro  assign10       setloadloc;KSTATE 6 "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      adjstbeans;NoCommKS3
macro  assign13       setloadloc;KSTATE 9 "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      adjstbeans;NoCommKS3
macro  doload         KSTATE 13 "$(sfldMsg) $(last_loadloc)" "$(NEXT_ACT12_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  fullistram     setdumploc;KSTATE 9  "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  fullnotram     KSTATE 7  $(last_loadloc) "$(TruckWait)" "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  arrive6        eq? $(isTramming) yes KSTATE 16 "$(sfldMsg) $(last_loadloc)"  "$(NEXT_ACT12_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  arrive9        eq? $(isTramming) yes KSTATE 10 "$(sfdmpMsg) $(last_dumploc)" "$(NEXT_ACT5_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  arrivedatdump  dest $(last_dumploc);\
                      sfnextact $(SF_ASSIGN);\
                      doActHandle 1;\
                      SFDATA "$(last_loadloc)" "$(last_dumploc)" "$(last_matl)"
macro  arrivedatload  dest $(last_loadloc);\
                      sfnextact $(SF_FULL);\
                      doActHandle 1;\
                      SFDATA "$(last_loadloc)" "$(last_dumploc)" "$(last_matl)"
macro  assignedatdump dest $(last_loadloc);\
                      sfnextact $(SF_ARRIVE);\
                      doActHandle 1;\
                      sfnextloc shovel;
macro  assignedatload dest $(last_dumploc);\
                      sfnextact $(SF_ARRIVE);\
                      doActHandle 1;\
                      sfnextloc dump;
macro  dodelay        last_stat 4;last_rsn $(sfarg1);KSTATE 4 "$(stat4)" "$(NEXT_ACT2_MSG)"  "" "" "$(sfExLds)\n$(sfloads)" "";NoCommKS3
macro  doready        last_stat 2;last_rsn $(sfarg1);eq? $(sfnextact) $(SF_READY) sfnextact $(SF_ASSIGN);\
                      eq? $(sfnextact) $(SF_ASSIGN) eq? $(sfnextloc) dump KSTATE 10 "$(sfrdyMsg) $(last_dumploc)" "$(NEXT_ACT5_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      eq? $(sfnextact) $(SF_ASSIGN) eq? $(sfnextloc) shovel   KSTATE 8  "$(sfrdyMsg) $(last_loadloc)" "$(NEXT_ACT5_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      eq? $(sfnextact) $(SF_ARRIVE) eq? $(sfnextloc) shovel KSTATE 6  "$(sfgoMsg) $(last_loadloc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      eq? $(sfnextact) $(SF_ARRIVE) eq? $(sfnextloc) dump   KSTATE 9  "$(sfgoMsg) $(last_dumploc)" "$(NEXT_ACT6_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      eq? $(sfnextact) $(SF_WAIT)  KSTATE 7 $(last_loadloc) "$(TruckWait)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      eq? $(sfnextact) $(SF_FULL)   KSTATE 8 "$(sfldMsg) $(last_loadloc)" "$(NEXT_ACT12_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
                      NoCommKS3
macro  dodown	last_stat 1;last_rsn $(sfarg1);eq? $(SF_DWN_LOGOFF) y curr_oper "";\
		eq? $(SF_DWN_LOGOFF) y oper_logoff 1;\
		eq? $(SF_DWN_LOGOFF) y KSTATE 0 "$(stat1)" "$(NEXT_ACT8_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
		ne? $(SF_DWN_LOGOFF) y KSTATE 1 "$(stat1)" "$(NEXT_ACT2_MSG)"  "" "" "$(sfExLds)\n$(sfloads)" "";\
		NoCommKS3
macro  dospare	last_stat 3;last_rsn $(sfarg1);eq? $(SF_SPR_LOGOFF) y curr_oper "";\
		eq? $(SF_SPR_LOGOFF) y oper_logoff 1;\
		eq? $(SF_SPR_LOGOFF) y KSTATE 0 "$(stat3)" "$(NEXT_ACT8_MSG)"  "" "" "$(sfExLds)\n$(sfloads)" "";\
		ne? $(SF_SPR_LOGOFF) y KSTATE 3 "$(stat3)" "$(NEXT_ACT2_MSG)"  "" "" "$(sfExLds)\n$(sfloads)" "";\
		NoCommKS3
macro  dologon    curr_oper $(sfarg1);sf_operid $(sfarg1);eq? $(sfarg1) -1 curr_oper "";\
                  ne? $(sfarg1) -1 ne? $(last_stat) 2 KSTATE $(last_stat) "$(stat$(last_stat))" "$(NEXT_ACT2_MSG)" "" "$(sfExLds)\n$(sfloads)" "";\
                  ne? $(sfarg1) -1 eq? $(last_stat) 2 doready;\
                  eq? $(sfarg1) -1 KSTATE 0 "$(stat$(last_stat))" "$(NEXT_ACT8_MSG)" "" "" "$(sfExLds)\n$(sfloads)" "";\
				  eq? $(sfarg1) -1 oper_logoff 1;ne? $(sfarg1) -1 oper_logoff 0;\
                  NoCommKS3
