%! /psw/cpp

#include <Goic/common/Macro_utils.cfg>
#include <StoreForward/Goic/Macro_mineinfo.cfg>

###################################################################
# Store and Forward symbols
###################################################################
symbol last_loadloc 'unknown'
symbol last_dumploc 'unknown'
symbol last_ldunit  6
symbol last_dmpunit 3
symbol last_beacon  -1
symbol last_stat    4
symbol loc_unit
symbol last_matl    ''
symbol last_grade   ''
symbol sfaction     ''
symbol sfarg1       ''
symbol sfarg2       ''
symbol sfarg3       ''
symbol newstate     0
symbol sfmenu       ''
symbol sfnextact    ''
symbol sfnextloc    ''
symbol sfloads      0
symbol noTalkRpc
#
#
#
###################################################################
# Store and Forward Macro re-definitions
###################################################################
macro  noTalk         noTalkRpc $2;\
		      eq? $(commstat) no  checkRpc;\
                      eq? $(commstat) yes showNoTalk
macro  noTalkForce    eq? $(commstat) no  checkRpc;\
		      eq? $(commstat) yes showNoTalk
macro  showNoTalk	Ok action:'' label:$(msg.256) post;ne? $(noCommsTime) 0 WinMgr after:$(noCommsTime):timeoutOk
#
# GPS-ARRIVE is sent to GC from hub and then forwarded on to Central
#
#if #arch(pe)
out    GPS-ARRIVE     0x01a6  ddd?dd  last_beacon $1;WinMgr after:1:HandleBcnArr;sendto up spooled
macro  gpssim	GPS-ARRIVE $(Kp.D label) 0 0 0 0
#else
out    GPS-ARRIVE     0x01a6  ddd?dd  sendto up spooled
macro  gpssim	GPSARRIVE-HUB $(Kp.D label) 0 0 0 0
#endif
in     GPSARRIVE-HUB  0x01b6  ddd?dd  fwd_gpsarrive
out    GPS-DEPART     0x01a7  ddd     sendto up spooled
in     GPSDEPART-HUB  0x01b7  ddd     fwd_gpsdepart
macro  fwd_gpsarrive  last_beacon $1;HandleBcnArr;GPS-ARRIVE $1 $2 $3 $4 $5
macro  fwd_gpsdepart  GPS-DEPART $1 $2 $3
macro  btngpssim      kpaction 'gpssim';Kp label:'Beacon ID' post
macro  gpssimon	      KMENU2 Options [ 'GPS\nSim btngpssim' ]
#
# RFID-ARRIVE is sent to GC from hub and then forwarded on to Central
#
#if #arch(pe)
out	RFID-ARRIVE 	0x0601	dd	last_beacon $2;WinMgr after:1:HandleBcnArr;sendto up spooled
macro	rfidsim	RFID-ARRIVE 0 $(Kp.D label)
#else
out	RFID-ARRIVE 	0x0601	dd	sendto up spooled
macro	rfidsim	RFIDARRIVE-HUB 0 $(Kp.D label)
#endif
in	RFIDARRIVE-HUB	0x0605	dd	fwd_rfidarrive
out	RFID-DEPART	0x0602	dd	sendto up spooled
in	RFIDDEPART-HUB	0x0606	dd	fwd_rfiddepart
macro	fwd_rfidarrive	last_beacon $2;HandleBcnArr;RFID-ARRIVE $1 $2
macro	fwd_rfiddepart	RFID-DEPART $1 $2
macro   btnrfidsim     kpaction 'rfidsim';Kp label:'Beacon ID' post
macro   rfidsimon      KMENU2 Options [ 'RfTag\nSim btnrfidsim' ]
#
# Overriding HELP here to avoid the delay waiting for noTalk. Also, it's not possible to
# check the value of the arg to HELP via checkRpc and doSFLogic...
out    HELP    0x06    d       ne? $(commstat) yes eq? $1 911 w0.Text write "NO COMMS!!!\nEMERGENCY REQUEST WAS\nNOT RECEIVED!!!\n";\
                               ne? $(commstat) yes eq? $1 911 KBEEP 3;\
                               sendto up
out    DELAY   0x07    d       more 1;sfarg1 $1;sendto up spooled
out    DOWN    0x08    d       more 1;sfarg1 $1;sendto up spooled
out    READY   0x09    d       more 1;sfarg1 $1;sendto up spooled
out    STANDBY 0x0a    d       more 1;sfarg1 $1;sendto up spooled
out    ASSIGN  0x01    d       sendto up spooled
out    ARRIVE  0x02    d       sendto up spooled
out    LOAD    0x03    d       sendto up spooled
out    LOGON   0x04    s       sendto up spooled
out    FULL    0x10    s?s     sendto up spooled
out    EQ-REQ  0x30    s?[s]   ne? $(commstat) yes checkRpc;sendto up spooled
out  PRESTART  0x31    ds[b]   sendto up spooled
/* This is handled in generic code now
*macro  doGoodComms    w0.Text write:"Comms re-established.\n";\
*                      w0.Comm icon: wifi_on;\
*                      eq? $(sfsync) 1 doSfSync;\
*                      SFDATA "GoodComms" "none";\
*                      eq? $(sfdobeep) 1 KBEEP 1;
*macro  doBadComms     w0.Text write:"Lost comms!\n";\
*                      w0.Comm icon: wifi_off;\
*                      SFDATA "BadComms" "none";\
*                      eq? $(sfdobeep) 1 KBEEP 1;
*macro  switchcomms    commstat $(OMS connected);\
*                      eq? $(commstat) yes doGoodComms;\
*                      ne? $(commstat) yes doBadComms;
*macro  checkcomms     ne? $(OMS connected) $(commstat) switchcomms;\
*                      WinMgr after:5:checkcomms
*macro  initcomms      commstat $(OMS connected);\
*                      eq? $(commstat) yes w0.Comm icon: wifi_on;\
*                      ne? $(commstat) yes w0.Comm icon: wifi_off;\
*                      WinMgr after:5:checkcomms;
*/
macro checkYesNoResponse eq? $(operResponse) 1 sfdobeep 0;\
                         eq? $(operResponse) 0 sfdobeep 1
macro	doGoodComms	w0.Comm icon: wifi_on;eq? $(sfdobeep) 1 goodCommsInf;\
                       eq? $(sfsync) 1 doSfSync;\
                       SFDATA "GoodComms" "none"
macro	doBadComms	w0.Comm icon: wifi_off;eq? $(sfdobeep) 1 badCommsInf;\
                       SFDATA "BadComms" "none"
macro SF_rpc_extra    kstate_extra $(kstate_extra) SF
macro initSF	      SF_rpc_extra
macro doSfSync	      EQ-REQ "sf-sync" [ "$(state)" "$(sfnextact)" "$(sfnextloc)" "$(last_loadloc)" "$(last_dumploc)" "$(last_grade)" "$(last_matl)" ]
#if #class(truck) || #class(ug_truck)
symbol sfsync	    1
symbol mnasnok     y
symbol trkfull     y
symbol dest        ''
in     KSTATE  0x41    b?sss    state $1;loc $2;w0.Icon icon:$(icon.$1);w0.v1 label:$(msg.$1);w0.v2 label:$3;\
                                rpc_arg1 $1;rpc_arg2 $2;rpc_arg3 $3;rpc_arg4 $4;\
                                eq? $1 6 setloadloc;\
                                eq? $1 9 setdumploc;\
                                setnextact;
/* we don't redefined KSTATE2 anymore. Now use new feature that allows us to add extra
 * actions to generic rpc defs.
in     KSTATE2 0x32    b?ssssss state $1;loc $2;next $3;w0.Icon icon:$(icon.$1);\
                                w0.v1 label:$2;w0.v2 label:$3;w0.v3 label:$4;\
                                w0.Text write:$5;w0.Text write:\n;WinMgr audio:$7;\
                                eq? $1 6 setloadloc;\
                                eq? $1 9 setdumploc;\
                                setnextact;\
                                setbeans;
 */
macro SF.kstate_extra           eq? $(rpc_arg1) 6 setloadloc;\
                                eq? $(rpc_arg1) 9 setdumploc;\
                                setnextact;\
                                setbeans;
macro  kpArrive    dest '';\
                   eq? $(sfnextloc) dump   arrivedatdump;\
                   eq? $(sfnextloc) shovel arrivedatshovel;\
                   ARRIVE;\
                   KBEEP 1;\
                   SFDATA "$(last_loadloc)" "$(last_dumploc)" "$(last_matl)"
macro  kpAssign    dest '';\
                   eq? $(sfnextloc) dump   assignedatshovel;\
                   eq? $(sfnextloc) shovel assignedatdump;\
                   ASSIGN;\
                   KBEEP 1
macro  menuactionob1  ob1 $1;eq? $(sfmenu) shovel last_loadloc $1;eq? $(sfmenu) dump last_dumploc $1;sendaction
/* due to differences in the implementation of the Macro engine on Port Embedded 
 * we have do a few things differently. The arguments in the KSTATE come in enclosed 
 * in single quotes and then also enclosed in double quotes. On port embedded we
 * use the first foreach to strip the double quotes and the second foreach to then
 * parse what is enclosed in the single quotes.
 */
#if #arch(pe)
macro  setloadloc foreach $(rpc_arg2);do setloadloc_pe;sfnextloc shovel;dest $(last_loadloc)
macro  setloadloc_pe foreach $2;do last_loadloc:\$2;
macro  setdumploc foreach $(rpc_arg2);do setdumploc_pe;sfnextloc dump;dest $(last_dumploc)
macro  setdumploc_pe foreach $2;do last_dumploc:\$2
symbol test
macro  setnextact foreach $(rpc_arg3);do setnextact_pe;\
                  ne? $(temp) Ready ne? $(temp) On sfnextact $(temp);
macro  setnextact_pe foreach $2;do temp:\$2
macro  setbeans   foreach $(rpc_arg4);do setbeans_pe;\
                  eq? $(temp) $(max $(temp) $(sfloads)) sfloads:$(temp);\
                  eq? $(temp) 0 sfloads:0;
macro  setbeans_pe  foreach $2;do temp:\$2
#else
macro  setloadloc foreach $(rpc_arg2);do last_loadloc:\$2;sfnextloc shovel;dest $(last_loadloc)
macro  setdumploc foreach $(rpc_arg2);do last_dumploc:\$2;sfnextloc dump;dest $(last_dumploc)
symbol test
macro  setnextact foreach $(rpc_arg3);do temp:\$2;\
                  ne? $(temp) Ready ne? $(temp) On sfnextact $(temp);
macro  setbeans   foreach $(rpc_arg4);do temp:\$2;\
                  eq? $(temp) $(max $(temp) $(sfloads)) sfloads:$(temp);\
                  eq? $(temp) 0 sfloads:0;
#endif
symbol v3label
macro  adjstbeans v3label:$(w0.v3 label);\
                  foreach $(v3label);do temp:\$2;\
                  sfloads:$(+ $(temp) 1);\
                  w0.v3 label:"Dumps: $(sfloads)"; 
macro   checkRpc  eq? $(noTalkRpc) ASSIGN  doSFLogic;\
                  eq? $(noTalkRpc) LOAD    doSFLogic;\
                  eq? $(noTalkRpc) FULL    doSFLogic;\
                  eq? $(noTalkRpc) ARRIVE  doSFLogic;\
                  eq? $(noTalkRpc) DELAY   doSFLogic;\
                  eq? $(noTalkRpc) DOWN    doSFLogic;\
                  eq? $(noTalkRpc) READY   doSFLogic;\
                  eq? $(noTalkRpc) STANDBY doSFLogic;\
                  eq? $(noTalkRpc) LOGON   doSFLogic;\
                  eq? $(noTalkRpc) PRESTART doSFLogic;\
                  eq? $(noTalkRpc) GPS-ARRIVE doSFLogic;\
                  eq? $(noTalkRpc) RFID-ARRIVE doSFLogic;\
                  eq? $1 asn2shv doSFLogic;\
                  eq? $1 asn2loc doSFLogic;\
                  eq? $1 LocStat doSFLogic;\
                  eq? $1 psitemcomment doSFLogic;\
                  ne? $(noTalkRpc) KSTATE ne? $(noTalkRpc) RFID-ARRIVE ne? $(noTalkRpc) RFID-DEPART ne? $(noTalkRpc) GPS-ARRIVE ne? $(noTalkRpc) GPS-DEPART ne? $(noTalkRpc) SFDATA ne? $(noTalkRpc) ASSIGN ne? $(noTalkRpc) LOAD ne? $(noTalkRpc) FULL ne? $(noTalkRpc) ARRIVE ne? $(noTalkRpc) DELAY ne? $(noTalkRpc) DOWN ne? $(noTalkRpc) READY ne? $(noTalkRpc) STANDBY ne? $(noTalkRpc) LOGON ne? $(noTalkRpc) PRESTART ne? $(noTalkRpc) EQ-REQ ne? $(noTalkRpc) KBEEP Ok action:'' label:"Can\'t $(noTalkRpc) during no comms." post;
macro   doSFLogic eq? $(noTalkRpc) DELAY   dodelay;\
                  eq? $(noTalkRpc) DOWN    dodown;\
                  eq? $(noTalkRpc) READY   doready;\
                  eq? $(noTalkRpc) STANDBY dospare;\
                  eq? $(noTalkRpc) FULL    dofull;\
                  eq? $(noTalkRpc) LOAD    doload;\
                  eq? $(noTalkRpc) LOGON   dologon;\
                  eq? $(noTalkRpc) ARRIVE  eq? $(state) 6  arrive6;\
                  eq? $(noTalkRpc) ARRIVE  eq? $(state) 9  arrive9;\
                  eq? $(noTalkRpc) ASSIGN  eq? $(state) 7  assign7;\
                  eq? $(noTalkRpc) ASSIGN  eq? $(state) 10 assign10;\
                  eq? $(noTalkRpc) PRESTART doprestart;\
                  eq? $(noTalkRpc) GPS-ARRIVE CheckAuto;\
                  eq? $(noTalkRpc) RFID-ARRIVE CheckAuto;\
                  eq? $1 asn2shv sfasn2shv;\
                  eq? $1 asn2loc sfasn2loc;\
                  eq? $1 LocStat sflocstat;\
                  eq? $1 EQ-REQ  ne? $(req) asn2loc ne? $(req) asn2shv ne? $(req) psitemcomment Ok action:'' label:"Can\'t $2 during no comms." post;
macro  arrive6          KSTATE 7  $(last_loadloc) "Next: First Bucket" "";
macro  arrive9          KSTATE 10 $(last_dumploc) "Next: Assign"       "";
macro  assign7          KSTATE 9  $(last_dumploc) "Next: Arrive"       "";
macro  assign10         KSTATE 6  $(last_loadloc) "Next: Arrive"       "";\
                        adjstbeans;
macro  doload           KSTATE 8  $(last_loadloc) "Next: Full"         "";
macro  dofull           KSTATE 9  $(last_dumploc) "Next: Arrive"       "";
macro  sfasn2shv        last_loadloc $(ob1);KSTATE 6  $(last_loadloc) "Next: Arrive"       "";\
                        sfnextloc $(last_loadloc);\
                        sfnextact Arrive;
macro  sfasn2loc        last_dumploc $(ob1);KSTATE 9 $(last_dumploc) "Next: Arrive" "";\
                        sfnextloc $(last_dumploc);\
                        sfnextact Arrive;
macro  sflocstat	w0.Text write:"Location Status Change\nRequest Spooled.\n"
macro  doprestart	w0.Text write:"Pre-Start check Spooled.\n"
macro  arrivedatdump    dest $(last_dumploc);\
                        sfnextact Assign;\
                        sfnextloc shovel
macro  arrivedatshovel  dest $(last_loadloc);\
                        sfnextact Full;\
                        sfnextloc dump;
macro  assignedatdump   dest $(last_loadloc);\
                        sfnextact Arrive;\
                        sfnextloc shovel;\
                        sfloads:$( + $(sfloads) 1 );
macro  assignedatshovel dest $(last_dumploc);\
                        sfnextact Arrive;\
                        sfnextloc dump;
macro  dodelay          last_stat 4;KSTATE 4 "Unknown" "Next: Ready"  "";
macro  doready          last_stat 2;eq? $(sfnextloc) '' KSTATE 10 "" "";\
                        eq? $(sfnextact) Assign eq? $(sfnextloc) shovel KSTATE 10 $(last_dumploc) "Next: $(sfnextact)" "";\
                        eq? $(sfnextact) Assign eq? $(sfnextloc) dump   KSTATE 8  $(last_loadloc) "Next: $(sfnextact)" "";\
                        eq? $(sfnextact) Arrive eq? $(sfnextloc) shovel KSTATE 6  $(last_loadloc) "Next: $(sfnextact)" "";\
                        eq? $(sfnextact) Arrive eq? $(sfnextloc) dump   KSTATE 9  $(last_dumploc) "Next: $(sfnextact)" "";\
                        eq? $(sfnextact) Bucket KSTATE 7 $(last_loadloc) "Next: First Bucket" "";\
                        eq? $(sfnextact) Full   KSTATE 8 $(last_loadloc) "Next: $(sfnextact)" "";\
                        eq? $(sfnextact) "" KSTATE 10 "" "";
macro  dodown           last_stat 1;KSTATE 0 "Unknown" "Next: Log On" "";
macro  dospare          last_stat 3;KSTATE 0 "Unknown" "Next: Log On" "";
macro  dologon          ne? $(LogonVal) -1 KSTATE $(last_stat) "Unknown" "Next: Ready";\
                        eq? $(LogonVal) -1 KSTATE 0 "Unknown" "Log On";
#elif #class(shovel) || #class(loader) || #class(excav) || #class(lhd) || #class(ug_loader) || #class(loaderlp)
symbol sfsync	    1
symbol isTramming no
symbol toggleTram off
symbol dest        ''
in     KSTATE  0x41    b?sss    state $1;loc $2;w0.Icon icon:$(icon.$1);w0.v1 label:$(msg.$1);w0.v2 label:$3;\
                                rpc_arg1 $1;rpc_arg2 $2;rpc_arg3 $3;rpc_arg4 $4;\
                                eq? $1 6 setloadloc;\
                                eq? $1 9 setdumploc;\
                                eq? $1 25 setloadloc;\
                                setnextact;
/* We don't redefine KSTATE2 anymore. Now we use new feature that allows adding extra
 * code to end of standard rpc defs.
in     KSTATE2 0x32    b?ssssss state $1;loc $2;next $3;w0.Icon icon:$(icon.$1);\
                                w0.v1 label:$2;w0.v2 label:$3;w0.v3 label:$4;\
                                w0.Text write:$5;w0.Text write:\n;w0.v4 label:$6;WinMgr audio:$7;\
                                eq? $1 6 setloadloc;\
                                eq? $1 9 setdumploc;\
                                eq? $1 25 setloadloc2;\
                                eq? $1 7 eq? $(isTramming) no setloadloc2;\
                                eq? $1 7 ne? $(isTramming) no setloadloc;\
                                eq? $1 9 isTramming yes;\
                                setnextact;
 */
macro SF.kstate_extra           eq? $(rpc_arg1) 6 setloadloc;\
                                eq? $(rpc_arg1) 9 setdumploc;\
                                eq? $(rpc_arg1) 25 setloadloc2;\
                                eq? $(rpc_arg1) 7 eq? $(isTramming) no setloadloc2;\
                                eq? $(rpc_arg1) 7 ne? $(isTramming) no setloadloc;\
                                eq? $(rpc_arg1) 9 isTramming yes;\
                                setnextact;
macro  kpTrammode args 0;eq? $(isTramming) yes toggleTram no;ne? $(isTramming) yes toggleTram yes;isTramming $(toggleTram);req trammode;sendaction
macro  setMatl    w0.Icon icon:$(icon.$(state));w0.Matl label:$(matl.$(matl));last_matl $(matl.$(matl))
macro  kpArrive   dest '';\
                  eq? $(sfnextloc) dump   arrivedatdump;\
                  eq? $(sfnextloc) shovel arrivedatload;\
                  ARRIVE;\
                  KBEEP 1;\
                  SFDATA "$(last_loadloc)" "$(last_dumploc)"
macro  kpAssign   dest '';\
                  eq? $(sfnextloc) dump   assignedatload;\
                  eq? $(sfnextloc) shovel assignedatdump;\
                  ASSIGN;\
                  KBEEP 1
macro  kpChngLoc  sfmenu loc;doChngloc
macro  menuactionid  eq? $(sfmenu) loc last_loadloc $1;id $1;sendaction
#if #arch(pe)
macro  setloadloc foreach $(rpc_arg2);do setloadloc_pe;sfnextloc shovel;dest $(last_loadloc)
macro  setloadloc_pe foreach $2;do last_loadloc:\$2
macro  setdumploc foreach $(rpc_arg2);do setdumploc_pe;sfnextloc dump;dest $(last_dumploc)
macro  setdumploc_pe foreach $2;do last_dumploc:\$2
macro  setnextact foreach $(rpc_arg3);setnextact_pe;\
                  ne? $(temp) Ready ne? $(temp) On sfnextact $(temp);
macro  setnextact_pe foreach $2;do temp:\$2
#else
macro  setloadloc foreach $(rpc_arg2);do last_loadloc:\$2;sfnextloc shovel;dest $(last_loadloc)
macro  setdumploc foreach $(rpc_arg2);do last_dumploc:\$2;sfnextloc dump;dest $(last_dumploc)
macro  setnextact foreach $(rpc_arg3);do temp:\$2;\
                  ne? $(temp) Ready ne? $(temp) On sfnextact $(temp);
#endif
macro  mansetloadloc last_loadloc $(ob1);KSTATE 6  $(last_loadloc) "Next: Arrive"       "";\
                     sfnextloc $(last_loadloc);\
                     sfnextact Arrive;
macro  setloadloc2 last_loadloc $(rpc_arg4);sfnextloc shovel
symbol v4label
macro  adjstbeans v4label:$(w0.v4 label);\
                  foreach $(v4label);do temp:\$2;\
                  sfloads:$(+ $(temp) 1);\
                  w0.v4 label:"Loads: $(sfloads)";
macro   checkRpc  eq? $(noTalkRpc) ASSIGN  doSFLogic;\
                  eq? $(noTalkRpc) LOAD    doSFLogic;\
                  eq? $(noTalkRpc) FULL    doSFLogic;\
                  eq? $(noTalkRpc) ARRIVE  doSFLogic;\
                  eq? $(noTalkRpc) DELAY   doSFLogic;\
                  eq? $(noTalkRpc) DOWN    doSFLogic;\
                  eq? $(noTalkRpc) READY   doSFLogic;\
                  eq? $(noTalkRpc) STANDBY doSFLogic;\
                  eq? $(noTalkRpc) LOGON   doSFLogic;\
                  eq? $(noTalkRpc) PRESTART doSFLogic;\
                  eq? $(noTalkRpc) GPS-ARRIVE doSFLogic;\
                  eq? $(noTalkRpc) RFID-ARRIVE doSFLogic;\
                  eq? $1 setloc  doSFLogic;\
                  eq? $1 psitemcomment doSFLogic;\
                  ne? $(noTalkRpc) KSTATE ne? $(noTalkRpc) RFID-ARRIVE ne? $(noTalkRpc) RFID-DEPART ne? $(noTalkRpc) GPS-ARRIVE ne? $(noTalkRpc) GPS-DEPART ne? $(noTalkRpc) EQ-REQ ne? $(noTalkRpc) SFDATA ne? $(noTalkRpc) ASSIGN ne? $(noTalkRpc) LOAD ne? $(noTalkRpc) FULL ne? $(noTalkRpc) ARRIVE ne? $(noTalkRpc) DELAY ne? $(noTalkRpc) DOWN ne? $(noTalkRpc) READY ne? $(noTalkRpc) STANDBY ne? $(noTalkRpc) LOGON ne? $(noTalkRpc) PRESTART ne? $(noTalkRpc) EQ-REQ ne? $(noTalkRpc) KBEEP Ok action:'' label:"Can\'t $(noTalkRpc) during no comms." post;
macro   doSFLogic eq? $(noTalkRpc) DELAY   dodelay;\
                  eq? $(noTalkRpc) DOWN    dodown;\
                  eq? $(noTalkRpc) READY   doready;\
                  eq? $(noTalkRpc) STANDBY dospare;\
                  eq? $(noTalkRpc) ARRIVE  eq? $(state) 6    arrive6;\
                  eq? $(noTalkRpc) ARRIVE  eq? $(state) 9    arrive9;\
                  eq? $(noTalkRpc) FULL    eq? $(isTramming) yes fullistram;\
                  eq? $(noTalkRpc) FULL    ne? $(isTramming) yes fullnotram;\
                  eq? $(noTalkRpc) LOAD    eq? $(isTramming) yes doload;\
                  eq? $(noTalkRpc) LOGON   dologon;\
                  eq? $(noTalkRpc) PRESTART doprestart;\
                  eq? $(noTalkRpc) GPS-ARRIVE CheckAuto;\
                  eq? $(noTalkRpc) RFID-ARRIVE CheckAuto;\
                  eq? $1 setloc  mansetloadloc;\
                  eq? $(noTalkRpc) ASSIGN  eq? $(state) 7  assign7;\
                  eq? $(noTalkRpc) ASSIGN  eq? $(state) 10 assign10;\
                  eq? $(noTalkRpc) ASSIGN  eq? $(state) 13 assign13;\
                  eq? $(noTalkRpc) ASSIGN  eq? $(state) 9  assign9;
macro  assign7        KSTATE 9 $(last_dumploc) "Next: Arrive";
macro  assign9        KSTATE 6 $(last_loadloc) "Next: Arrive";\
                      adjstbeans;
macro  assign10       KSTATE 6 $(last_loadloc) "Next: Arrive";\
                      adjstbeans;
macro  assign13       KSTATE 9 $(last_loadloc) "Next: Arrive";\
                      adjstbeans
macro  doload         KSTATE 16 $(last_loadloc) "Next: Full";
macro  fullistram     KSTATE 9  $(last_dumploc) "Next: Arrive";
macro  fullnotram     KSTATE 7  $(last_loadloc) "Wait for Truck";
macro  arrive6        eq? $(isTramming) yes doload;
macro  arrive9        eq? $(isTramming) yes KSTATE 10 $(last_dumploc) "Next: Assign";
macro  arrivedatdump  dest $(last_dumploc);\
                      sfnextact Assign;\
                      sfnextloc load
macro  arrivedatload  dest $(last_loadloc);\
                      sfnextact Full;\
                      sfnextloc dump;
macro  assignedatdump dest $(last_loadloc);\
                      sfnextact Arrive;\
                      sfnextloc shovel;
macro  assignedatload dest $(last_dumploc);\
                      sfnextact Arrive;\
                      sfnextloc dump;
macro  doprestart	w0.Text write:"Pre-Start check Spooled.\n"
macro  dodelay        last_stat 4;KSTATE 4 "Unknown" "Next: Ready"  "";
macro  doready        last_stat 2;eq? $(sfnextloc) '' KSTATE 10 "" "";\
                      eq? $(sfnextact) Assign eq? $(sfnextloc) shovel KSTATE 10 $(last_dumploc) "Next: $(sfnextact)" "";\
                      eq? $(sfnextact) Assign eq? $(sfnextloc) dump   KSTATE 8  $(last_loadloc) "Next: $(sfnextact)" "";\
                      eq? $(sfnextact) Arrive eq? $(sfnextloc) shovel KSTATE 6  $(last_loadloc) "Next: $(sfnextact)" "";\
                      eq? $(sfnextact) Arrive eq? $(sfnextloc) dump   KSTATE 9  $(last_dumploc) "Next: $(sfnextact)" "";\
                      eq? $(sfnextact) Truck  KSTATE 7 $(last_loadloc) "Wait for Truck" "";\
                      eq? $(sfnextact) Full   KSTATE 8 $(last_loadloc) "Next: $(sfnextact)" "";
macro  dodown         last_stat 1;KSTATE 0 "Unknown" "Next: Log On" "";
macro  dospare        last_stat 3;KSTATE 0 "Unknown" "Next: Log On" "";
macro  dologon        ne? $(LogonVal) -1 KSTATE $(last_stat) "Unknown" "Next: Ready";\
                      eq? $(LogonVal) -1 KSTATE 0 "Unknown" "Log On";
#else
symbol sfsync	    0
in     KSTATE  0x41    b?sss    state $1;loc $2;w0.Icon icon:$(icon.$1);w0.v1 label:$(msg.$1);w0.v2 label:$3;\
                                rpc_arg1 $1;rpc_arg2 $2;rpc_arg3 $3;rpc_arg4 $4;
/* We don't redefine KSTATE2 anymore. Now we use new feature that allows adding extra
 * code to end of standard rpc defs.
in     KSTATE2 0x32    b?ssssss state $1;loc $2;next $3;w0.Icon icon:$(icon.$1);\
                                w0.v1 label:$2;w0.v2 label:$3;w0.v3 label:$4;\
                                w0.Text write:$5;w0.Text write:\n;WinMgr audio:$7;
 */
macro SF.kstate_extra	do_nothing 1
symbol do_nothing
macro   checkRpc  eq? $(noTalkRpc) DELAY   doSFLogic;\
                  eq? $(noTalkRpc) DOWN    doSFLogic;\
                  eq? $(noTalkRpc) READY   doSFLogic;\
                  eq? $(noTalkRpc) STANDBY doSFLogic;\
                  eq? $(noTalkRpc) LOGON   doSFLogic;\
                  eq? $(noTalkRpc) ARRIVE  doSFLogic;\
                  eq? $(noTalkRpc) ASSIGN  doSFLogic;\
                  eq? $(noTalkRpc) PRESTART doSFLogic;\
                  ne? $(noTalkRpc) KSTATE ne? $(noTalkRpc) RFID-ARRIVE ne? $(noTalkRpc) RFID-DEPART ne? $(noTalkRpc) GPS-ARRIVE ne? $(noTalkRpc) GPS-DEPART ne? $(noTalkRpc) EQ-REQ ne? $(noTalkRpc) DELAY ne? $(noTalkRpc) DOWN ne? $(noTalkRpc) READY ne? $(noTalkRpc) STANDBY ne? $(noTalkRpc) ASSIGN ne? $(noTalkRpc) ARRIVE ne? $(noTalkRpc) LOGON ne? $(noTalkRpc) PRESTART ne? $(noTalkRpc) EQ-REQ ne? $(noTalkRpc) KBEEP Ok action:'' label:"Can\'t $(noTalkRpc) during no comms." post;
macro   doSFLogic eq? $(noTalkRpc) DELAY   dodelay;\
                  eq? $(noTalkRpc) DOWN    dodown;\
                  eq? $(noTalkRpc) READY   doready;\
                  eq? $(noTalkRpc) STANDBY dospare;\
                  eq? $(noTalkRpc) LOGON   dologon;\
                  eq? $(noTalkRpc) ARRIVE  doauxprodarrive;\
                  eq? $(noTalkRpc) ASSIGN  doauxprodassign;\
                  eq? $(noTalkRpc) PRESTART doprestart
macro  dodelay    last_stat 4;KSTATE 4 "Unknown" "Next: Ready"  "";
macro  doready    last_stat 2;KSTATE 2 "Unknown" "Log Off?" "";
macro  dodown     last_stat 1;KSTATE 0 "Unknown" "Next: Log On" "";
macro  dospare    last_stat 3;KSTATE 0 "Unknown" "Next: Log On" "";
macro  dologon    ne? $(LogonVal) -1 KSTATE $(last_stat) "Unknown" "Next: Ready";\
                  eq? $(LogonVal) -1 KSTATE 0 "Unknown" "Log On";
macro  doprestart	w0.Text write:"Pre-Start check Spooled.\n"
macro  kpArrive   ARRIVE $(last_beacon)
macro  doauxprodarrive KSTATE2 7 "Performing Work" "Next:Travel";
macro  doauxprodassign KSTATE2 6 "Traveling..." "Next:Do Work";
#endif
