%!/psw/cpp
################################################
# New Status Menu Code
################################################

#ifdef NEWUI && #ifndef UGUI
macro	doStatus	eq? "$(KMENUreceived)$(reasonMenusBuilt)" "10" buildReasonMenus; menuType2 "NewStat";altMenuUpdt 1;PostDynamicMenu "Status"
#else
#include <NewStat/Newui_helper.cfg>
# override generic functionality of these macros to get proper updates
macro	statupdate	updtselect sendupdate;menutype NewStat;sendupdate
macro	doMenuUpdate	eq? "$(menutype)" "Status" EQ-REQ "update" "NewStat";ne? "$(menutype)" "Status" EQ-REQ "update" "$(menutype)"
#endif

# create some constants
#ifdef NEWUI
#	ifdef PORTRAIT
#	define BTNROWS	9
#	define C2BTNPERPAGE 18
#	define C3BTNPERPAGE 27
#	define C4BTNPERPAGE 36
#	else
#	define BTNROWS	6
#	define C2BTNPERPAGE 12
#	define C3BTNPERPAGE 18
#	define C4BTNPERPAGE 24	
#	endif
#else
#define	BTNROWS 5
#define C2BTNPERPAGE 10
#define	C3BTNPERPAGE 15
#define C4BTNPERPAGE 20
#endif
symbol	newstat	1
symbol	menudbg	0
symbol	menuid
symbol	menuargs
symbol	menuarg0
symbol	menuarg1
symbol	menuarg2
symbol	menuarg3
symbol	menuarg4
symbol	menuarg5
symbol	temparg
symbol	arglist0	0
symbol	arglist1	0 1
symbol	arglist2	0 1 2
symbol	arglist3	0 1 2 3
symbol	arglist4	0 1 2 3 4
symbol	arglist5	0 1 2 3 4 5
symbol	arglist6	0 1 2 3 4 5 6
symbol	arglist10	0 1 2 3 4 5 6 7 8 9
symbol	arglist12	0 1 2 3 4 5 6 7 8 9 10 11
symbol	arglist15	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14
symbol	arglist18	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17
symbol	arglist20	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19
symbol	arglist24	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
symbol	arglist27	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26
symbol	arglist36	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35
symbol	delayrsnKMENUcount 0
symbol	downrsnKMENUcount 0
symbol	readyrsnKMENUcount 0
symbol	sparersnKMENUcount 0
symbol	delayrsnKMENU1
symbol	downrsnKMENU1
symbol	readyrsnKMENU1
symbol	sparersnKMENU1
symbol	delayrsnKMENU2
symbol	downrsnKMENU2
symbol	readyrsnKMENU2
symbol	sparersnKMENU2
symbol	delayrsnKMENU3
symbol	downrsnKMENU3
symbol	readyrsnKMENU3
symbol	sparersnKMENU3
symbol	delayrsnKMENU4
symbol	downrsnKMENU4
symbol	readyrsnKMENU4
symbol	sparersnKMENU4
symbol	delayrsnKMENU5
symbol	downrsnKMENU5
symbol	readyrsnKMENU5
symbol	sparersnKMENU5
symbol	delayrsnKMENU6
symbol	downrsnKMENU6
symbol	readyrsnKMENU6
symbol	sparersnKMENU6
symbol	delayrsnKMENU7
symbol	downrsnKMENU7
symbol	readyrsnKMENU7
symbol	sparersnKMENU7
symbol	delayrsnKMENU8
symbol	downrsnKMENU8
symbol	readyrsnKMENU8
symbol	sparersnKMENU8
symbol	delayrsnKMENU9
symbol	downrsnKMENU9
symbol	readyrsnKMENU9
symbol	sparersnKMENU9
symbol	delayrsnKMENU10
symbol	downrsnKMENU10
symbol	readyrsnKMENU10
symbol	sparersnKMENU10
symbol	delayrsnKMENU11
symbol	downrsnKMENU11
symbol	readyrsnKMENU11
symbol	sparersnKMENU11
symbol	delayrsnKMENU12
symbol	downrsnKMENU12
symbol	readyrsnKMENU12
symbol	sparersnKMENU12
symbol	delayrsnKMENU13
symbol	downrsnKMENU13
symbol	readyrsnKMENU13
symbol	sparersnKMENU13
symbol	delayrsnKMENU14
symbol	downrsnKMENU14
symbol	readyrsnKMENU14
symbol	sparersnKMENU14
symbol	delayrsnKMENU15
symbol	downrsnKMENU15
symbol	readyrsnKMENU15
symbol	sparersnKMENU15
symbol	delayrsnKMENU16
symbol	downrsnKMENU16
symbol	readyrsnKMENU16
symbol	sparersnKMENU16
symbol	delayrsnKMENU17
symbol	downrsnKMENU17
symbol	readyrsnKMENU17
symbol	sparersnKMENU17
symbol	delayrsnKMENU18
symbol	downrsnKMENU18
symbol	readyrsnKMENU18
symbol	sparersnKMENU18
symbol	delayrsnKMENU19
symbol	downrsnKMENU19
symbol	readyrsnKMENU19
symbol	sparersnKMENU19
symbol	delayrsnKMENU20
symbol	downrsnKMENU20
symbol	readyrsnKMENU20
symbol	sparersnKMENU20
symbol	delayrsnKMENU21
symbol	downrsnKMENU21
symbol	readyrsnKMENU21
symbol	sparersnKMENU21
symbol	delayrsnKMENU22
symbol	downrsnKMENU22
symbol	readyrsnKMENU22
symbol	sparersnKMENU22
symbol	delayrsnKMENU23
symbol	downrsnKMENU23
symbol	readyrsnKMENU23
symbol	sparersnKMENU23
symbol	delayrsnKMENU24
symbol	downrsnKMENU24
symbol	readyrsnKMENU24
symbol	sparersnKMENU24
symbol	delayrsnKMENU25
symbol	downrsnKMENU25
symbol	readyrsnKMENU25
symbol	sparersnKMENU25
symbol	delayrsnKMENU26
symbol	downrsnKMENU22
symbol	readyrsnKMENU26
symbol	sparersnKMENU26
symbol	delayrsnKMENU27
symbol	downrsnKMENU27
symbol	readyrsnKMENU27
symbol	sparersnKMENU27
symbol	delayrsnKMENU28
symbol	downrsnKMENU28
symbol	readyrsnKMENU28
symbol	sparersnKMENU28
symbol	delayrsnKMENU29
symbol	downrsnKMENU29
symbol	readyrsnKMENU29
symbol	sparersnKMENU29
symbol	delayrsnKMENU30
symbol	downrsnKMENU30
symbol	readyrsnKMENU30
symbol	sparersnKMENU30
symbol	tempKMENU
symbol	tempKMENUcount
symbol	KMENUreceived 0
symbol	reasonMenusBuilt 0

in KMENU_NEW	0x078a	s[s] $1KMENUcount $(+ $($1KMENUcount) 1); $1KMENU$($1KMENUcount) $2; KMENUreceived 1; reasonMenusBuilt 0
macro	createKMENUsymbol Macro symbol $(menuid)KMENU$($(menuid)KMENUcount) $(tempKMENU)
macro	handlekmenu	temparg $2;parsekmenuarg
macro	parsekmenuarg	foreach $(temparg);do settempargs
macro	settempargs	menuargs $1;menuarg$1 $2
macro	createmenuinfo	updateItemCnt;foreach $(arglist$(menuargs));do 'temp1 \$1;createmenusym'
macro	createmenusym	Macro symbol $(menuid).$(menuarg0).$(temp1) $(menuarg$(temp1))
macro	updateItemCnt	eq? $($(menuid)Items) $(min $(menuarg0) $($(menuid)Items)) $(menuid)Items $(menuarg0)

macro	buildReasonMenus KDISP $(buildingMenusMsg); getdelayrsns; getdownrsns; getreadyrsns; getsparersns; reasonMenusBuilt 1; KDISP $(menusBuiltMsg)
macro	getdelayrsns	menuid delayrsn; getreasons
macro	getdownrsns	menuid downrsn;  getreasons
macro	getreadyrsns	menuid readyrsn; getreasons
macro	getsparersns	menuid sparersn; getreasons
macro	getreasons	tempKMENUcount 0; ne? $($(menuid)KMENUcount) 0 loopKMENU
macro	loopKMENU	tempKMENUcount $(+ $(tempKMENUcount) 1); foreach $($(menuid)KMENU$(tempKMENUcount)); do 'handlekmenu;createmenuinfo'; loopKMENU1
macro	loopKMENU1	ne? $(tempKMENUcount) $($(menuid)KMENUcount) loopKMENU

macro doClearStatusMenus	delayrsnKMENUcount 0; downrsnKMENUcount 0; readyrsnKMENUcount 0; sparersnKMENUcount 0; \
				foreach $(listStatusMenus);do '\$2 items;currStatusMenu \$2;doClearStatusSubMenus'

symbol	MenuPage
symbol	MenCols
symbol	MenuAct
symbol	MenuCfg
symbol	BtnPerPg
symbol	pgBtn
symbol	menBtn
symbol	lastMPage
symbol	temp1
symbol	tempPage
symbol	mapBtn
symbol	openMen
symbol	GenMenuTitle
symbol	startBtn
symbol	lastBtn
symbol	btnColor	default
symbol	menCleanup	0
symbol	intRpcArg1
symbol	intRpcArg2
macro	doMenuClose	closeGenMenu
in 	doMenuAct 	INT_RPC	d	pgBtn $1;calcMenBtn;$(MenuAct)
in	CfgGenMenu	INT_RPC	s?s	intRpcArg1 $1;\
                                        eq? $(menCleanup) 0 eq? "$1" "Rdy" ldRdyMen;\
					eq? $(menCleanup) 0 eq? "$1" "Dwn" ldDwnMen;\
					eq? $(menCleanup) 0 eq? "$1" "Dly" ldDlyMen;\
					eq? $(menCleanup) 0 eq? "$1" "Spr" ldSprMen;\
                                        eq? $(menCleanup) 1 WinMgr after:1:'CfgGenMenu "$(intRpcArg1)"'
macro	doMenuPrev	tempPage $(MenuPage);ne? $(tempPage) 0 MenuPage $(- $(tempPage) 1);eq? $(tempPage) 0 MenuPage $(lastMPage);loadMenuPage
macro	doMenuNext	tempPage $(MenuPage);ne? $(tempPage) $(lastMPage) MenuPage $(+ $(tempPage) 1);eq? $(tempPage) $(lastMPage) MenuPage 0;loadMenuPage
macro	calcMenBtn	temp1 $(* $(BtnPerPg) $(MenuPage));menBtn $(+ $(temp1) $(pgBtn))
macro	setNoScroll	GenMenu.Prev map:n;GenMenu.Next map:n;GenMenu.Update map:n;GenMenu.Update2 map:y
macro	resetGenMenu	btnColor default;GenMenu.Update2 map:n;GenMenu.Prev map:y;GenMenu.Next map:y;GenMenu.Update map:y;calcLastMPage
macro	calcLastMPage	lastMPage $(/ $($(openMen)Items) $(BtnPerPg));eq? $(% $($(openMen)Items) $(BtnPerPg)) 0 lastMPage $(- $(lastMPage) 1)
#macro	loadMenuPage	startBtn $(+ 1 $(* $(MenuPage) $(BtnPerPg)));pgBtn 0;For $(BtnPerPg) mapMenuBtns
macro	loadMenuPage	startBtn $(+ 1 $(* $(MenuPage) $(BtnPerPg)));pgBtn 0;foreach $(arglist$(BtnPerPg));do mapMenuBtns
macro	mapMenuBtns	mapBtn 1;eq? $(+ 1 $($(openMen)Items)) $(min $(+ 1 $($(openMen)Items)) $(+ $(startBtn) $(pgBtn))) mapBtn 0;eq? $(mapBtn) 0 noMapBtn;eq? $(mapBtn) 1 $(MenuCfg);pgBtn $(+ 1 $(pgBtn))
macro	noMapBtn	GenMenu.C$(MenCols).$(pgBtn) map:n
#macro	closeGenMenu	pgBtn 0;UnpostWindow "GenMenu";For $(BtnPerPg) clearBtns;w0.Text write:"Buttons cleared\n"
macro	closeGenMenu	menCleanup 1;GenMenu.Loading map:y;pgBtn 0;UnpostWindow "GenMenu";foreach $(arglist$(BtnPerPg));do clearBtns;GenMenu.Loading map:n;menCleanup 0
macro	clearBtns	noMapBtn;pgBtn $(+ 1 $(pgBtn))

/* Status Reason Menus */
#ifndef STATMENCOLS
#	define STATMENCOLS 3
#endif
symbol	statRpc
symbol	readyrsnItems	0
symbol	delayrsnItems	0
symbol	downrsnItems	0
symbol	sparersnItems	0
macro	doReadyMenu	PostWindow "GenMenu" MENU_LAYER;CfgGenMenu "Rdy"
macro	doDownMenu	PostWindow "GenMenu" MENU_LAYER;CfgGenMenu "Dwn"
macro	doDelayMenu	PostWindow "GenMenu" MENU_LAYER;CfgGenMenu "Dly"
macro	doSpareMenu	PostWindow "GenMenu" MENU_LAYER;CfgGenMenu "Spr"
macro	doGlobalStat	BtnPerPg $(* BTNROWS STATMENCOLS);resetGenMenu;MenuAct sendStat;MenCols STATMENCOLS;MenuPage 0;MenuCfg statMenuCfg;eq? $(BtnPerPg) $(max $(BtnPerPg) $($(openMen)Items)) setNoScroll
macro	ldRdyMen	GenMenuTitle $(RdyMenTitle);openMen readyrsn;doGlobalStat;statRpc READY;btnColor Ready;loadMenuPage
macro	ldDwnMen	GenMenuTitle $(DwnMenTitle);openMen downrsn;doGlobalStat;statRpc DOWN;btnColor Down;loadMenuPage
macro	ldDlyMen	GenMenuTitle $(DlyMenTitle);openMen delayrsn;doGlobalStat;statRpc DELAY;btnColor Delay;loadMenuPage
macro	ldSprMen	GenMenuTitle $(SprMenTitle);openMen sparersn;doGlobalStat;statRpc STANDBY;btnColor Standby;loadMenuPage
macro	sendStat	$(statRpc) $($(openMen).$(+ 1 $(menBtn)).2);closeGenMenu
macro	statMenuCfg	eq? $($(openMen).$(+ $(startBtn) $(pgBtn)).1) 1 statIconBtn;eq? $($(openMen).$(+ $(startBtn) $(pgBtn)).1) 0 statLabelBtn
macro	statLabelBtn	GenMenu.C$(MenCols).$(pgBtn) map:y label:$($(openMen).$(+ $(startBtn) $(pgBtn)).3) colors:$(btnColor) icon:$(nil)
macro	statIconBtn	GenMenu.C$(MenCols).$(pgBtn) map:y icon:$($(openMen).$(+ $(startBtn) $(pgBtn)).3) colors:$(btnColor) label:""

#ifndef LANGUAGE
#	define LANGUAGE English
#endif
#define LANG_FILE	<NewStat/LANGUAGE/Macro.cfg>
#include LANG_FILE
