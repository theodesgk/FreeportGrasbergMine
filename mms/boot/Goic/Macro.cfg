%!/psw/cpp
/*
 * * * * * * * * * * * * * * * * * * *
 *  DISPATCH Real-Time Firmware Module
 * Copyright (c) Modular Mining Systems, 1982-1998
 *               All Rights Reserved
 *  $RCSfile: Macro.cfg,v $
 * $Revision: 1.32 $
 *   $Author: olivas $
 *     $Date: 2014/06/04 16:03:07 $
 *    $State: Exp $
 *   Purpose: GOIC configuration common to all clients, equipment,
 *	      and languages.
 * * * * * * * * * * * * * * * * * * *
 */
#include <Version.h>
#if #arch(cgc)
	stack 4096
#endif
in	KDISP	0x40	s	w0.Text write:$1\n;do_kdisp_extra
#if #class(truck)
in	KSTATE	0x41	b?sss	state $1;loc $2;w0.Icon icon:$(icon.$1);w0.v1 label:$(msg.$1);w0.v2 label:$3;do_kstate_extra
#endif
#if #class(shovel) || #class(drill) || #class(loader)
in	KSTATE	0x41	b?sss	state $1;w0.Icon icon:$(icon.$1);w0.v1 label:$2;w0.v2 label:$3;w0.v3 label:$4;do_kstate_extra
#endif
in	KASK	0x43	ssss	$2 label:$1 action:$4 post;do_kask_extra
#if #class(shovel) || #class(loader)
in	KMATL	0x44	s?ss	matl.0 $1;matl.1 $2;matl.2 $3;setMatl
#endif

in	MAYDAY	0x64	sss	MessageBox '$1' '$2' '$3'

/* internal RPCs can have the same hex number */
#define INT_RPC 0xa000

symbol	actwin	w0
symbol	lastwin

/* MsgBox */
#if #arch(pe.net)
	macro	setDefaultValue eq? "$(defaultValue)" " " defaultValue Ok
	macro	doMsgBoxClose   MsgBox map:n
#else
	macro	setDefaultValue eq? "$(defaultValue)" "" defaultValue Ok
	macro	doMsgBoxClose   WinMgr window:$(lastwin)
#endif

message	nil
symbol	n
symbol	defaultValue
symbol	msgBoxAction
symbol	msgBoxAction2
macro	MsgBoxOk        MsgBox.Ok map:y;MsgBox.Btn1 map:n;MsgBox.Btn2 map:n
macro	MsgBoxYesNo     MsgBox.Ok map:n;MsgBox.Btn1 label:"$(YesLbl)" action:doMsgBoxYes map:y;MsgBox.Btn2 label:"$(NoLbl)" action:doMsgBoxNo map:y
macro	MsgBox2Btn      msgBoxAction2 $7;MsgBox.Ok map:n;MsgBox.Btn1 label:"$5" action:doMsgBoxBtn1 map:y;MsgBox.Btn2 label:"$6" action:doMsgBoxBtn2 map:y
in	MessageBox      INT_RPC s?ssssss        MsgBox.Label label:$1;MsgBox.Title label:"";MsgBox.Title label:$2;msgBoxAction $3;defaultValue "";defaultValue $4;setDefaultValue;MsgBox$(defaultValue);WinMgr window:MsgBox
macro	doMsgBoxOk      $(msgBoxAction);msgBoxAction "";doMsgBoxClose
macro	doMsgBoxYes     doMsgBoxOk
macro	doMsgBoxNo      doMsgBoxClose
macro	doMsgBoxBtn1    doMsgBoxOk
macro	doMsgBoxBtn2    $(msgBoxAction2);msgBoxAction2 "";doMsgBoxClose

/* Weight Station MessageBox, in principle useful for trucks only */
macro	WeightMsg	MessageBox "$(ReadyToWeighLbl)" "" "EQ-REQ reqweight" "2Btn" "$(OkLbl)" "$(CancelLbl)" ""

/* Symbol for no comms time-out period */
symbol noCommsTime 5
/*
 * define symbols and  macros for extra stuff that is done for standard rpcs
 * that can be defined for load options
 */
symbol	kstate_extra
symbol	kdisp_extra
symbol	kack_extra
symbol	kask_extra
symbol	kbeep_extra
symbol	rpc_arg1
symbol	rpc_arg2
symbol	rpc_arg3
symbol	rpc_arg4
symbol	rpc_arg5
symbol	rpc_arg6
symbol	rpc_arg7
symbol	rpc_arg8
symbol	rpc_arg9
symbol	rpc_arg10
macro	do_kstate_extra save_kstate_args;foreach $(kstate_extra);do \$2.kstate_extra
macro	save_kstate_args rpc_arg1 $1;rpc_arg2 $2;rpc_arg3 $3;rpc_arg4 $4;rpc_arg5 $5;rpc_arg6 $6;rpc_arg7 $7
macro	do_kdisp_extra save_kdisp_args;foreach $(kdisp_extra);do \$2.kdisp_extra
macro	save_kdisp_args rpc_arg1 $1
macro	do_kack_extra save_kack_args;foreach $(kack_extra);do \$2.kask_extra
macro	save_kack_args rpc_arg1 $1;rpc_arg2 $2
macro	do_kask_extra save_kask_args;foreach $(kask_extra);do \$2.kack_extra
macro	save_kask_args rpc_arg1 $1;rpc_arg2 $2;rpc_arg3 $3;rpc_arg4 $4

/* KSTATE3 is used for NEWUI but declare the rpc for any equipment
   that does not have NEWUI but receives KSTATE3 from Dispatch for
   some reason */
symbol	kstate3_recv	0
in      KSTATE3 0x33    b?ssssss kstate3_recv 1;Handleks3req$1
#if #arch(pe.net)
#	ifndef DELITE
	macro	Handleks3req9	Report operatorId:$3
#	endif
#endif
symbol	timeKack	1
symbol	titleKack	""
macro	doKack	Ok label:$(pressOk);Ok label:'$(titleKack)' action:'' post;WinMgr after:$(timeKack):beepOn: after:30:noOk:;do_kack_extra
in	KACK	0x46	b?s	timeKack $1;titleKack "$2";WinMgr after:1:doKack
in	KSIM	0x48	b	state $1;w0.Icon icon:$(icon.$1)
in	KMENU	0x49	s[s]	$1 items:$2
in	KBCST	0x4a	bss	eq? $2 CLASS getBcst;eq? "$2" "all" getBcst;eq? "$2" "ml" getBcst
in	KTABLE	0x4b	ss[s]	$1.title label:"$2";foreach $3;do $1.t\$1 label:"\$2"
in      KTABLE2 0x4c    ssd[s]  $1.title label:"$2";tbl_win $1;tbl_offset $3;foreach $4;do ktbl_pop
macro   ktbl_pop        $(tbl_win).t$(+ $(tbl_offset) $1) label:"$2"
symbol  tbl_win
symbol  tbl_offset
macro	getBcst	w0.Text write:$3\n;KBEEP $1
in	KRESET	0x4d	v	ObjSh reset
in	KINIT	0x4e	v	echo KINIT not implemented...
in	KBLINK	0x4f	sb?s	$1 blink:$(* $2 5):blink:default
in	KD1	0x50	s	w0.v1 label:$1
in	KD2	0x51	s	w0.v2 label:$1
in	KD3	0x52	s	w0.v3 label:$1
in	KCONTRAST 0x53	b	w0.Sl2 value:$1
in	KVAR	0x55	ss	w0.$1 label:$2
in	KPRSM	0x42	ss	w1.$1 label:$2
in	KLIGHT	0x56	b	w0.Sl1 value:$1
in	KSCROLL	0x58	s	w0.Text write:$1\n
in	KBEEP	0x5a	b	ne? $1 0 WinMgr beep:-1 after:$1:beepOff:
in	KDACK	0x5b	s	w0.Text write:$1\n;KACK 5
in	KSHOVEL	0x5c	bdsss	matl $1;setMatl;w0.v1 label:$3;w0.v2 label:$4;w0.v3 label:$5
#if #class(truck)
in	KTBCST	0x5e	bs	w0.Text write:$2\n;KBEEP $1
in	KSBCST	0x5f	bs
#include <WeighSystem.h>
#endif
#if #class(shovel) || #class(lhd) || #class(loader)
in	KTBCST	0x5e	bs
in	KSBCST	0x5f	bs	w0.Text write:$2\n;KBEEP $1
#include <WeighSystem.h>
#endif
#if #class(lhd) || #class(train)
#include <RfTag.h>
#endif
in	CP-SWITCH 0x18a b	eq? $1 1 WinMgr press:w0.Icon
out	CP-PING	0x18b	s,d	sendto up
out	CP-CELL	0x193	v,d	sendto up
in	KBD-REMOTE 0x19f d	kbd.$1
out	LOCAL-ID 0x301	d,d	sendto up
out	REPT-REQ 0x290	ss	sendto up
/*
 * Define rpc to query the Hub for its OMS Com Status
 * (includes special case for UGUI loaded on PTX)
 */
#if #arch(pe.net)
out	GET-HUB-COMSTAT 0xa000	v 	hub_commstat $(OMS connected)
symbol  hub_commstat no
#else
out	GET-HUB-COMSTAT 0xa000	v 	sendto up
symbol  hub_commstat no
in	SET-HUB-COMSTAT 0xa001  s	hub_commstat $1
#endif

macro	kbd.1	WinMgr event:pick
macro	kbd.2	WinMgr event:right
macro	kbd.4	WinMgr event:left
macro	kbd.8	WinMgr event:up
macro	kbd.16	WinMgr event:down
symbol	state	0
symbol	Kpinit	''
symbol	loc	none
symbol	icon.0	logo
symbol	icon.1	down
symbol	icon.2	ready
symbol	icon.3	standby
symbol	icon.4	delay
symbol	icon.5	tiedown
#if #class(truck)
symbol	icon.6	empty
symbol	icon.7	waiting
symbol	icon.8	loading
symbol	icon.9	hauling
symbol	icon.10	dumping
macro	rpc.0	kpLogOn
macro	rpc.1	kpReady
macro	rpc.2	kpAssign
macro	rpc.3	kpReady
macro	rpc.4	kpReady
macro	rpc.5	kpLogOn
macro	rpc.6	kpArrive
macro	rpc.7	kpLoad
macro	rpc.8	kpFull
macro	rpc.9	kpArrive
macro	rpc.10	kpAssign
#endif
#if #class(shovel) || #class(loader)
symbol	icon.6	left
symbol	icon.7	right
macro	rpc.0	kpLogOn
macro	rpc.1	kpReady
macro	rpc.2	kpIdle
macro	rpc.3	kpReady
macro	rpc.4	kpReady
macro	rpc.5	kpLogOn
macro	rpc.6	kpFull
macro	rpc.7	kpFull
symbol	matl	0
symbol	mst.0	6
symbol	mst.1	7
symbol	mst.2	8
macro	setMatl	state $(mst.$(matl));w0.Icon icon:$(icon.$(state));w0.Matl label:$(matl.$(matl))
macro kpFull  FULL $(matl) $(matl.$(matl))
#endif
macro	kpCallFuel	kpFuel
macro	doEmergency	kpHelp
macro	none	''
macro	beepOn	WinMgr beep:-1
macro	beepOff	WinMgr beep:0
macro	gotOk	WinMgr beep:0 cancel:beepOn: cancel:noOk:
macro	noOk	WinMgr beep:0;Ok unpost;Macro NOOK:0
/*macro	noTalk	Ok action:'' label:"Can't send $2 to $1" post*/
macro   timeoutOk  Ok unpost
macro	noTalk	Ok action:'' label:$(msg.256) post;ne? $(noCommsTime) 0 WinMgr after:$(noCommsTime):timeoutOk
symbol sfdobeep     0
symbol doCommsBeep 1 
symbol	commstat
symbol operResponse
macro checkYesNoResponse eq? $(operResponse) 1 sfdobeep 0;\
                         eq? $(operResponse) 0 sfdobeep 1
macro  doGoodComms    w0.Comm icon: wifi_on;eq? $(sfdobeep) 1 goodCommsInf
macro  showGoodComms  w0.Comm icon: wifi_on
macro  goodCommsInf	KBEEP 1;w0.Text write:"$(GoodCommsLbl)\n"
macro  doBadComms     w0.Comm icon: wifi_off;eq? $(sfdobeep) 1 badCommsInf
macro  showBadComms   w0.Comm icon: wifi_off
macro  badCommsInf	KBEEP 1;w0.Text write:"$(BadCommsLbl)\n"
macro  switchcomms    eq? $(up) Slip hub_commstat $(OMS connected);\
                      ne? $(up) Slip GET-HUB-COMSTAT;\
                      commstat $(hub_commstat);\
                      eq? $(commstat) yes doGoodComms;\
                      ne? $(commstat) yes doBadComms;
#if #arch(pe.net)
macro  checkcomms     eq? $(up) Slip hub_commstat $(OMS connected);\
                      ne? $(up) Slip GET-HUB-COMSTAT;\
                      ne? $(hub_commstat) $(commstat) switchcomms
macro  initcomms      GET-HUB-COMSTAT;\
                      commstat $(hub_commstat);\
                      eq? $(commstat) yes w0.Comm icon: wifi_on;\
                      ne? $(commstat) yes w0.Comm icon: wifi_off;\
                      Vsms every:5000:checkcomms
#else
macro  checkcomms     eq? $(up) Slip hub_commstat $(OMS connected);\
                      ne? $(up) Slip GET-HUB-COMSTAT;\
                      ne? $(hub_commstat) $(commstat) switchcomms;\
                      WinMgr after:5:checkcomms
macro  initcomms      GET-HUB-COMSTAT;\
                      commstat $(hub_commstat);\
                      eq? $(commstat) yes w0.Comm icon: wifi_on;\
                      ne? $(commstat) yes w0.Comm icon: wifi_off;\
                      WinMgr after:5:checkcomms;
#endif
macro	Init	Macro KSTATE:0;WinMgr focus:w0.Icon
macro	PowerUp	Macro PWRUP:Goic, vVERSION
symbol  ks3arg
macro   Handleks3arg6 ks3arg $1
macro   Handleks3arg7 ks3arg $1
#ifdef OPT1
#	define OBJECT Macro
#	include <Cfg/Options.cfg>
#endif
