/*
 * Pattern/Project/Topography-related macros
 */

/*
 * Operator has requested a project that the machine is
 * either allocated to or is presently inside of
 */
macro   kpAcquireData           CMObjectName Info;\
                                eq? $(allowProjectRequest) 1 requestProject


/*
 * Operator has requested a project that's nearby
 */
/*
 * Set the appropriate ComMgr command based on which type of
 * request is set in the reqObjectName variable
 */
symbol  CMObjectName

/*
 * Instruct the ComMgr object to send a request
 * for a project to central. Turn off the ability to
 * request projects until the current request is dealt
 * with
 */

symbol	noResponse
symbol	allowProjectRequest	1
symbol	allowYesNoDisplay

macro   requestProject  noResponse 0;\
                        ComMgr checkifneedtorequestinterval:1 waitBeforeLoadingDB:0 \
			request$(CMObjectName)FromCentralComputer;\
                        allowProjectRequest 0;\
                        allowYesNoDisplay 1;\
			ProjectUpdate
						

symbol	updateLabel

macro	InitUpdate		wUpdate.t0 clear;\
				wUpdate.t0 write:"  $(cfgLbl.$(updateLabel))";\
				counter 0

macro	AnimateUpdate		wUpdate.t0 write:".";\
				eq? $(counter) 5 InitUpdate;\
				counter $(+ $(counter) 1);\
				eq? "$(actwin)" "wUpdate" WinMgr after:1:AnimateUpdate

macro   PostUpdateWindow	InitUpdate;\
				WinMgr window:wUpdate;\
				AnimateUpdate

macro	ReliefUpdate		updateLabel 52;\
				eq? $(actwin) hp PostUpdateWindow;\
				eq? $(actwin) wProject PostUpdateWindow

macro	ProjectUpdate		updateLabel 53;\
				eq? $(actwin) hp PostUpdateWindow;\
				eq? $(actwin) wProject PostUpdateWindow

macro	DiglineUpdate		updateLabel 54;\
				eq? $(actwin) hp PostUpdateWindow;\
				eq? $(actwin) wProject PostUpdateWindow

macro	MaterialUpdate		updateLabel 55;\
				eq? $(actwin) hp PostUpdateWindow;\
				eq? $(actwin) wProject PostUpdateWindow

symbol	newWindow
symbol	actmenu None

macro	EndUpdate		newWindow hp;\
				eq? $(actwin) w0 newWindow w0;\
				eq? $(actwin) wScreen newWindow wScreen;\
				eq? $(allowProjectRequest) 0 WinMgr after:30:CheckProjectStatus;\
				allowProjectRequest 1;\
				eq? $(actmenu) None WinMgr window:$(newWindow)

macro   LoadProject     	ComMgr setGeoData:$1

macro	CheckProjectStatus	eq? "$(ComMgr project)" "none" Ok label:'\$(cfgLbl.35)' post

macro	DeleteProject		ComMgr resetFillAndCutModel

#if #class(drill)
macro	DeleteProject		ComMgr cancelPattern;\
				ShowTarget
symbol  cfgReference
symbol	DelPatternIndex
macro 	DelPatternList		DelPattern item:$(cfgLbl.106);\
                                DelPatternIndex 0;\
				eq? $(cfgLbl.106) $1 DelPatternIndex 1;\
				eq? Update $1 DelPatternIndex 2;\
				eq? $(cfgLbl.216) $1 DelPatternIndex 3;\
				DelPatternMacro

macro	PatternMenus		ne? "$(Pattern item)" Update Pattern item:Update

macro	PatternListMenu		Pattern item:Update;\
				REQ-PROJECT $1

macro	DelCurrentPattern	EQ-REQ "Delete" [ "$(ComMgr pattern)" ] ;\
				DeleteProject

macro 	DelPatternMacro		eq? $(DelPatternIndex) 0 EQ-REQ "Delete" [ $1 ];\
                                eq? $(DelPatternIndex) 1 EQ-REQ $1;\
				eq? $(DelPatternIndex) 2 EQ-REQ $1;\
				eq? $(DelPatternIndex) 3 DelCurrentPattern

#endif

symbol	cfgParam
symbol	methodName

symbol	counter
symbol	total
symbol	digit
symbol	startFrom

macro	ToggleProjectValues	wProject.outline1 map:y;\
				foreach $(cfgLbl.$(cfgParam));do wProject.vlbl\$1 map:y;\
				foreach $(cfgLbl.$(cfgParam));do wProject.tlbl\$1 label:"\$2" map:y;\
				wProject.14 map:y;\
				foreach '0 1 2 3 4 5 6 7 8 9 10 11 12 13';do wProject.\$1 map:n;\
				wProject.Kp map:n

macro	ToggleProjectKeypad	foreach '0 1 2 3 4 5 6 7 8 9 10 11 12 13';do wProject.\$1 map:y;\
				wProject.Kp map:y;\
				wProject.14 map:n;\
				foreach '0 1 2 3 4 5 6';do wProject.vlbl\$1 map:n;\
				foreach '0 1 2 3 4 5 6';do wProject.tlbl\$1 map:n;\
				wProject.outline1 map:n

macro	NextProjectLabel	wProject.vlbl$(counter) label:$(wProject.Kp label);\
             			counter $(+ $(counter) 1);\
				wProject.Kp label:"$(cfgLbl.$(+ $(counter) $(startFrom)))";\
				eq? $(counter) $(- $(total) 1) wProject.12 action:'NextProjectLabel;ToggleProjectValues'

macro	AppendDigit	eq? "$(wProject.Kp label)" "$(cfgLbl.$(+ $(counter) $(startFrom)))" wProject.Kp label:"";\
			wProject.Kp append:$(digit)

#if #class(dozer) || #class(grader)
macro	SetStartPoint	wProject.vlbl0 label:$(ComMgr bladePosX);\
			wProject.vlbl1 label:$(ComMgr bladePosY);\
			wProject.vlbl2 label:$(ComMgr bladeElev);\
			eq? $(holder) 1 wProject.12 action:'SetEndPoint';\
			eq? $(holder) 1 wProject.Kp label:"$(cfgLbl.38)"
#elif #class(shovel) || #class(loader)
macro	SetStartPoint	wProject.vlbl0 label:$(ComMgr centerPosX);\
			wProject.vlbl1 label:$(ComMgr centerPosY);\
			wProject.vlbl2 label:$(ComMgr filteredCenterElev);\
			eq? $(holder) 1 wProject.12 action:'SetEndPoint';\
			eq? $(holder) 1 wProject.Kp label:"$(cfgLbl.38)"
#endif

macro	SetEndPoint	wProject.vlbl3 label:$(ComMgr centerPosX);\
			wProject.vlbl4 label:$(ComMgr centerPosY);\
			wProject.vlbl5 label:$(ComMgr filteredCenterElev);\
			CheckPoints

macro	SetStartPointPattern	wProject.vlbl10 label:$(ComMgr actPosX);\
				wProject.vlbl11 label:$(ComMgr actPosY);\
				wProject.vlbl12 label:$(ComMgr filteredCenterElev);\
                                hp.First map:no;\
                                hp.Second map:yes


macro	SetEndPointPattern	wProject.vlbl13 label:$(ComMgr actPosX);\
				wProject.vlbl14 label:$(ComMgr actPosY);\
				wProject.vlbl15 label:$(ComMgr filteredCenterElev);\
                                hp.Second map:no;\
                                WinMgr window:wProject;\
                                cfgParam 200;\
                                Pattern0;\
                                eq? $(cfgReference) 0 cfgParam 212;\
                                eq? $(cfgReference) 1 cfgParam 214

macro	SetStartPointRamp	wProject.vlbl10 label:$(ComMgr bladePosX);\
				wProject.vlbl11 label:$(ComMgr bladePosY);\
				wProject.vlbl12 label:$(ComMgr bladeElev);\
                                hp.First map:no;\
                                hp.Second map:yes

macro	SetEndPointRamp		wProject.vlbl13 label:$(ComMgr bladePosX);\
				wProject.vlbl14 label:$(ComMgr bladePosY);\
				wProject.vlbl15 label:$(ComMgr bladeElev);\
                                hp.Second map:no;\
                                WinMgr window:wProject;\
                                cfgParam 200;\
                                RampTwoPoints;\
                                cfgParam 27

macro	RampTwoPoints		counter 0;\
				holder 0;\
				foreach '0 1 2 3 4 5 6';do wProject.vlbl\$1 map:n;\
				foreach '0 1 2 3 4 5 6';do wProject.tlbl\$1 map:n;\
				startFrom 201;\
				SetTotalFields;\
				ToggleRampKeypad;\
				wProject.Kp label:"$(cfgLbl.$(startFrom))";\
				wProject.12 action:NextRampLabel

macro	ToggleRampKeypad	foreach '0 1 2 3 4 5 6 7 8 9 10 11 12 13';do wProject.\$1 map:y;\
				wProject.Kp map:y;\
				wProject.14 map:n;\
				foreach '0';do wProject.vlbl\$1 map:n;\
				foreach '0';do wProject.tlbl\$1 map:n;\
				wProject.outline1 map:n

macro	NextRampLabel		wProject.outline1 map:y;\
				wProject.vlbl0 label:$(wProject.Kp label) map:y;\
				wProject.tlbl0 label:$(cfgLbl.200) map:y;\
				wProject.14 map:y;\
				foreach '0 1 2 3 4 5 6 7 8 9 10 11 12 13';do wProject.\$1 map:n;\
				wProject.Kp map:n

/* For use with the 2-pt ramp - called as the last piece
 * of information necessary for ramp creation
 */
macro	SetRampWidth	wProject.Kp label:"$(cfgLbl.51)";\
			wProject.12 action:'wProject.vlbl6 label \$(wProject.Kp label);ToggleProjectValues'


#if #class(dozer) || #class(grader)
macro	SetHeading	wProject.vlbl3 label:$(* $(ComMgr bladeHeading) $(/ 180 3.141593));
#elif #class(shovel) || #class(loader)
macro	SetHeading      wProject.vlbl3 label:$(* $(ComMgr bucketHeading) $(/ 180 3.141593));
#endif

#if #class(drill)
macro	SetHeading	wProject.vlbl2 label:$(ComMgr trueHeading);
#endif

/* Make sure that the XY points for the start and end of the ramp
 * are different from each other
 */
macro	CheckPoints	holder 0;\
			nextAction SetRampWidth;\
			CheckPointsX

/* Compare start and end X values and set holder variable to zero if equal */
macro	CheckPointsX	ne? $(wProject.vlbl0 label) $(wProject.vlbl3 label) holder 1;\
			eq? $(holder) 0 CheckPointsY

/* If X points were the same check Y points and set holder to zero if equal */
macro	CheckPointsY	ne? $(wProject.vlbl1 label) $(wProject.vlbl4 label) holder 1;\
 			eq? $(holder) 0 wProject.Kp label:"$(cfgLbl.40)";\
			eq? $(holder) 0 ClearInputFields;\
			ne? $(holder) 0 wProject.12 action:'ToggleProjectValues';\
			ne? $(holder) 0 SetRampWidth

/* The data entered was incorrect - clear all entries */
macro	ClearInputFields	foreach '0 1 2 3 4 5 6';do wProject.vlbl\$1 label:""

/* Make sure that all data has been entered before attempting to
 * create the surface 
 */
macro	CheckInputFields	holder 1;\
				foreach $(cfgLbl.$(cfgParam));do eq? "\$(wProject.vlbl\$1 label)" "" holder 0;\
				foreach $(cfgLbl.$(cfgParam));do eq? "\$(wProject.vlbl\$1 label)" "\$(cfgLbl.\$(+ \$(startFrom) \$1))" holder 0


/* Count the number of input fields that need to have data input
 * for the current type of ramp/surface construction
 */

macro	SetTotalFields	total 0;\
			foreach $(cfgLbl.$(cfgParam));do total \$(+ \$(total) 1)

macro	ClearGpsScreen	hp.First map:no;\
			hp.Second map:no

macro	Pattern0	counter 0;\
			holder 0;\
			startFrom 201;\
			SetTotalFields;\
			ToggleProjectKeypad;\
			wProject.Kp label:"$(cfgLbl.$(+ $(counter) $(startFrom)))";\
			wProject.12 action:NextProjectLabel

macro	Pattern2	counter 0;\
			holder 0;\
			startFrom 201;\
			SetTotalFields;\
			ToggleProjectKeypad;\
			wProject.Kp label:"$(cfgLbl.$(+ $(counter) $(startFrom)))";\
			wProject.12 action:NextProjectLabel;\
                        cfgParam 213

/* Create a pattern from two points marking the centreline start and end points
 * The equipment must position itself on both points and the operator press
 * the Ok button to save the coordinates
 */

macro	Pattern13	WinMgr window:hp;\
                        hp.First map:yes;\

/* Create a pattern from two points marking the centreline start and end points
 * The equipment must position itself on both points and the operator press
 * the Ok button to save the coordinates
 */

macro	Surface13	WinMgr window:hp;\
                        hp.First map:yes;\

/* Create a ramp from two points as per Surface1 but have operator key in 
/* Collect data for a ramp consisting of a start point on the 
 * centreline, heading, length, width and gradient 
 */
macro	Surface0	counter 4;\
			holder 0;\
			startFrom 27;\
			SetTotalFields;\
			ToggleProjectKeypad;\
			SetStartPoint;\
			SetHeading;\
			wProject.Kp label:"$(cfgLbl.$(+ $(counter) $(startFrom)))";\
			wProject.12 action:NextProjectLabel

/* Create a ramp from two points marking the centreline start and end points
 * The equipment must position itself on both points and the operator press
 * the Ok button to save the coordinates
 */
macro	Surface1	counter 6;\
			holder 1;\
			startFrom 45;\
			SetTotalFields;\
			ToggleProjectKeypad;\
			wProject.Kp label:"$(cfgLbl.37)";\
			wProject.12 action:'SetStartPoint'

/* Create a ramp from two points as per Surface1 but have operator key in 
 * the points from the keypad rather than positioning the machine at each
 * end of the ramp
 */
macro	Surface2	counter 0;\
			holder 1;\
			startFrom 45;\
			SetTotalFields;\
			ToggleProjectKeypad;\
			wProject.Kp label:"$(cfgLbl.45)";\
			wProject.12 action:'NextProjectLabel'

/* Create a flat surface based on the elevation of the
 * current location the equipment's assigned to
 */
macro	FlatSurfaceFromLoc	NEW-PROJECT 2

/* Create a flat surface based on a target elevation input by
 * the operator
 */
macro	FlatSurfaceKeyed	total 0;\
				counter 0;\
				startFrom 43;\
				ToggleProjectKeypad;\
				wProject.12 action:'wProject.vlbl0 label:\$(wProject.Kp label);ToggleProjectValues';\
				wProject.Kp label:"$(cfgLbl.43)"

/* Start point, heading, length and gradient ramp */
macro	CreateRamp0	CheckInputFields;\
			eq? $(holder) 1 ComMgr createProject:w:$(wProject.vlbl5 label):l:$(wProject.vlbl4 label):a:$(wProject.vlbl6 label);\
			eq? $(holder) 1 ComMgr projectWasConfirmed;\
			eq? $(holder) 1 NEW-PROJECT 0 $(wProject.vlbl0 label) $(wProject.vlbl1 label) $(wProject.vlbl2 label) $(wProject.vlbl3 label) $(wProject.vlbl4 label) $(wProject.vlbl5 label) $(wProject.vlbl6 label);\
			eq? $(holder) 0 IncompleteMessage

			
/* Start point - end point ramp */
macro	CreateRamp1	CheckInputFields;\
			eq? $(holder) 1 ComMgr createProject2:x:$(wProject.vlbl0 label):y:$(wProject.vlbl1 label):z:$(wProject.vlbl2 label):s:$(wProject.vlbl3 label):t:$(wProject.vlbl4 label):u:$(wProject.vlbl5 label):w:$(wProject.vlbl6 label):l:0;\
			eq? $(holder) 1 ComMgr projectWasConfirmed;\
			eq? $(holder) 1 NEW-PROJECT 1 $(wProject.vlbl0 label) $(wProject.vlbl1 label) $(wProject.vlbl2 label) $(wProject.vlbl3 label) $(wProject.vlbl4 label) $(wProject.vlbl5 label) $(wProject.vlbl6 label);\
			eq? $(holder) 0 IncompleteMessage

macro CreateRamp2	holder 1;\
			eq? $(wProject.vlbl0 label) "" holder 0;\
			eq? $(holder) 1 ComMgr createProject2:x:$(wProject.vlbl10 label):y:$(wProject.vlbl11 label):z:$(wProject.vlbl12 label):s:$(wProject.vlbl13 label):t:$(wProject.vlbl14 label):u:$(wProject.vlbl15 label):w:$(wProject.Kp label):l:0;\
			eq? $(holder) 1 NEW-PROJECT 1 $(wProject.vlbl10 label) $(wProject.vlbl11 label) $(wProject.vlbl12 label) $(wProject.vlbl13 label) $(wProject.vlbl14 label) $(wProject.vlbl15 label) $(wProject.Kp label);\
			eq? $(holder) 0 IncompleteMessage

macro	CreateFlatSurface	CheckInputFields;\
 				counter 0;\
				eq? $(holder) 1 ComMgr setDesiredElevTo:$(wProject.vlbl0 label);\
				eq? $(holder) 1 NEW-PROJECT 3 $(wProject.vlbl0 label)
				eq? $(holder) 0 IncompleteMessage

macro	CreatePattern0	CheckInputFields;\
			ComMgr cancelPattern;\
 			counter 0;\
                        NEW-PROJECT 200 $(ComMgr actPosX) $(ComMgr actPosY) $(ComMgr trueHeading) $(wProject.vlbl0 label) $(wProject.vlbl1 label) $(wProject.vlbl2 label) $(wProject.vlbl3 label) $(wProject.vlbl4 label) $(wProject.vlbl5 label) $(ComMgr filteredCenterElev);\
			eq? $(holder) 0 IncompleteMessage
              

macro	CreatePattern1	CheckInputFields;\
			ComMgr cancelPattern;\
 			counter 0;\
                        NEW-PROJECT 201 $(wProject.vlbl0 label) $(wProject.vlbl1 label) $(wProject.vlbl2 label) $(wProject.vlbl3 label) $(wProject.vlbl4 label) $(wProject.vlbl5 label) $(wProject.vlbl10 label) $(wProject.vlbl11 label) $(wProject.vlbl12 label) $(wProject.vlbl13 label) $(wProject.vlbl14 label) $(wProject.vlbl15 label)

/* Logic Extra Holes when the operator create a pattern on-board*/

symbol  extrahole
macro   checkYesNoExtraHole \
                        eq? $(cfgParam) 213 NEW-PROJECT 202 $(ComMgr actPosX) $(ComMgr actPosY) $(ComMgr trueHeading) $(wProject.vlbl0 label) $(wProject.vlbl1 label) $(wProject.vlbl2 label) $(wProject.vlbl3 label) $(wProject.vlbl4 label) $(wProject.vlbl5 label) $(ComMgr filteredCenterElev) $(extrahole);\
                        eq? $(cfgParam) 214 NEW-PROJECT 203 $(wProject.vlbl0 label) $(wProject.vlbl1 label) $(wProject.vlbl2 label) $(wProject.vlbl3 label) $(wProject.vlbl4 label) $(wProject.vlbl5 label) $(wProject.vlbl10 label) $(wProject.vlbl11 label) $(wProject.vlbl12 label) $(wProject.vlbl13 label) $(wProject.vlbl14 label) $(wProject.vlbl15 label) $(extrahole);\
			eq? $(holder) 0 IncompleteMessage

macro	CreatePattern2	CheckInputFields;\
			ComMgr cancelPattern;\
 			counter 0;\
                        extraHole label:$(cfgLbl.215) post

macro	CreatePattern3	CheckInputFields;\
			ComMgr cancelPattern;\
 			counter 0;\
                        extraHole label:$(cfgLbl.215) post

/* The operator has not entered info for all the necessary fields */
macro	IncompleteMessage	wProject.14 font:Tiny label:"$(cfgLbl.42)";\
				WinMgr beep:300;\
				WinMgr after:2:ResetProjectButton

/* Change the "Create Project" button's label back to normal after
 * the incomplete field message
 */
macro	ResetProjectButton	wProject.14 font:Small;\
				wProject.14 label:"$(cfgLbl.41)"

/* Create the project in the ComMgr and send to central if
 * it's a ramp to be saved. Also this macro is reused to send 
 * pattern created by operator on-board.
 */
macro	CreateProject	eq? $(cfgParam) 24 CreateRamp0;\
			eq? $(cfgParam) 25 CreateRamp1;\
			eq? $(cfgParam) 26 CreateFlatSurface;\
			eq? $(cfgParam) 27 CreateRamp2;\
                        eq? $(cfgParam) 200 CreatePattern0;\
                        eq? $(cfgParam) 212 CreatePattern1;\
                        eq? $(cfgParam) 213 CreatePattern2;\
                        eq? $(cfgParam) 214 CreatePattern3

macro	confirmSendingProject	ComMgr projectWasConfirmed

macro	ProjectLoaded
