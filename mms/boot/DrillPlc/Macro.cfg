%!/psw/cpp
/*
 * * * * * * * * * * * * * * * * * * *
 *  DISPATCH Real-Time Firmware Module
 * Copyright (c) Modular Mining Systems, 1982-1996
 *               All Rights Reserved
 *  $RCSfile: Macro.cfg,v $
 * $Revision: 1.1 $
 *   $Author: latum $
 *     $Date: 2004/08/20 16:06:16 $
 *    $State: Exp $
 *   Purpose: Macro.cfg extensions for drill monitoring
 *            system support (OPTIONS=DrillPlc).
 * * * * * * * * * * * * * * * * * * *
 */

#assert module(rpc)

/*
 * MBUS-REQ opt
 * opt = 1   send only data relevant for genric CGC update
 * opt = 2   send usual profile data for gauges
 * opt = 0   send all slots
 * opt = 100 zero shaft
 * opt = 101 add shaft 
 * opt = 102 steel length
 * opt = 103 distance per sample
 * opt = 104 shaft per distance 
 * opt = 105 drill type (rotation or hammer drill) 
 *     see also boot/PlcDrill/Macro.cfg
 */
in	MBUS-REQ	0x1c4   b?d	doAction$1
out	MBUS-DATA	0x1c0	[d]	sendto up

/*
 * We just read data from Plc interface into the slot symbols, the Plc fills
 * constantly a file which is read by the DrillPlc interface with "DrillPlc mResult"
 * it is up to the tecnician to program the Plc to fill this Plc-file 
 * right now the file has the following structure (ask Airton from MMS Brazil about it):
 * 
 *  0. number of ticks (constantly updated)
 *  1. RPM in Hz (constantly updated)
 *  2. Air Bit Pressure (constantly updated)
 *  3. Torque (constantly updated)
 *  4. Pull Down Pressure (constantly updated)
 *  5. number of ticks (every DISTPERSAMPLE updated)
 *  6. RPM in Hz (every DISTPERSAMPLE updated)
 *  7. Air Bit Pressure (every DISTPERSAMPLE updated)
 *  8. Torque (every DISTPERSAMPLE updated)
 *  9. Pull Down Pressure (every DISTPERSAMPLE updated)
 * 10. Penetration Rate (constantly updated)
 * up to 13 slots (values) are supported by the existing code
 *
 * for DISTPERSAMPLE look at Drill.h, for the Plc it must be programed,
 *
 * SOME WORDS FOR CLARIFICATION:
 * another word to the existing code, apparantly it is not using properly
 * the values 5.) till 9.) which are changed every 30 cm or whatever the DISTPERSAMPLE
 * cosntant is set to, we actually need a  counter in this file which is increased when
 * these values are changed, maybe we can use slot5 (number of ticks) for that the 
 * other values could be the same between to records, ?number of ticks, too?
 * the other option would be to implement it completely on the Hub obsoleting slot5
 * till slot9
 */

symbol slot0 0
symbol slot1 0
symbol slot2 0
symbol slot3 0
symbol slot4 0
symbol slot5 0
symbol slot6 0
symbol slot7 0
symbol slot8 0
symbol slot9 0
symbol slot10 0
symbol slot11 0
symbol slot12 0

macro readSlots  foreach $(DrillPlc mResult); do 'slot\$1 \$2'

/* 
 *	debugging macro
 */
macro printSlots foreach '0 1 2 3 4 5 6 7 8 9 10 11 12';do 'echo slot\$1 : \$(slot\$1)'

/*
 * depending on the option code of MBUS-REQ execute an action
 */

/* send everything upstream, we send the values as we get them from Plc */
macro doAction0 readSlots; MBUS-DATA [ $(slot0) $(slot1) $(slot2) $(slot3) $(slot4) $(slot5) $(slot6) $(slot7) $(slot8) $(slot9) $(slot10) $(slot11) $(slot12) ]

/* send the three key data for KDRILL upstream: number of ticks and penetration rate*/
macro doAction1 readSlots; MBUS-DATA [ $(slot0) $(slot10) ]

/* send the key data for KDATA (updating GC gauges) upstream */
macro doAction2 readSlots; MBUS-DATA [ $(slot0) $(slot1) $(slot2) $(slot3) $(slot4) $(slot10) ]



#include <DrillPlc/register_addresses.h>

/* zero the shaft, set flag to 1 */
macro doAction100 DrillPlc writeReg:ADDRZEROSHAFT:1

/* DrillPlc writes a flag into the file, that the Plc must add a rod
 * of a constant length, this length is set by doAction102
 */
macro doAction101 DrillPlc writeReg:ADDRADDSHAFT:1

/* set steel length which will be added when we execute doAction101 */
macro doAction102 DrillPlc writeReg:ADDRSTEELLEN:$2

/* set shaft per sample value (configuration value) */
macro doAction103 DrillPlc writeReg:ADDRDISTPERSAMP:$2

/* set shaft per distance value (configuration value) */
macro doAction104 DrillPlc writeReg:ADDRSHAFTPERDIST:$2

/* set the drill type (rotation or hammer drill) */
macro doAction105 DrillPlc writeReg:ADDRDRILLTYPE:$2

