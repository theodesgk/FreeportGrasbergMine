%!/psw/cpp
/*
 * * * * * * * * * * * * * * * * * * *
 *  DISPATCH Real-Time Firmware Module
 * Copyright (c) Modular Mining Systems, 1982-1998
 *               All Rights Reserved
 *  $RCSfile: Macro.cfg,v $
 * $Revision: 1.6 $
 *   $Author: dcitron $
 *     $Date: 2014/06/05 20:33:16 $
 *    $State: Exp $
 *   Purpose: Macro configuration file 
 * * * * * * * * * * * * * * * * * * *
 */
/*
 * This code is called by Vsms.cfg every second to
 * check wheather the truck is immobile
 */

stack	8192

symbol freqVal 120
symbol counter 120
symbol lastStat 0
symbol lastVal 120
symbol immobVal 0
symbol goodGpsQual 111
symbol imVal

macro   DoImmobility    imVal $(GpsTruck checkIM); eq? $(imVal) 2 immobVal 1; eq? $(imVal) 0 immobVal 0;\
                        eq? $(imVal) 1 immobVal 2; ne? $(immobVal) 2 SendIMEvent;

macro   CheckLastStat   imVal $(GpsTruck checkIM); ne? $(lastStat) $(imVal) eq? 0 $(imVal) immobVal 0;\
                        ne? $(lastStat) $(imVal) eq? 2 $(imVal) immobVal 1;\
                        eq? $(lastStat) $(imVal) immobVal 2;\
			   eq? $(imVal) 1 immobVal 2;\
                        ne? $(immobVal) 2 SendIMEvent;

macro	CheckImmobility	eq? $(counter) 0 CheckLastStat;\
                        eq? $(counter) 1 DoImmobility; eq? $(counter) 1 counter $(freqVal);\
                        ne? $(max $(counter) 1) 1 counter $(- $(counter) 1);

macro   SendIMEvent     eq? $(max $(GpsTruck status) $(goodGpsQual)) $(goodGpsQual) EQ-REQ "GpsImmob" [ "$(immobVal)" "$(GpsTruck idleRadius)" "$(GpsTruck idleX)" "$(GpsTruck idleY)" "$(GpsTruck idleDuration)" ];\
                        eq? $(immobVal) 1 lastStat 2; eq? $(immobVal) 0 lastStat 0;


macro   SendImmobInfo   IM-QUERY $(GpsTruck idleRadius) $(GpsTruck idleDuration) $(freqVal)


in	IM-CONFIG	0x0ccd	fd?d	GpsTruck idleRadius:$1;GpsTruck idleDuration:$2 save;\
                                        ne? "$3" "" freqVal $3;\
                                        counter $(freqVal); lastVal $(freqVal)

out     IM-QUERY        0x0cce  fdd     sendto up
