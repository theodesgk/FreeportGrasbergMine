symbol timeInvl    2
symbol sync        0
symbol timer       0
symbol temperature 0

in  RS-FAULTLAMP     0x79A  b     dig1 chan:4 value:$1
in  RS-CONFIG-STATUS 0x79B  b?d    setTime
out RS-STATUS        0x79C  [b]f  sendto up

macro setTime   sync $1; timeInvl $2

macro sendValue timer $(+ $(timer) 1);\
                eq? $(sync) 0 detectChange;\
                eq? $(sync) 1 sendPeriodically

symbol prevEzA       0
symbol prevEzB       0
symbol prevPwrSupply 0
symbol strobe        0
symbol sendData      0

macro sendPeriodically prevEzA $(dig1 chan:1 value);\
                       prevEzB $(dig1 chan:2 value);\
                       prevPwrSupply $(dig1 chan:3 value);\
                       strobe $(dig1 chan:4 value);\
                       temperature $(- $(* $(an1 chan:0 value) 3.75) 15);\
                       eq? $(max $(timer) $(timeInvl) ) $(timer)  RS-STATUS [$(prevEzA) $(prevEzB) $(prevPwrSupply) $(strobe)] $(temperature);\
                       eq? $(max $(timer) $(timeInvl) ) $(timer) timer 0

macro detectChange ne? $(dig1 chan:1 value) $(prevEzA) sendData 1;\
                   ne? $(dig1 chan:1 value) $(prevEzA) prevEzA $(dig1 chan:1 value);\
                   ne? $(dig1 chan:2 value) $(prevEzB) sendData 1;\
                   ne? $(dig1 chan:2 value) $(prevEzB) prevEzB $(dig1 chan:2 value);\
                   ne? $(dig1 chan:3 value) $(prevPwrSupply) sendData 1;\
                   ne? $(dig1 chan:3 value) $(prevPwrSupply) prevPwrSupply $(dig1 chan:3 value);\
                   ne? $(dig1 chan:4 value) $(strobe) sendData 1;\
                   ne? $(dig1 chan:4 value) $(strobe) strobe $(dig1 chan:4 value);\
                   temperature $(- $(* $(an1 chan:0 value) 3.75) 15);\
                   eq? $(sendData) 1   echo sending RS-STATUS[ $(prevEzA) $(prevEzB) $(prevPwrSupply) $(strobe)] $(temperature);\
                   eq? $(sendData) 1   RS-STATUS [$(prevEzA) $(prevEzB) $(prevPwrSupply) $(strobe)] $(temperature);\
                   sendData  0
